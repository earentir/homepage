<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>{{.Title}}</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style id="theme-css">
{{.ThemeCSS}}
</style>
</head>
<body>
<script>
// Theme management
(function() {
  const savedTemplate = localStorage.getItem('template') || '{{.CurrentTemplate}}' || 'nordic';
  const savedScheme = localStorage.getItem('scheme') || '{{.CurrentScheme}}' || 'default';

  document.documentElement.setAttribute('data-template', savedTemplate);
  document.documentElement.setAttribute('data-scheme', savedScheme);

  // Hidden scheme menu for preferences modal to read from
  window.addEventListener('DOMContentLoaded', function() {
    const hiddenMenus = document.createElement('div');
    hiddenMenus.style.display = 'none';
    hiddenMenus.innerHTML = '<div id="schemeMenu">{{.SchemeMenuHTML}}</div>';
    document.body.appendChild(hiddenMenus);
  });
})();
</script>
  <div class="header">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="h-title">{{.Title}}</div>
        <div class="h-sub" id="subtitle">Loading…</div>
      </div>
    </div>

    <div class="search">
      <div class="searchbox">
        <input id="q" placeholder="Search…" autocomplete="off" />
        <div class="drop">
          <div class="pill" id="engineBtn">Google ▾</div>
          <div class="menu" id="engineMenu"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="main" id="mainContainer">
    <div id="moduleGrid">
      <div class="card span-4" data-module="status" draggable="true">
        <h3><i class="fas fa-server"></i> <span id="statusTitle">Status</span><div class="header-icons"><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="badge"><span class="pulse"></span><span id="statusText">Online</span></div>
        <div id="serverInfo">
          <div class="kv"><div class="k">Host</div><div class="v mono" id="host">—</div></div>
          <div class="kv"><div class="k">Uptime</div><div class="v mono" id="uptime">—</div></div>
          <div class="kv"><div class="k">Server time</div><div class="v mono" id="time">—</div></div>
        </div>
        <div id="clientInfo" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
          <div class="kv"><div class="k">Client IP</div><div class="v mono" id="clientIP">—</div></div>
          <div class="kv"><div class="k">Client Hostname</div><div class="v mono" id="clientHostname">—</div></div>
        </div>
      </div>

      <div class="card span-4" data-module="network" draggable="true">
        <h3><i class="fas fa-network-wired"></i> Network<div class="header-icons"><div class="timer-circle" id="ipTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="kv"><div class="k"><span id="lanIpLabel">LAN IPs</span></div><div class="v mono"><span id="lanIps">—</span><div class="small ptr" id="lanPtr"></div></div></div>
        <div class="kv"><div class="k">Public IP</div><div class="v mono"><span id="pubIp">—</span><div class="small ptr" id="pubPtr"></div></div></div>
        <div class="small" id="pubIpErr"></div>
        <div class="small" id="networkNote" style="margin-top:8px; color:var(--muted);"></div>
      </div>

      <div class="card span-4" data-module="weather" draggable="true">
        <h3><i class="fas fa-cloud-sun"></i> Weather <span class="dim" id="weatherLocation"></span><div class="header-icons"><div class="timer-circle" id="weatherTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="weather-row" id="weatherNow">
          <span class="weather-label">Now</span>
          <span class="weather-icon" id="weatherNowIcon">—</span>
          <span class="weather-data" id="weatherNowData">—</span>
        </div>
        <div class="weather-row" id="weatherToday">
          <span class="weather-label">Today</span>
          <span class="weather-icon" id="weatherTodayIcon">—</span>
          <span class="weather-data" id="weatherTodayData">—</span>
        </div>
        <div class="weather-row" id="weatherTomorrow">
          <span class="weather-label">Tomorrow</span>
          <span class="weather-icon" id="weatherTomorrowIcon">—</span>
          <span class="weather-data" id="weatherTomorrowData">—</span>
        </div>
        <div class="small" id="weatherErr"></div>
      </div>

      <div class="card span-4" data-module="cpu" draggable="true">
        <h3><i class="fas fa-microchip"></i> CPU<div class="header-icons"><div class="timer-circle" id="cpuTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="kv"><div class="k">Usage</div><div class="v" id="cpuUsage">—</div></div>
        <div class="small" id="cpuErr"></div>
        <div class="cpu-graph" id="cpuGraph"></div>
      </div>

      <div class="card span-4" data-module="ram" draggable="true">
        <h3><i class="fas fa-memory"></i> RAM<div class="header-icons"><div class="timer-circle" id="ramTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="kv"><div class="k">Total / Used / Free (GB)</div><div class="v mono" id="ramSummary">—</div></div>
        <div class="kv"><div class="k">Usage</div><div class="v" id="ramPercent">—</div></div>
        <div class="small" id="ramErr"></div>
        <div class="usage-graph" id="ramGraph"></div>
      </div>

      <div class="card span-4" data-module="disk" draggable="true">
        <h3><i class="fas fa-hdd"></i> Disk<div class="header-icons"><div class="timer-circle" id="diskTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="kv"><div class="k">Total / Used / Free (GB)</div><div class="v mono" id="diskSummary">—</div></div>
        <div class="kv"><div class="k">Usage</div><div class="v" id="diskPercent">—</div></div>
        <div class="small" id="diskErr"></div>
        <div class="usage-graph" id="diskGraph"></div>
      </div>

      <div class="card span-4" data-module="cpuid" draggable="true">
        <h3><i class="fas fa-microchip"></i> CPU Info<div class="header-icons"><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="v mono" id="cpuidName" style="margin-bottom: 8px;">—</div>
        <div class="kv"><div class="k">Cores</div><div class="v mono" id="cpuidCores">—</div></div>
        <div class="kv"><div class="k">Speed</div><div class="v mono" id="cpuidSpeed">—</div></div>
        <div id="cpuidCache"></div>
        <div class="small" id="cpuidErr"></div>
      </div>

      <div class="card span-6" data-module="links" draggable="true">
        <h3><i class="fas fa-link"></i> Quick Links<div class="header-icons"><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div id="quicklinksContainer">
          <div class="small" style="color:var(--muted);">Add links in Preferences → Quicklinks</div>
        </div>
      </div>

      <div class="card span-6" data-module="monitoring" draggable="true">
        <h3><i class="fas fa-heartbeat"></i> Monitoring<div class="header-icons"><div class="timer-circle" id="monitoringTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div id="monitoringContainer">
          <div class="small" style="color:var(--muted);">Add services in Preferences → Monitoring</div>
        </div>
      </div>

      <div class="card span-6" data-module="snmp" draggable="true">
        <h3><i class="fas fa-network-wired"></i> SNMP<div class="header-icons"><div class="timer-circle" id="snmpTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div id="snmpContainer">
          <div class="small" style="color:var(--muted);">Add queries in Preferences → SNMP</div>
        </div>
      </div>

    </div>
    <!-- GitHub modules are dynamically rendered as siblings of grid cards -->
    <div id="githubModulesContainer" class="grid" style="margin-top: 12px;"></div>
    <div id="rssModulesContainer" class="grid" style="margin-top: 12px;"></div>
  </div>

  <div class="footer">
    <div class="left">
      <div class="small">Shortcuts:</div>
      <div class="badge"><span class="mono">/</span><span class="small">focus search</span></div>
      <div class="badge"><span class="mono">Enter</span><span class="small">search</span></div>
      <div class="badge"><span class="mono">E</span><span class="small">engine</span></div>
    </div>
    <div class="right">
      <a class="btn" href="/api/summary" target="_blank" rel="noreferrer"><i class="fas fa-code"></i> API</a>
      <a class="btn" href="/healthz" target="_blank" rel="noreferrer"><i class="fas fa-heartbeat"></i> Health</a>
      <div class="btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</div>
      <div class="btn" id="prefsBtn"><i class="fas fa-cog"></i> Preferences</div>
    </div>
  </div>

  <!-- Preferences Modal -->
  <div class="modal-overlay" id="prefsModal">
    <div class="modal">
      <div class="modal-header">
        <h2><i class="fas fa-cog"></i> Preferences</h2>
        <button class="modal-close" id="prefsClose"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="general"><i class="fas fa-sliders-h"></i> General</button>
        <button class="modal-tab" data-tab="layout"><i class="fas fa-columns"></i> Layout</button>
        <button class="modal-tab" data-tab="modules"><i class="fas fa-th-large"></i> Modules</button>
        <button class="modal-tab" data-tab="quicklinks"><i class="fas fa-link"></i> Quicklinks</button>
        <button class="modal-tab" data-tab="monitoring"><i class="fas fa-heartbeat"></i> Monitoring</button>
        <button class="modal-tab" data-tab="snmp"><i class="fas fa-network-wired"></i> SNMP</button>
        <button class="modal-tab" data-tab="search"><i class="fas fa-search"></i> Search</button>
        <button class="modal-tab" data-tab="about"><i class="fas fa-info-circle"></i> About</button>
      </div>
      <div class="modal-content">
        <div class="tab-content active" id="tab-general">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; align-items:start;">
            <div style="display:flex; flex-direction:column; gap:20px;">
              <div class="pref-section">
                <h3>Appearance</h3>
                <div class="pref-row">
                  <label>Theme</label>
                  <select id="pref-template">
                    {{range .TemplatesList}}<option value="{{.}}">{{.}}</option>{{end}}
                  </select>
                </div>
                <div class="pref-row">
                  <label>Color Scheme</label>
                  <select id="pref-scheme"></select>
                </div>
              </div>
              <div class="pref-section">
                <h3>Weather</h3>
                <div class="pref-row">
                  <label>Location</label>
                  <div class="location-input">
                    <input type="text" id="pref-weather-location" placeholder="e.g., Athens, Greece">
                    <button class="btn-small" id="searchLocationBtn"><i class="fas fa-search"></i></button>
                  </div>
                </div>
                <div class="pref-row" id="locationResultsRow" style="display:none;">
                  <label>Select</label>
                  <div class="location-input">
                    <select id="pref-location-results"></select>
                    <button class="btn-small" id="setLocationBtn"><i class="fas fa-check"></i> Set</button>
                  </div>
                </div>
                <div class="pref-row" id="currentLocationRow">
                  <label>Current</label>
                  <span class="location-display" id="currentLocationDisplay">Not set</span>
                </div>
              </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:20px;">
              <div class="pref-section">
                <h3>Graphs</h3>
                <div class="pref-row">
                  <label>Show full bar height</label>
                  <input type="checkbox" id="pref-full-bars" title="Show the unused portion of bars in a dimmed color">
                </div>
                <div class="pref-row">
                  <label>Minimum bar width</label>
                  <div class="location-input">
                    <input type="number" id="pref-min-bar-width" value="10" min="2" max="50" style="width:80px;">
                    <span class="small">pixels</span>
                  </div>
                </div>
              </div>
              <div class="pref-section">
                <h3>GitHub</h3>
                <div class="pref-row">
                  <label>API Token</label>
                  <div class="location-input">
                    <input type="password" id="pref-github-token" placeholder="ghp_xxxxxxxxxxxx" style="flex:1;">
                    <button class="btn-small" id="toggleGithubToken" title="Show/hide token"><i class="fas fa-eye"></i></button>
                  </div>
                </div>
                <div class="pref-row">
                  <label></label>
                  <span class="small" style="color:var(--muted);">Optional. Increases rate limit from 60 to 5000 requests/hour.<br>Create at: GitHub → Settings → Developer settings → Personal access tokens</span>
                </div>
              </div>
              <div class="pref-section">
                <h3>Data</h3>
                <div class="pref-row">
                  <label>Clear cached data</label>
                  <button class="btn-small" id="clearCacheBtn"><i class="fas fa-trash"></i> Clear Cache</button>
                </div>
                <div class="pref-row">
                  <label>Reset module order</label>
                  <button class="btn-small" id="resetOrderBtn"><i class="fas fa-undo"></i> Reset Order</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-search">
          <div class="pref-section">
            <h3>Search History</h3>
            <div class="pref-row">
              <label>Search in history</label>
              <input type="text" id="searchHistoryFilter" placeholder="Filter searches..." style="flex:1;">
            </div>
            <div class="pref-row">
              <label></label>
              <button class="btn-small" id="clearSearchHistoryBtn"><i class="fas fa-trash"></i> Clear All</button>
            </div>
            <div class="module-list" id="searchHistoryList" style="max-height:500px; overflow-y:auto; margin-top:12px;"></div>
          </div>
        </div>
        <div class="tab-content" id="tab-layout">
          <div class="pref-section">
            <h3>Container Width</h3>
            <div class="pref-row">
              <label>Max Width</label>
              <select id="layoutMaxWidth">
                <option value="60">60%</option>
                <option value="70">70%</option>
                <option value="80">80%</option>
                <option value="90">90%</option>
              </select>
            </div>
          </div>
          <div class="pref-section">
            <h3>Row Layout Editor</h3>
            <div id="layoutEditor"></div>
            <div style="margin-top: 12px;">
              <button class="btn-small" id="addRowBtn"><i class="fas fa-plus"></i> Add Row</button>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-modules">
          <div class="pref-section">
            <h3>Module Settings</h3>
            <div class="module-list" id="moduleList"></div>
          </div>
          <div class="pref-section">
            <h3>GitHub Modules <button class="btn-small" id="addGitHubBtn"><i class="fas fa-plus"></i> Add</button></h3>
            <div class="module-list" id="githubModuleList"></div>
          </div>
          <div class="pref-section">
            <h3>RSS Modules <button class="btn-small" id="addRssBtn"><i class="fas fa-plus"></i> Add</button></h3>
            <div class="module-list" id="rssModuleList"></div>
          </div>
        </div>
        <div class="tab-content" id="tab-quicklinks">
          <div class="pref-section">
            <h3>Layout</h3>
            <div class="layout-buttons">
              <button class="layout-btn" data-cols="1" title="1 link per row"><i class="fas fa-bars"></i></button>
              <button class="layout-btn" data-cols="2" title="2 links per row"><i class="fas fa-th-large"></i></button>
              <button class="layout-btn" data-cols="3" title="3 links per row"><i class="fas fa-th"></i></button>
            </div>
          </div>
          <div class="pref-section">
            <h3>Quick Links <button class="btn-small" id="addQuicklinkBtn"><i class="fas fa-plus"></i> Add</button></h3>
            <div class="module-list" id="quicklinksList"></div>
          </div>
          <div class="pref-section">
            <h3>Add / Edit Link</h3>
            <div id="quicklinkForm" style="display:none;">
              <div class="pref-row">
                <label>Title</label>
                <input type="text" id="ql-title" placeholder="e.g., Router">
              </div>
              <div class="pref-row">
                <label>URL</label>
                <input type="text" id="ql-url" placeholder="e.g., http://192.168.1.1">
              </div>
              <div class="pref-row">
                <label>Icon</label>
                <div class="icon-selector">
                  <select id="ql-icon">
                    <option value="">Use favicon</option>
                    <option value="fa-network-wired">Network</option>
                    <option value="fa-server">Server</option>
                    <option value="fa-hdd">Storage</option>
                    <option value="fa-database">Database</option>
                    <option value="fa-cloud">Cloud</option>
                    <option value="fa-home">Home</option>
                    <option value="fa-cog">Settings</option>
                    <option value="fa-chart-line">Charts</option>
                    <option value="fa-shield-alt">Security</option>
                    <option value="fa-video">Video</option>
                    <option value="fa-music">Music</option>
                    <option value="fa-book">Docs</option>
                    <option value="fa-code">Code</option>
                    <option value="fa-terminal">Terminal</option>
                    <option value="fa-download">Downloads</option>
                    <option value="fa-envelope">Mail</option>
                    <option value="fa-calendar">Calendar</option>
                    <option value="fa-globe">Web</option>
                    <option value="fa-wifi">WiFi</option>
                    <option value="fa-lock">Lock</option>
                  </select>
                  <button class="btn-small" id="ql-clear-icon" title="Clear icon selection"><i class="fas fa-times"></i></button>
                </div>
              </div>
              <div class="pref-row" style="justify-content:flex-end; gap:10px;">
                <button class="btn-small" id="ql-cancel">Cancel</button>
                <button class="btn-small" id="ql-save" style="background:var(--accent); color:var(--bg);"><i class="fas fa-check"></i> Save</button>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-monitoring">
          <div class="pref-section">
            <h3>Refresh Interval</h3>
            <div class="pref-row">
              <label>Check every</label>
              <div class="location-input">
                <input type="number" id="monitor-interval" value="60" min="5" max="3600" style="width:80px;">
                <span class="small">seconds</span>
              </div>
            </div>
          </div>
          <div class="pref-section">
            <h3>Services <button class="btn-small" id="addMonitorBtn"><i class="fas fa-plus"></i> Add</button></h3>
            <div class="module-list" id="monitorsList"></div>
          </div>
          <div class="pref-section">
            <h3>Add / Edit Service</h3>
            <div id="monitorForm" style="display:none;">
              <div class="pref-row">
                <label>Name</label>
                <input type="text" id="mon-name" placeholder="e.g., Web Server">
              </div>
              <div class="pref-row">
                <label>Type</label>
                <select id="mon-type">
                  <option value="http">HTTP Check</option>
                  <option value="port">Port Check</option>
                  <option value="ping">Ping</option>
                </select>
              </div>
              <div class="pref-row" id="mon-url-row">
                <label>URL</label>
                <input type="text" id="mon-url" placeholder="e.g., https://example.com">
              </div>
              <div class="pref-row" id="mon-host-row" style="display:none;">
                <label>Host</label>
                <input type="text" id="mon-host" placeholder="e.g., 192.168.1.1">
              </div>
              <div class="pref-row" id="mon-port-row" style="display:none;">
                <label>Port</label>
                <input type="number" id="mon-port" placeholder="e.g., 443" min="1" max="65535">
              </div>
              <div class="pref-row" style="justify-content:flex-end; gap:10px;">
                <button class="btn-small" id="mon-cancel">Cancel</button>
                <button class="btn-small" id="mon-save" style="background:var(--accent); color:var(--bg);"><i class="fas fa-check"></i> Save</button>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-snmp">
          <div class="pref-section">
            <h3>SNMP Queries <button class="btn-small" id="addSnmpBtn"><i class="fas fa-plus"></i> Add</button></h3>
            <div class="module-list" id="snmpList"></div>
          </div>
          <div class="pref-section">
            <h3>Add / Edit SNMP Query</h3>
            <div id="snmpForm" style="display:none;">
              <div class="pref-row">
                <label>Title</label>
                <input type="text" id="snmp-title" placeholder="e.g., Router Uptime">
              </div>
              <div class="pref-row">
                <label>Host</label>
                <input type="text" id="snmp-host" placeholder="192.168.1.1">
              </div>
              <div class="pref-row">
                <label>Port</label>
                <input type="number" id="snmp-port" placeholder="161" value="161" min="1" max="65535">
              </div>
              <div class="pref-row">
                <label>Community</label>
                <input type="text" id="snmp-community" placeholder="public">
              </div>
              <div class="pref-row">
                <label>OID</label>
                <input type="text" id="snmp-oid" placeholder="1.3.6.1.2.1.1.3.0">
              </div>
              <div class="pref-row">
                <label>Display Type</label>
                <select id="snmp-display-type">
                  <option value="show">Show</option>
                  <option value="diff">Diff</option>
                  <option value="period-diff">Period Diff</option>
                </select>
              </div>
              <div class="pref-row">
                <label>Prefix</label>
                <input type="text" id="snmp-prefix" placeholder="e.g., Speed: ">
              </div>
              <div class="pref-row">
                <label>Suffix</label>
                <input type="text" id="snmp-suffix" placeholder="e.g., bps">
              </div>
              <div class="pref-row">
                <label>Divisor</label>
                <div style="display:flex; align-items:center; gap:8px;">
                  <select id="snmp-divisor">
                    <option value="1">1</option>
                    <option value="10">10</option>
                    <option value="100">100</option>
                    <option value="1000">1,000</option>
                    <option value="10000">10,000</option>
                    <option value="100000">100,000</option>
                    <option value="1000000">1,000,000</option>
                    <option value="1000000000">1,000,000,000</option>
                  </select>
                  <label style="display:flex; align-items:center; gap:4px; font-size:12px; cursor:pointer;">
                    <input type="checkbox" id="snmp-si-units" style="margin:0;">
                    <span>SI units</span>
                  </label>
                </div>
              </div>
              <div class="pref-row">
                <label></label>
                <div style="display:flex; gap:8px;">
                  <button class="btn-small" id="snmp-cancel">Cancel</button>
                  <button class="btn-small" id="snmp-save" style="background:var(--accent); color:var(--bg);"><i class="fas fa-check"></i> Save</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-about">
          <div class="pref-section about-section">
            <div class="about-logo"><i class="fas fa-home fa-3x"></i></div>
            <h3>LAN Index Dashboard</h3>
            <p class="about-version">Version {{.AppVersion}}</p>
            <p class="about-desc">A personal dashboard for monitoring your system, weather, GitHub activity, and more.</p>
            <div class="about-links">
              <a href="https://github.com/Earentir/homepage" target="_blank" rel="noreferrer"><i class="fab fa-github"></i> Source Code</a>
            </div>
            <p class="about-copyright">© {{.Year}} Earentir</p>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const engines = [
  {name:"Google", url:"https://www.google.com/search?q=%s"},
  {name:"Perplexity", url:"https://www.perplexity.ai/search?q=%s"},
  {name:"DuckDuckGo", url:"https://duckduckgo.com/?q=%s"},
  {name:"Brave", url:"https://search.brave.com/search?q=%s"},
  {name:"Bing", url:"https://www.bing.com/search?q=%s"},
  {name:"Wikipedia", url:"https://en.wikipedia.org/wiki/Special:Search?search=%s"},
  {name:"GitHub", url:"https://github.com/search?q=%s"},
  {name:"Stack Overflow", url:"https://stackoverflow.com/search?q=%s"},
  {name:"YouTube", url:"https://www.youtube.com/results?search_query=%s"},
  {name:"Reddit", url:"https://www.reddit.com/search/?q=%s"},
];

let engine = engines[0];

const q = document.getElementById('q');
const engineBtn = document.getElementById('engineBtn');
const engineMenu = document.getElementById('engineMenu');

function renderEngines(){
  engineMenu.innerHTML = "";
  engines.forEach((e) => {
    const b = document.createElement('button');
    b.textContent = e.name;
    b.onclick = () => {
      engine = e;
      engineBtn.textContent = e.name + " ▾";
      engineMenu.style.display = "none";
      q.focus();
    };
    engineMenu.appendChild(b);
  });
}
renderEngines();

engineBtn.onclick = () => {
  engineMenu.style.display = (engineMenu.style.display === "block") ? "none" : "block";
};

document.addEventListener('click', (ev) => {
  if (!engineBtn.contains(ev.target) && !engineMenu.contains(ev.target)) {
    engineMenu.style.display = "none";
  }
});

// Search history management
let searchHistory = [];

function loadSearchHistory() {
  try {
    const stored = localStorage.getItem('searchHistory');
    if (stored) {
      searchHistory = JSON.parse(stored);
    }
  } catch (e) {
    console.error('Error loading search history:', e);
    searchHistory = [];
  }
}

function saveSearchHistory() {
  try {
    // Keep only last 100 searches
    if (searchHistory.length > 100) {
      searchHistory = searchHistory.slice(-100);
    }
    localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
  } catch (e) {
    console.error('Error saving search history:', e);
  }
}

function addToSearchHistory(term, engineName) {
  if (!term) return;
  // Remove if already exists (to move to end)
  searchHistory = searchHistory.filter(item => !(item.term === term && item.engine === engineName));
  // Add to end
  searchHistory.push({
    term: term,
    engine: engineName,
    timestamp: Date.now()
  });
  saveSearchHistory();
  // Update history UI if preferences modal is open
  if (window.renderSearchHistory) {
    window.renderSearchHistory();
  }
}

function removeFromSearchHistory(index) {
  searchHistory.splice(index, 1);
  saveSearchHistory();
  if (window.renderSearchHistory) {
    window.renderSearchHistory();
  }
}

function clearSearchHistory() {
  if (confirm('Are you sure you want to clear all search history?')) {
    searchHistory = [];
    saveSearchHistory();
    if (window.renderSearchHistory) {
      window.renderSearchHistory();
    }
  }
}

function goSearch(){
  const term = (q.value || "").trim();
  if(!term) return;
  addToSearchHistory(term, engine.name);
  const u = engine.url.replace("%s", encodeURIComponent(term));
  window.open(u, "_blank", "noreferrer");
  q.value = ""; // Clear input after search
}

q.addEventListener('keydown', (e) => {
  if(e.key === "Enter") {
    e.preventDefault();
    goSearch();
  }
});

// Load history on page load
loadSearchHistory();

// Check if any modal is open
function isModalOpen() {
  const modals = document.querySelectorAll('.modal-overlay');
  for (const modal of modals) {
    if (modal.classList.contains('active') ||
        (modal.style.display && modal.style.display !== 'none')) {
      return true;
    }
  }
  return false;
}

document.addEventListener('keydown', (e) => {
  // Don't capture keys when modal is open
  if (isModalOpen()) return;

  // Don't capture when typing in an input/textarea
  const tag = document.activeElement.tagName.toLowerCase();
  if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

  if (e.key === "/") { e.preventDefault(); q.focus(); }
  if (e.key.toLowerCase() === "e") {
    engineMenu.style.display = "block";
  }
});

function fmtUptime(sec){
  sec = Math.max(0, sec|0);
  const d = Math.floor(sec/86400); sec%=86400;
  const h = Math.floor(sec/3600); sec%=3600;
  const m = Math.floor(sec/60); sec%=60;
  const parts = [];
  if(d) parts.push(d+"d");
  if(h) parts.push(h+"h");
  if(m) parts.push(m+"m");
  parts.push(sec+"s");
  return parts.join(" ");
}

// Timer management
const timers = {
  cpu: {interval: 5000, lastUpdate: 0, timer: null}, // 5 seconds
  ram: {interval: 5000, lastUpdate: 0, timer: null}, // 5 seconds
  disk: {interval: 15000, lastUpdate: 0, timer: null}, // 15 seconds
  github: {interval: 900000, lastUpdate: 0, timer: null}, // 15 minutes
  weather: {interval: 1800000, lastUpdate: 0, timer: null}, // 30 minutes
  ip: {interval: 7200000, lastUpdate: 0, timer: null}, // 2 hours
  monitoring: {interval: 60000, lastUpdate: 0, timer: null}, // 60 seconds
  snmp: {interval: 60000, lastUpdate: 0, timer: null}, // 60 seconds
  rss: {interval: 300000, lastUpdate: 0, timer: null}, // 5 minutes
  general: {interval: 30000, lastUpdate: 0, timer: null} // 30 seconds for other data
};

function updateTimer(moduleName) {
  const timer = timers[moduleName];
  if (!timer) return;
  const elapsed = Date.now() - timer.lastUpdate;
  const remaining = Math.max(0, timer.interval - elapsed);
  const timerEl = document.getElementById(moduleName + "Timer");
  if (timerEl) {
    const seconds = Math.ceil(remaining / 1000);
    const percent = (elapsed / timer.interval) * 100;
    const percentClamped = Math.min(100, Math.max(0, percent));

    if (remaining > 0) {
      timerEl.title = "Next refresh in " + seconds + "s (double-click to refresh now)";
      timerEl.classList.remove("paused");
      // Update CSS variable for progress percentage
      timerEl.style.setProperty("--progress-percent", percentClamped + "%");
    } else {
      timerEl.title = "Ready to refresh (double-click to refresh now)";
      timerEl.classList.add("paused");
      timerEl.style.setProperty("--progress-percent", "100%");
    }
  }
}

function startTimer(moduleName) {
  const timer = timers[moduleName];
  if (!timer) return;
  timer.lastUpdate = Date.now();
  updateTimer(moduleName);
  if (timer.timer) clearInterval(timer.timer);
  timer.timer = setInterval(() => updateTimer(moduleName), 1000);
}

function formatBytes(bytes) {
  if (bytes === 0) return "0 B";
  const k = 1024;
  const sizes = ["B", "KB", "MB", "GB", "TB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return (bytes / Math.pow(k, i)).toFixed(2) + " " + sizes[i];
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// History for bar graphs
let minBarWidth = 10; // Minimum width of each bar in pixels (loaded from preferences)
const barGap = 2; // Gap between bars in pixels
const graphMaxHeight = 26; // Max height of bars in pixels

// Load minBarWidth from localStorage
try {
  const saved = localStorage.getItem('minBarWidth');
  if (saved) {
    const parsed = parseInt(saved);
    if (parsed >= 2 && parsed <= 50) {
      minBarWidth = parsed;
    }
  }
} catch (e) {}

function saveMinBarWidth() {
  try {
    localStorage.setItem('minBarWidth', minBarWidth.toString());
  } catch (e) {}
}

// Full bars preference (show unused portion in dim color)
let showFullBars = false;
try {
  showFullBars = localStorage.getItem('showFullBars') === 'true';
} catch (e) {}

function saveFullBarsPreference() {
  try {
    localStorage.setItem('showFullBars', showFullBars.toString());
  } catch (e) {}
}

function applyFullBarsClass() {
  const graphs = document.querySelectorAll('.cpu-graph, .usage-graph');
  graphs.forEach(g => {
    if (showFullBars) {
      g.classList.add('full-bars');
    } else {
      g.classList.remove('full-bars');
    }
  });
}

// Load CPU history from localStorage
let cpuHistory = [];
try {
  const saved = localStorage.getItem('cpuHistory');
  if (saved) {
    cpuHistory = JSON.parse(saved);
  }
} catch (e) {
  cpuHistory = [];
}

// Load RAM history from localStorage
let ramHistory = [];
try {
  const saved = localStorage.getItem('ramHistory');
  if (saved) {
    ramHistory = JSON.parse(saved);
  }
} catch (e) {
  ramHistory = [];
}

// Load Disk history from localStorage
let diskHistory = [];
try {
  const saved = localStorage.getItem('diskHistory');
  if (saved) {
    diskHistory = JSON.parse(saved);
  }
} catch (e) {
  diskHistory = [];
}

function saveCpuHistory() {
  try {
    localStorage.setItem('cpuHistory', JSON.stringify(cpuHistory));
  } catch (e) {
    // Ignore storage errors
  }
}

function saveRamHistory() {
  try {
    localStorage.setItem('ramHistory', JSON.stringify(ramHistory));
  } catch (e) {
    // Ignore storage errors
  }
}

function saveDiskHistory() {
  try {
    localStorage.setItem('diskHistory', JSON.stringify(diskHistory));
  } catch (e) {
    // Ignore storage errors
  }
}

// Trim history arrays to fit within minBarWidth constraint
// Returns true if graphs were ready and trimming was attempted, false if graphs weren't ready
function trimHistoryArrays() {
  // Get graph container width (use CPU graph as reference, they should all be similar)
  const graph = document.getElementById("cpuGraph");
  if (!graph) return false; // Graphs not yet available

  const containerWidth = graph.clientWidth - 6; // Subtract padding
  if (containerWidth <= 0) return false; // Graph not yet laid out

  // Calculate maximum number of bars that can fit
  // Solve: containerWidth = (maxBars * minBarWidth) + (barGap * (maxBars - 1))
  // Rearranged: maxBars = (containerWidth + barGap) / (minBarWidth + barGap)
  const maxBars = Math.floor((containerWidth + barGap) / (minBarWidth + barGap));
  if (maxBars <= 0) return true; // Can't fit any bars, but graphs are ready

  // Trim each history array to keep only the most recent values
  if (cpuHistory.length > maxBars) {
    cpuHistory = cpuHistory.slice(-maxBars);
    saveCpuHistory();
  }
  if (ramHistory.length > maxBars) {
    ramHistory = ramHistory.slice(-maxBars);
    saveRamHistory();
  }
  if (diskHistory.length > maxBars) {
    diskHistory = diskHistory.slice(-maxBars);
    saveDiskHistory();
  }
  return true; // Graphs were ready, trimming attempted
}

function renderCpuGraph() {
  const graph = document.getElementById("cpuGraph");
  if (!graph || cpuHistory.length === 0) return;

  // Create bars for existing history
  while (graph.children.length < cpuHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Update bar heights and styling
  for (let i = 0; i < cpuHistory.length; i++) {
    const pct = cpuHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

function updateCpuGraph(usage) {
  const graph = document.getElementById("cpuGraph");
  if (!graph) return;

  // Calculate how wide each bar would be if we add one more
  const containerWidth = graph.clientWidth - 6; // Subtract padding
  const newBarCount = cpuHistory.length + 1;
  const barWidthIfAdded = (containerWidth - (barGap * (newBarCount - 1))) / newBarCount;

  // If adding a new bar would make bars less than 4px, remove oldest first
  if (barWidthIfAdded < minBarWidth && cpuHistory.length > 0) {
    cpuHistory.shift();
  }

  // Add new value
  cpuHistory.push(usage);
  saveCpuHistory();

  // Create bars if needed
  while (graph.children.length < cpuHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Remove extra bars if needed (from the front - oldest)
  while (graph.children.length > cpuHistory.length) {
    graph.removeChild(graph.firstChild);
  }

  // Update bar heights and styling
  for (let i = 0; i < cpuHistory.length; i++) {
    const pct = cpuHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

function renderRamGraph() {
  const graph = document.getElementById("ramGraph");
  if (!graph || ramHistory.length === 0) return;

  // Create bars for existing history
  while (graph.children.length < ramHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Update bar heights and styling
  for (let i = 0; i < ramHistory.length; i++) {
    const pct = ramHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

function updateRamGraph(usage) {
  const graph = document.getElementById("ramGraph");
  if (!graph) return;

  // Calculate how wide each bar would be if we add one more
  const containerWidth = graph.clientWidth - 6; // Subtract padding
  const newBarCount = ramHistory.length + 1;
  const barWidthIfAdded = (containerWidth - (barGap * (newBarCount - 1))) / newBarCount;

  // If adding a new bar would make bars less than 4px, remove oldest first
  if (barWidthIfAdded < minBarWidth && ramHistory.length > 0) {
    ramHistory.shift();
  }

  // Add new value
  ramHistory.push(usage);
  saveRamHistory();

  // Create bars if needed
  while (graph.children.length < ramHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Remove extra bars if needed (from the front - oldest)
  while (graph.children.length > ramHistory.length) {
    graph.removeChild(graph.firstChild);
  }

  // Update bar heights and styling
  for (let i = 0; i < ramHistory.length; i++) {
    const pct = ramHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

function renderDiskGraph() {
  const graph = document.getElementById("diskGraph");
  if (!graph || diskHistory.length === 0) return;

  // Create bars for existing history
  while (graph.children.length < diskHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Update bar heights and styling
  for (let i = 0; i < diskHistory.length; i++) {
    const pct = diskHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

function updateDiskGraph(usage) {
  const graph = document.getElementById("diskGraph");
  if (!graph) return;

  // Calculate how wide each bar would be if we add one more
  const containerWidth = graph.clientWidth - 6; // Subtract padding
  const newBarCount = diskHistory.length + 1;
  const barWidthIfAdded = (containerWidth - (barGap * (newBarCount - 1))) / newBarCount;

  // If adding a new bar would make bars less than 4px, remove oldest first
  if (barWidthIfAdded < minBarWidth && diskHistory.length > 0) {
    diskHistory.shift();
  }

  // Add new value
  diskHistory.push(usage);
  saveDiskHistory();

  // Create bars if needed
  while (graph.children.length < diskHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Remove extra bars if needed (from the front - oldest)
  while (graph.children.length > diskHistory.length) {
    graph.removeChild(graph.firstChild);
  }

  // Update bar heights and styling
  for (let i = 0; i < diskHistory.length; i++) {
    const pct = diskHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

async function refreshCPU(){
  try{
    const res = await fetch("/api/system", {cache:"no-store"});
    const j = await res.json();
    if (j.cpu) {
      if (j.cpu.error) {
        document.getElementById("cpuUsage").textContent = "—";
        document.getElementById("cpuErr").textContent = j.cpu.error;
      } else {
        const usage = j.cpu.usage || 0;
        document.getElementById("cpuUsage").textContent = usage.toFixed(1) + "%";
        document.getElementById("cpuErr").textContent = "";
        updateCpuGraph(usage);
      }
    }
    startTimer("cpu");
  } catch(err){
    console.error("Error refreshing CPU:", err);
  }
}

async function refreshRAM(){
  try{
    const res = await fetch("/api/system", {cache:"no-store"});
    const j = await res.json();
    if (j.ram) {
      if (j.ram.error) {
        document.getElementById("ramSummary").textContent = "—";
        document.getElementById("ramPercent").textContent = "—";
        document.getElementById("ramErr").textContent = j.ram.error;
      } else {
        const toGB = (bytes) => (bytes / (1024 * 1024 * 1024)).toFixed(1);
        const total = toGB(j.ram.total || 0);
        const used = toGB(j.ram.used || 0);
        const available = toGB(j.ram.available || 0);
        document.getElementById("ramSummary").textContent = total + " / " + used + " / " + available;
        const percent = j.ram.percent || 0;
        document.getElementById("ramPercent").textContent = percent.toFixed(1) + "%";
        document.getElementById("ramErr").textContent = "";
        updateRamGraph(percent);
      }
    }
    startTimer("ram");
  } catch(err){
    console.error("Error refreshing RAM:", err);
  }
}

async function refreshDisk(){
  try{
    const res = await fetch("/api/system", {cache:"no-store"});
    const j = await res.json();
    if (j.disk) {
      if (j.disk.error) {
        document.getElementById("diskSummary").textContent = "—";
        document.getElementById("diskPercent").textContent = "—";
        document.getElementById("diskErr").textContent = j.disk.error;
      } else {
        const toGB = (bytes) => (bytes / (1024 * 1024 * 1024)).toFixed(1);
        const total = toGB(j.disk.total || 0);
        const used = toGB(j.disk.used || 0);
        const free = toGB(j.disk.free || 0);
        document.getElementById("diskSummary").textContent = total + " / " + used + " / " + free;
        const percent = j.disk.percent || 0;
        document.getElementById("diskPercent").textContent = percent.toFixed(1) + "%";
        document.getElementById("diskErr").textContent = "";
        updateDiskGraph(percent);
      }
    }
    startTimer("disk");
  } catch(err){
    console.error("Error refreshing Disk:", err);
  }
}

async function refreshCPUInfo(){
  try{
    const res = await fetch("/api/cpuid", {cache:"no-store"});
    const j = await res.json();
    if (j.error) {
      document.getElementById("cpuidName").textContent = "—";
      document.getElementById("cpuidCores").textContent = "—";
      document.getElementById("cpuidSpeed").textContent = "—";
      document.getElementById("cpuidCache").innerHTML = "—";
      document.getElementById("cpuidErr").textContent = j.error;
    } else {
      // CPU Name
      document.getElementById("cpuidName").textContent = j.name || "—";

      // Cores: Physical / Threads
      const coresText = (j.physicalCores || 0) + " / " + (j.virtualCores || 0);
      document.getElementById("cpuidCores").textContent = coresText;

      // Speed: Min / Max / Current (MHz)
      let speedText = "—";
      if (j.speedMin || j.speedMax || j.speedCurrent) {
        const parts = [];
        if (j.speedMin) parts.push(j.speedMin.toFixed(0) + " MHz");
        if (j.speedMax && j.speedMax !== j.speedMin) parts.push(j.speedMax.toFixed(0) + " MHz");
        if (j.speedCurrent && j.speedCurrent !== j.speedMin && j.speedCurrent !== j.speedMax) {
          parts.push(j.speedCurrent.toFixed(0) + " MHz");
        }
        if (parts.length > 0) {
          speedText = parts.join(" / ");
        } else if (j.speedCurrent) {
          speedText = j.speedCurrent.toFixed(0) + " MHz";
        } else if (j.speedMax) {
          speedText = j.speedMax.toFixed(0) + " MHz";
        }
      }
      document.getElementById("cpuidSpeed").textContent = speedText;

      // Cache information - L1 with Instruction/Data, L2 and L3 each on their own line
      const cacheEl = document.getElementById("cpuidCache");
      if (j.cache && j.cache.length > 0) {
        // Group caches by level
        const cacheByLevel = {};
        j.cache.forEach(cache => {
          if (!cacheByLevel[cache.level]) {
            cacheByLevel[cache.level] = [];
          }
          cacheByLevel[cache.level].push(cache);
        });

        let cacheHTML = "";

        // L1: Show Instruction and Data separately in value
        if (cacheByLevel[1] && cacheByLevel[1].length > 0) {
          const l1Caches = cacheByLevel[1];
          const l1Parts = [];
          l1Caches.forEach(cache => {
            const sizeText = cache.sizeKB >= 1024
              ? (cache.sizeKB / 1024).toFixed(1) + "MB"
              : cache.sizeKB + "KB";
            if (cache.type === "Instruction") {
              l1Parts.push(`Instruction: ${sizeText}`);
            } else if (cache.type === "Data") {
              l1Parts.push(`Data: ${sizeText}`);
            } else {
              l1Parts.push(`${cache.type}: ${sizeText}`);
            }
          });
          cacheHTML += `<div class="kv" style="border-top:1px solid var(--border); padding-top:10px;"><div class="k">L1</div><div class="v mono">${l1Parts.join(", ")}</div></div>`;
        }

        // L2: On its own line
        if (cacheByLevel[2] && cacheByLevel[2].length > 0) {
          const l2Cache = cacheByLevel[2][0];
          const sizeText = l2Cache.sizeKB >= 1024
            ? (l2Cache.sizeKB / 1024).toFixed(1) + "MB"
            : l2Cache.sizeKB + "KB";
          cacheHTML += `<div class="kv"><div class="k">L2</div><div class="v mono">${sizeText}</div></div>`;
        }

        // L3: On its own line
        if (cacheByLevel[3] && cacheByLevel[3].length > 0) {
          const l3Cache = cacheByLevel[3][0];
          const sizeText = l3Cache.sizeKB >= 1024
            ? (l3Cache.sizeKB / 1024).toFixed(1) + "MB"
            : l3Cache.sizeKB + "KB";
          cacheHTML += `<div class="kv"><div class="k">L3</div><div class="v mono">${sizeText}</div></div>`;
        }

        cacheEl.innerHTML = cacheHTML || "—";
      } else {
        cacheEl.innerHTML = "—";
      }

      document.getElementById("cpuidErr").textContent = "";
    }
  } catch(err){
    console.error("Error refreshing CPU Info:", err);
    document.getElementById("cpuidErr").textContent = "Failed to fetch CPU info";
  }
}

// Weather code to icon and description mapping (Open-Meteo WMO codes)
function getWeatherIcon(code) {
  let icon, desc;
  // WMO Weather interpretation codes
  if (code === 0) { icon = 'fa-sun'; desc = 'Clear sky'; }
  else if (code === 1) { icon = 'fa-sun'; desc = 'Mainly clear'; }
  else if (code === 2) { icon = 'fa-cloud-sun'; desc = 'Partly cloudy'; }
  else if (code === 3) { icon = 'fa-cloud'; desc = 'Overcast'; }
  else if (code === 45 || code === 48) { icon = 'fa-smog'; desc = 'Fog'; }
  else if (code >= 51 && code <= 55) { icon = 'fa-cloud-rain'; desc = 'Drizzle'; }
  else if (code >= 56 && code <= 57) { icon = 'fa-icicles'; desc = 'Freezing drizzle'; }
  else if (code >= 61 && code <= 65) { icon = 'fa-cloud-showers-heavy'; desc = 'Rain'; }
  else if (code >= 66 && code <= 67) { icon = 'fa-icicles'; desc = 'Freezing rain'; }
  else if (code >= 71 && code <= 77) { icon = 'fa-snowflake'; desc = 'Snow'; }
  else if (code >= 80 && code <= 82) { icon = 'fa-cloud-showers-heavy'; desc = 'Rain showers'; }
  else if (code >= 85 && code <= 86) { icon = 'fa-snowflake'; desc = 'Snow showers'; }
  else if (code === 95) { icon = 'fa-bolt'; desc = 'Thunderstorm'; }
  else if (code >= 96 && code <= 99) { icon = 'fa-cloud-bolt'; desc = 'Thunderstorm with hail'; }
  else { icon = 'fa-cloud'; desc = 'Unknown'; }
  return { icon: icon, desc: desc };
}

async function refreshWeather(){
  try{
    // Get saved location from localStorage
    let weatherUrl = "/api/weather";
    let locationName = "";
    try {
      const savedLoc = localStorage.getItem('weatherLocation');
      if (savedLoc) {
        const loc = JSON.parse(savedLoc);
        weatherUrl += "?lat=" + loc.latitude + "&lon=" + loc.longitude;
        locationName = loc.name || "";
      }
    } catch (e) {}

    // Update location display
    document.getElementById("weatherLocation").textContent = locationName ? "• " + locationName : "";

    const res = await fetch(weatherUrl, {cache:"no-store"});
    const j = await res.json();

    // Now - current weather
    if (j.current) {
      const nowWeather = getWeatherIcon(j.current.weatherCode);
      const nowIconEl = document.getElementById("weatherNowIcon");
      nowIconEl.innerHTML = '<i class="fas ' + nowWeather.icon + '" title="' + nowWeather.desc + '"></i>';
      nowIconEl.setAttribute('title', nowWeather.desc);
      document.getElementById("weatherNowData").innerHTML =
        '<i class="fas fa-thermometer-half" title="Temperature"></i> ' + j.current.temperature.toFixed(0) + j.current.tempUnit +
        ' <i class="fas fa-tint" title="Humidity"></i> ' + j.current.humidity.toFixed(0) + '%' +
        ' <i class="fas fa-wind" title="Wind"></i> ' + j.current.windSpeed.toFixed(0) + j.current.windUnit;
    } else {
      document.getElementById("weatherNowIcon").innerHTML = "—";
      document.getElementById("weatherNowIcon").removeAttribute('title');
      document.getElementById("weatherNowData").textContent = j.summary || "—";
    }

    // Today
    if (j.today) {
      const todayWeather = getWeatherIcon(j.today.weatherCode);
      const todayIconEl = document.getElementById("weatherTodayIcon");
      todayIconEl.innerHTML = '<i class="fas ' + todayWeather.icon + '" title="' + todayWeather.desc + '"></i>';
      todayIconEl.setAttribute('title', todayWeather.desc);
      document.getElementById("weatherTodayData").innerHTML =
        '<i class="fas fa-temperature-high" title="High"></i> ' + j.today.tempMax.toFixed(0) + '°' +
        ' <i class="fas fa-temperature-low" title="Low"></i> ' + j.today.tempMin.toFixed(0) + '°';
    } else {
      document.getElementById("weatherTodayIcon").innerHTML = "—";
      document.getElementById("weatherTodayIcon").removeAttribute('title');
      document.getElementById("weatherTodayData").textContent = "—";
    }

    // Tomorrow
    if (j.tomorrow) {
      const tomorrowWeather = getWeatherIcon(j.tomorrow.weatherCode);
      const tomorrowIconEl = document.getElementById("weatherTomorrowIcon");
      tomorrowIconEl.innerHTML = '<i class="fas ' + tomorrowWeather.icon + '" title="' + tomorrowWeather.desc + '"></i>';
      tomorrowIconEl.setAttribute('title', tomorrowWeather.desc);
      document.getElementById("weatherTomorrowData").innerHTML =
        '<i class="fas fa-temperature-high" title="High"></i> ' + j.tomorrow.tempMax.toFixed(0) + '°' +
        ' <i class="fas fa-temperature-low" title="Low"></i> ' + j.tomorrow.tempMin.toFixed(0) + '°';
    } else {
      document.getElementById("weatherTomorrowIcon").innerHTML = "—";
      document.getElementById("weatherTomorrowIcon").removeAttribute('title');
      document.getElementById("weatherTomorrowData").textContent = "—";
    }

    document.getElementById("weatherErr").textContent = j.error || "";

    startTimer("weather");
  } catch(err){
    console.error("Error refreshing weather:", err);
  }
}


function renderGitHubContent(moduleId, displayType, data) {
    const container = document.getElementById("content-" + moduleId);
    const countEl = document.getElementById("count-" + moduleId);
    const errEl = document.getElementById("err-" + moduleId);

    if (!container) return;

    if (data.error) {
      container.innerHTML = "";
      if (errEl) errEl.textContent = data.error;
      if (countEl) countEl.textContent = "Error";
      return;
    }

    container.innerHTML = "";
    if (errEl) errEl.textContent = "";

    // Handle different display types
    if (displayType === 'repos') {
      renderReposList(container, countEl, data);
    } else if (displayType === 'prs') {
      renderPRsList(container, countEl, data);
    } else if (displayType === 'commits') {
      renderCommitsList(container, countEl, data);
    } else if (displayType === 'issues') {
      renderIssuesList(container, countEl, data);
    } else if (displayType === 'stats') {
      renderStats(container, countEl, data);
    } else {
      renderReposList(container, countEl, data);
    }
}

function renderReposList(container, countEl, data) {
    if (data.repos && data.repos.length > 0) {
      if (countEl) countEl.textContent = (data.total || data.repos.length) + " repositories";
      data.repos.forEach((repo) => {
        const item = document.createElement("div");
        item.className = "repo-item";
        const name = document.createElement("div");
        name.className = "repo-name";
        const link = document.createElement("a");
        link.href = repo.url;
        link.target = "_blank";
        link.rel = "noreferrer";
        link.innerHTML = '<i class="fab fa-github"></i> ' + repo.fullName;
        name.appendChild(link);
        item.appendChild(name);
        if (repo.description) {
          const desc = document.createElement("div");
          desc.className = "repo-desc";
          desc.textContent = repo.description;
          item.appendChild(desc);
        }
        const meta = document.createElement("div");
        meta.className = "repo-meta";
        if (repo.stars > 0) {
          const stars = document.createElement("span");
          stars.innerHTML = '<i class="fas fa-star"></i> ' + repo.stars;
          meta.appendChild(stars);
        }
        if (repo.language) {
          const lang = document.createElement("span");
          lang.innerHTML = '<i class="fas fa-code"></i> ' + repo.language;
          meta.appendChild(lang);
        }
        if (repo.updated) {
          const updated = document.createElement("span");
          updated.innerHTML = '<i class="fas fa-clock"></i> ' + repo.updated;
          meta.appendChild(updated);
        }
        item.appendChild(meta);
        container.appendChild(item);
      });
    } else {
      container.innerHTML = '<div class="small">No repositories found.</div>';
      if (countEl) countEl.textContent = "0 repositories";
    }
}

function renderPRsList(container, countEl, data) {
    if (data.items && data.items.length > 0) {
      if (countEl) countEl.textContent = (data.total || data.items.length) + " pull requests";
      data.items.forEach((pr) => {
        const item = document.createElement("div");
        item.className = "repo-item";
        item.innerHTML = `
          <div class="repo-name"><a href="${pr.url}" target="_blank" rel="noreferrer"><i class="fas fa-code-branch"></i> ${pr.title}</a></div>
          <div class="repo-meta">
            <span><i class="fas fa-user"></i> ${pr.user || 'Unknown'}</span>
            <span><i class="fas fa-clock"></i> ${pr.created || ''}</span>
            <span class="badge-${pr.state || 'open'}">${pr.state || 'open'}</span>
          </div>
        `;
        container.appendChild(item);
      });
    } else {
      container.innerHTML = '<div class="small">No pull requests found.</div>';
      if (countEl) countEl.textContent = "0 pull requests";
    }
}

function renderCommitsList(container, countEl, data) {
    if (data.items && data.items.length > 0) {
      if (countEl) countEl.textContent = (data.items.length) + " recent commits";
      data.items.forEach((commit) => {
        const item = document.createElement("div");
        item.className = "repo-item";
        item.innerHTML = `
          <div class="repo-name"><a href="${commit.url}" target="_blank" rel="noreferrer"><i class="fas fa-code-commit"></i> ${commit.message}</a></div>
          <div class="repo-meta">
            <span><i class="fas fa-user"></i> ${commit.author || 'Unknown'}</span>
            <span><i class="fas fa-clock"></i> ${commit.date || ''}</span>
          </div>
        `;
        container.appendChild(item);
      });
    } else {
      container.innerHTML = '<div class="small">No commits found.</div>';
      if (countEl) countEl.textContent = "0 commits";
    }
}

function renderIssuesList(container, countEl, data) {
    if (data.items && data.items.length > 0) {
      if (countEl) countEl.textContent = (data.total || data.items.length) + " issues";
      data.items.forEach((issue) => {
        const item = document.createElement("div");
        item.className = "repo-item";
        item.innerHTML = `
          <div class="repo-name"><a href="${issue.url}" target="_blank" rel="noreferrer"><i class="fas fa-exclamation-circle"></i> ${issue.title}</a></div>
          <div class="repo-meta">
            <span><i class="fas fa-user"></i> ${issue.user || 'Unknown'}</span>
            <span><i class="fas fa-clock"></i> ${issue.created || ''}</span>
            <span class="badge-${issue.state || 'open'}">${issue.state || 'open'}</span>
          </div>
        `;
        container.appendChild(item);
      });
    } else {
      container.innerHTML = '<div class="small">No issues found.</div>';
      if (countEl) countEl.textContent = "0 issues";
    }
}

function renderStats(container, countEl, data) {
    if (data.stats) {
      if (countEl) countEl.textContent = "Repository stats";
      container.innerHTML = `
        <div class="kv"><div class="k">Stars</div><div class="v">${data.stats.stars || 0}</div></div>
        <div class="kv"><div class="k">Forks</div><div class="v">${data.stats.forks || 0}</div></div>
        <div class="kv"><div class="k">Watchers</div><div class="v">${data.stats.watchers || 0}</div></div>
        <div class="kv"><div class="k">Open Issues</div><div class="v">${data.stats.openIssues || 0}</div></div>
        <div class="kv"><div class="k">Language</div><div class="v">${data.stats.language || 'N/A'}</div></div>
      `;
    } else {
      container.innerHTML = '<div class="small">No stats available.</div>';
      if (countEl) countEl.textContent = "No stats";
    }
}

async function refreshGitHubModule(mod) {
  try {
    const displayType = mod.displayType || 'repos';
    const accountType = mod.accountType || mod.type || 'user';
    const githubToken = localStorage.getItem('githubToken') || '';
    let url = "/api/github/" + displayType + "?name=" + encodeURIComponent(mod.name) + "&type=" + accountType;
    if (githubToken) url += "&token=" + encodeURIComponent(githubToken);
    const res = await fetch(url, {cache:"no-store"});
    const data = await res.json();
    renderGitHubContent(mod.id, displayType, data);
  } catch(err) {
    console.error("Error refreshing GitHub module " + mod.id + ":", err);
    const errEl = document.getElementById("err-" + mod.id);
    if (errEl) errEl.textContent = "Error loading data";
  }
}

async function refreshGitHub(){
  try{
    // Refresh all enabled GitHub modules
    const promises = githubModules.filter(m => m.enabled).map(mod => refreshGitHubModule(mod));
    await Promise.all(promises);
    startTimer("github");
  } catch(err){
    console.error("Error refreshing GitHub:", err);
  }
}

async function refreshIP(){
  try{
    const res = await fetch("/api/ip", {cache:"no-store"});
    const j = await res.json();

    // Get summary to check if local
    const summaryRes = await fetch("/api/summary", {cache:"no-store"});
    const summary = await summaryRes.json();
    const isLocal = summary.server.isLocal || false;

    // Update label based on whether it's local or remote
    const lanIpLabel = document.getElementById("lanIpLabel");
    if (isLocal) {
      lanIpLabel.textContent = "LAN IPs";
    } else {
      lanIpLabel.textContent = "Client IP";
    }

    // Display IPs with PTR records on second line
    const lanIpsEl = document.getElementById("lanIps");
    const lanPtrEl = document.getElementById("lanPtr");
    if (j.network && j.network.hostIps && j.network.hostIps.length > 0) {
      const ips = j.network.hostIps.map(ipInfo => ipInfo.ip);
      const ptrs = j.network.hostIps.map(ipInfo => ipInfo.ptr).filter(p => p);
      lanIpsEl.textContent = ips.join(", ");
      lanPtrEl.textContent = ptrs.length > 0 ? ptrs.join(", ") : "";
    } else {
      lanIpsEl.textContent = "—";
      lanPtrEl.textContent = "";
    }

    // Display Public IP with PTR on second line
    if (j.public && j.public.ip) {
      document.getElementById("pubIp").textContent = j.public.ip;
      document.getElementById("pubPtr").textContent = j.public.ptr || "";
      document.getElementById("pubIpErr").textContent = "";
    } else {
      document.getElementById("pubIp").textContent = "—";
      document.getElementById("pubPtr").textContent = "";
      document.getElementById("pubIpErr").textContent = (j.public && j.public.error) || "";
    }

    startTimer("ip");
  } catch(err){
    console.error("Error refreshing IP:", err);
  }
}

// Detect client information
function detectClientInfo(){
  const ua = navigator.userAgent;
  let os = "Unknown";
  let browser = "Unknown";

  // Detect OS
  if (ua.includes("Win")) os = "Windows";
  else if (ua.includes("Mac")) os = "macOS";
  else if (ua.includes("Linux")) os = "Linux";
  else if (ua.includes("Android")) os = "Android";
  else if (ua.includes("iOS") || ua.includes("iPhone") || ua.includes("iPad")) os = "iOS";

  // Detect Browser
  if (ua.includes("Chrome") && !ua.includes("Edg")) browser = "Chrome";
  else if (ua.includes("Firefox")) browser = "Firefox";
  else if (ua.includes("Safari") && !ua.includes("Chrome")) browser = "Safari";
  else if (ua.includes("Edg")) browser = "Edge";
  else if (ua.includes("Opera") || ua.includes("OPR")) browser = "Opera";

  // Get timezone
  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

  return { os, browser, timezone };
}

async function refresh(){
  try{
    const res = await fetch("/api/summary", {cache:"no-store"});
    const j = await res.json();

    const isLocal = j.server.isLocal || false;

    // Update title based on whether it's local or remote
    const statusTitle = document.getElementById("statusTitle");
    const serverInfoDiv = document.getElementById("serverInfo");
    const clientInfoDiv = document.getElementById("clientInfo");

    if (isLocal) {
      statusTitle.textContent = "Status";
      serverInfoDiv.style.display = "block";
      clientInfoDiv.style.display = "none";

      // Show server info
      document.getElementById("host").textContent = j.server.hostname;
      document.getElementById("uptime").textContent = fmtUptime(j.server.uptimeSec);
      document.getElementById("time").textContent = j.server.time;
    } else {
      statusTitle.textContent = "Client Status";
      serverInfoDiv.style.display = "none";
      clientInfoDiv.style.display = "block";

      // Show client info from API
      if (j.client) {
        document.getElementById("clientIP").textContent = j.client.ip || "—";
        document.getElementById("clientHostname").textContent = j.client.hostname || "—";
      }
    }

    document.getElementById("subtitle").textContent =
      j.server.os + "/" + j.server.arch + " • " + j.server.goVersion;

  } catch(err){
    document.getElementById("statusText").textContent = "Degraded";
  }
}

document.getElementById("refreshBtn").onclick = refresh;

// Setup double-click handlers for timers
const refreshHandlers = {
  cpu: refreshCPU,
  ram: refreshRAM,
  disk: refreshDisk,
  github: refreshGitHub,
  weather: refreshWeather,
  ip: refreshIP,
  monitoring: function() { if (window.refreshMonitoring) window.refreshMonitoring(); },
  snmp: function() { if (window.refreshSnmp) window.refreshSnmp(); },
  rss: function() { if (window.refreshRss) window.refreshRss(); }
};

["cpu", "cpuid", "ram", "disk", "github", "weather", "ip", "monitoring", "snmp", "rss"].forEach(module => {
  const timerEl = document.getElementById(module + "Timer");
  if (timerEl) {
    let lastClick = 0;
    timerEl.addEventListener("dblclick", (e) => {
      e.preventDefault();
      e.stopPropagation();
      const handler = refreshHandlers[module];
      if (handler) handler();
    });
    // Also handle click for better compatibility
    timerEl.addEventListener("click", (e) => {
      const now = Date.now();
      if (now - lastClick < 300) {
        e.preventDefault();
        e.stopPropagation();
        const handler = refreshHandlers[module];
        if (handler) handler();
      }
      lastClick = now;
    });
  }
});

// Module configuration with defaults
const moduleConfig = {
  status: { name: 'Status', icon: 'fa-server', desc: 'Server status and uptime', hasTimer: false, enabled: true },
  network: { name: 'Network', icon: 'fa-network-wired', desc: 'LAN and public IP addresses', hasTimer: true, timerKey: 'ip', defaultInterval: 7200, enabled: true },
  weather: { name: 'Weather', icon: 'fa-cloud-sun', desc: 'Current weather and forecast', hasTimer: true, timerKey: 'weather', defaultInterval: 1800, enabled: true },
  cpu: { name: 'CPU', icon: 'fa-microchip', desc: 'CPU usage monitoring', hasTimer: true, timerKey: 'cpu', defaultInterval: 5, enabled: true },
  cpuid: { name: 'CPU Info', icon: 'fa-microchip', desc: 'CPU specifications and cache', hasTimer: false, enabled: true },
  ram: { name: 'RAM', icon: 'fa-memory', desc: 'Memory usage monitoring', hasTimer: true, timerKey: 'ram', defaultInterval: 5, enabled: true },
  disk: { name: 'Disk', icon: 'fa-hdd', desc: 'Disk space monitoring', hasTimer: true, timerKey: 'disk', defaultInterval: 15, enabled: true },
  links: { name: 'Quick Links', icon: 'fa-link', desc: 'Custom shortcut links', hasTimer: false, enabled: true },
  monitoring: { name: 'Monitoring', icon: 'fa-heartbeat', desc: 'Service health monitoring', hasTimer: true, timerKey: 'monitoring', defaultInterval: 60, enabled: true },
  snmp: { name: 'SNMP', icon: 'fa-network-wired', desc: 'SNMP device queries', hasTimer: true, timerKey: 'snmp', defaultInterval: 60, enabled: true },
  rss: { name: 'RSS', icon: 'fa-rss', desc: 'RSS feed reader', hasTimer: true, timerKey: 'rss', defaultInterval: 300, enabled: true }
};

// GitHub modules configuration (stored separately, can have multiple)
// displayType: repos, prs, commits, stats, issues
// accountType: user, org, repo (for repo-specific views)
const defaultGitHubModules = [
  { id: 'github-1', accountType: 'user', displayType: 'repos', name: 'Earentir', url: 'https://github.com/Earentir', enabled: true },
  { id: 'github-2', accountType: 'org', displayType: 'repos', name: 'network-plane', url: 'https://github.com/network-plane', enabled: true }
];

const githubDisplayTypes = {
  repos: { name: 'Repositories', icon: 'fa-folder', desc: 'Show recent repositories' },
  prs: { name: 'Pull Requests', icon: 'fa-code-branch', desc: 'Show open pull requests' },
  commits: { name: 'Commits', icon: 'fa-code-commit', desc: 'Show recent commits' },
  stats: { name: 'Stats', icon: 'fa-chart-bar', desc: 'Show repository statistics' },
  issues: { name: 'Issues', icon: 'fa-exclamation-circle', desc: 'Show open issues' }
};

let githubModules = [];
try {
  const saved = localStorage.getItem('githubModules');
  if (saved) {
    githubModules = JSON.parse(saved);
  } else {
    githubModules = defaultGitHubModules;
  }
} catch (e) {
  githubModules = defaultGitHubModules;
}

function saveGitHubModules() {
  localStorage.setItem('githubModules', JSON.stringify(githubModules));
}

function renderGitHubModules() {
  const container = document.getElementById('githubModulesContainer');
  if (!container) return;
  container.innerHTML = '';

  // Get layout config to check which modules are already in the layout
  const layoutConfig = window.layoutSystem ? window.layoutSystem.getLayoutConfig() : null;
  const modulesInLayout = new Set();
  if (layoutConfig) {
    layoutConfig.rows.forEach(row => {
      row.modules.forEach(moduleId => {
        if (moduleId && (moduleId.startsWith('github-') || moduleId.startsWith('rss-'))) {
          modulesInLayout.add(moduleId);
        }
      });
    });
  }

  githubModules.forEach((mod, index) => {
    if (!mod.enabled) return;
    // Skip modules that are already in the layout grid
    if (modulesInLayout.has(mod.id)) return;

    // Handle legacy modules without displayType
    const displayType = mod.displayType || 'repos';
    const accountType = mod.accountType || mod.type || 'user';
    const typeInfo = githubDisplayTypes[displayType] || githubDisplayTypes.repos;

    const card = document.createElement('div');
    card.className = 'card span-6';
    card.setAttribute('data-module', mod.id);
    card.setAttribute('draggable', 'true');

    const hasTimer = index === 0; // Only first GitHub module has the timer
    const timerHtml = hasTimer ? '<div class="timer-circle" id="githubTimer" title="Double-click to refresh"></div>' : '';

    const titleSuffix = displayType !== 'repos' ? ' - ' + typeInfo.name : '';

    card.innerHTML = `
      <h3><i class="fab fa-github"></i> ${mod.name}${titleSuffix}<div class="header-icons"><a href="${mod.url}" target="_blank" rel="noreferrer"><i class="fas fa-external-link-alt"></i></a>${timerHtml}<i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
      <div class="small" style="margin-bottom:8px; color:var(--muted);"><i class="fas ${typeInfo.icon}"></i> <span id="count-${mod.id}">—</span></div>
      <div id="content-${mod.id}">
        <div class="small">Loading...</div>
      </div>
      <div class="small" id="err-${mod.id}"></div>
    `;

    container.appendChild(card);
  });

  // Re-initialize drag and drop after GitHub modules are rendered
  if (window.initDragAndDrop) {
    setTimeout(() => window.initDragAndDrop(), 50);
  }
}

// Render GitHub modules on page load
renderGitHubModules();

// Initial refresh
refresh();
applyFullBarsClass(); // Apply full bars styling before rendering
// Trim history arrays to fit current minBarWidth (wait for graphs to be rendered)
function initGraphs() {
  const graphsReady = trimHistoryArrays();
  renderCpuGraph(); // Render saved CPU history
  renderRamGraph(); // Render saved RAM history
  renderDiskGraph(); // Render saved Disk history
  // If graphs weren't ready, try again after a short delay
  if (!graphsReady && (cpuHistory.length > 0 || ramHistory.length > 0 || diskHistory.length > 0)) {
    setTimeout(initGraphs, 100);
  }
}
setTimeout(initGraphs, 0);
refreshCPU();
refreshRAM();
refreshDisk();
refreshCPUInfo(); // Load once, no refresh needed
refreshGitHub();
refreshWeather();
refreshIP();

// Load saved module preferences
function loadModulePrefs() {
  try {
    const saved = localStorage.getItem('modulePrefs');
    if (saved) {
      const prefs = JSON.parse(saved);
      Object.keys(prefs).forEach(key => {
        if (moduleConfig[key]) {
          if (typeof prefs[key].enabled !== 'undefined') {
            moduleConfig[key].enabled = prefs[key].enabled;
          }
          if (typeof prefs[key].interval !== 'undefined' && moduleConfig[key].hasTimer) {
            const timerKey = moduleConfig[key].timerKey;
            if (timers[timerKey]) {
              timers[timerKey].interval = prefs[key].interval * 1000;
            }
          }
        }
      });
    }
  } catch (e) {
    console.error('Error loading module prefs:', e);
  }
}

function saveModulePrefs() {
  try {
    const prefs = {};
    Object.keys(moduleConfig).forEach(key => {
      prefs[key] = { enabled: moduleConfig[key].enabled };
      if (moduleConfig[key].hasTimer) {
        const timerKey = moduleConfig[key].timerKey;
        if (timers[timerKey]) {
          prefs[key].interval = timers[timerKey].interval / 1000;
        }
      }
    });
    localStorage.setItem('modulePrefs', JSON.stringify(prefs));
  } catch (e) {
    console.error('Error saving module prefs:', e);
  }
}

function applyModuleVisibility() {
  Object.keys(moduleConfig).forEach(key => {
    const card = document.querySelector(`.card[data-module="${key}"]`);
    if (card) {
      card.style.display = moduleConfig[key].enabled ? '' : 'none';
    }
  });
}

// Load prefs on startup
loadModulePrefs();
applyModuleVisibility();

// Preferences Modal
(function() {
  const modal = document.getElementById('prefsModal');
  const openBtn = document.getElementById('prefsBtn');
  const closeBtn = document.getElementById('prefsClose');
  const tabs = document.querySelectorAll('.modal-tab');
  const tabContents = document.querySelectorAll('.tab-content');

  // Open modal
  openBtn.addEventListener('click', () => {
    modal.classList.add('active');
    renderModuleList();
    updateSchemeSelect();
    // Render search history if search tab is active
    if (document.getElementById('tab-search') && document.getElementById('tab-search').classList.contains('active')) {
      setTimeout(() => {
        if (window.renderSearchHistory) {
          window.renderSearchHistory();
        }
      }, 50);
    }
  });

  // Close modal
  closeBtn.addEventListener('click', () => {
    modal.classList.remove('active');
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('active');
    }
  });

  // Tab switching
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('tab-' + tab.dataset.tab).classList.add('active');

      // Render layout editor when layout tab is opened
      if (tab.dataset.tab === 'layout' && window.layoutSystem) {
        setTimeout(() => {
          window.layoutSystem.renderLayoutEditor();
        }, 50);
      }

      // Render search history when search tab is opened
      if (tab.dataset.tab === 'search') {
        setTimeout(() => {
          if (window.renderSearchHistory) {
            window.renderSearchHistory();
          }
        }, 50);
      }
    });
  });

  // Template/scheme selects
  const templateSelect = document.getElementById('pref-template');
  const schemeSelect = document.getElementById('pref-scheme');

  // Set current template value
  const currentTemplate = localStorage.getItem('template') || '{{.CurrentTemplate}}' || 'nordic';
  templateSelect.value = currentTemplate;

  templateSelect.addEventListener('change', () => {
    const newTemplate = templateSelect.value;
    localStorage.setItem('template', newTemplate);
    localStorage.setItem('scheme', 'default'); // Reset scheme when changing template
    document.cookie = 'template=' + newTemplate + '; path=/; max-age=31536000';
    document.cookie = 'scheme=default; path=/; max-age=31536000';
    location.reload();
  });

  function updateSchemeSelect() {
    const currentScheme = localStorage.getItem('scheme') || '{{.CurrentScheme}}' || 'default';
    // Get schemes from the existing scheme menu (uses buttons with data-scheme)
    const schemeMenu = document.getElementById('schemeMenu');
    schemeSelect.innerHTML = '';
    if (schemeMenu) {
      const schemeButtons = schemeMenu.querySelectorAll('button[data-scheme]');
      schemeButtons.forEach(btn => {
        const scheme = btn.getAttribute('data-scheme');
        const name = btn.textContent.trim();
        const option = document.createElement('option');
        option.value = scheme;
        option.textContent = name;
        if (scheme === currentScheme) option.selected = true;
        schemeSelect.appendChild(option);
      });
    }
  }

  schemeSelect.addEventListener('change', () => {
    const template = localStorage.getItem('template') || '{{.CurrentTemplate}}' || 'nordic';
    const newScheme = schemeSelect.value;
    localStorage.setItem('scheme', newScheme);
    document.cookie = 'scheme=' + newScheme + '; path=/; max-age=31536000';
    location.reload();
  });

  // Initialize scheme select on modal open
  updateSchemeSelect();

  // Clear cache button
  document.getElementById('clearCacheBtn').addEventListener('click', () => {
    localStorage.removeItem('cpuHistory');
    localStorage.removeItem('ramHistory');
    localStorage.removeItem('diskHistory');
    localStorage.removeItem('githubData');
    alert('Cache cleared!');
  });

  // GitHub token handling
  const githubTokenInput = document.getElementById('pref-github-token');
  const toggleGithubTokenBtn = document.getElementById('toggleGithubToken');

  // Load saved token
  const savedGithubToken = localStorage.getItem('githubToken');
  if (savedGithubToken) {
    githubTokenInput.value = savedGithubToken;
  }

  // Save token on change
  githubTokenInput.addEventListener('change', () => {
    const token = githubTokenInput.value.trim();
    if (token) {
      localStorage.setItem('githubToken', token);
    } else {
      localStorage.removeItem('githubToken');
    }
  });

  // Toggle token visibility
  toggleGithubTokenBtn.addEventListener('click', () => {
    if (githubTokenInput.type === 'password') {
      githubTokenInput.type = 'text';
      toggleGithubTokenBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
    } else {
      githubTokenInput.type = 'password';
      toggleGithubTokenBtn.innerHTML = '<i class="fas fa-eye"></i>';
    }
  });

  // Reset order button
  document.getElementById('resetOrderBtn').addEventListener('click', () => {
    localStorage.removeItem('moduleOrder');
    location.reload();
  });

  // Search history management
  const searchHistoryFilter = document.getElementById('searchHistoryFilter');
  const searchHistoryList = document.getElementById('searchHistoryList');
  const clearSearchHistoryBtn = document.getElementById('clearSearchHistoryBtn');

  // Render search history list
  window.renderSearchHistory = function() {
    const filter = (searchHistoryFilter.value || "").toLowerCase().trim();
    let filteredHistory = searchHistory;

    if (filter) {
      filteredHistory = searchHistory.filter(item =>
        item.term.toLowerCase().includes(filter) ||
        item.engine.toLowerCase().includes(filter)
      );
    }

    // Reverse to show most recent first
    filteredHistory = [...filteredHistory].reverse();

    if (filteredHistory.length === 0) {
      searchHistoryList.innerHTML = '<div class="small" style="color:var(--muted); padding:12px; text-align:center;">' +
        (filter ? 'No searches match your filter' : 'No search history') + '</div>';
      return;
    }

    searchHistoryList.innerHTML = '';
    filteredHistory.forEach((item, displayIndex) => {
      // Find actual index in original array (reversed for display)
      // filteredHistory is reversed, so we need to find the item in the original array
      const actualIndex = searchHistory.findIndex(h => h.term === item.term && h.engine === item.engine && h.timestamp === item.timestamp);
      if (actualIndex === -1) return; // Skip if not found (shouldn't happen)

      const div = document.createElement('div');
      div.className = 'module-item';
      div.style.display = 'flex';
      div.style.alignItems = 'center';
      div.style.gap = '12px';
      div.style.padding = '10px';
      div.style.border = '1px solid var(--border)';
      div.style.borderRadius = '8px';
      div.style.marginBottom = '8px';

      const info = document.createElement('div');
      info.style.flex = '1';
      info.style.minWidth = '0';

      const termDiv = document.createElement('div');
      termDiv.style.fontWeight = '500';
      termDiv.style.marginBottom = '4px';
      termDiv.textContent = item.term;

      const metaDiv = document.createElement('div');
      metaDiv.className = 'small';
      metaDiv.style.color = 'var(--muted)';
      metaDiv.style.display = 'flex';
      metaDiv.style.gap = '12px';
      metaDiv.style.flexWrap = 'wrap';

      const engineSpan = document.createElement('span');
      engineSpan.textContent = item.engine;

      const timeSpan = document.createElement('span');
      const date = new Date(item.timestamp);
      timeSpan.textContent = date.toLocaleString();

      metaDiv.appendChild(engineSpan);
      metaDiv.appendChild(timeSpan);

      info.appendChild(termDiv);
      info.appendChild(metaDiv);

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '8px';

      const searchBtn = document.createElement('button');
      searchBtn.className = 'btn-small';
      searchBtn.innerHTML = '<i class="fas fa-search"></i>';
      searchBtn.title = 'Search again';
      searchBtn.onclick = () => {
        // Find the engine
        const searchEngine = engines.find(e => e.name === item.engine) || engines[0];
        engine = searchEngine;
        engineBtn.textContent = engine.name + " ▾";
        q.value = item.term;
        q.focus();
        modal.classList.remove('active');
        goSearch();
      };

      const removeBtn = document.createElement('button');
      removeBtn.className = 'btn-small';
      removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
      removeBtn.title = 'Remove';
      removeBtn.onclick = () => {
        removeFromSearchHistory(actualIndex);
      };

      actions.appendChild(searchBtn);
      actions.appendChild(removeBtn);

      div.appendChild(info);
      div.appendChild(actions);
      searchHistoryList.appendChild(div);
    });
  };

  // Filter search history
  searchHistoryFilter.addEventListener('input', () => {
    window.renderSearchHistory();
  });

  // Clear all search history
  clearSearchHistoryBtn.addEventListener('click', () => {
    clearSearchHistory();
  });

  // Render search history when search tab is opened
  const searchTab = document.querySelector('.modal-tab[data-tab="search"]');
  if (searchTab) {
    searchTab.addEventListener('click', () => {
      setTimeout(() => {
        if (window.renderSearchHistory) {
          window.renderSearchHistory();
        }
      }, 50);
    });
  }

  // Full bars preference
  const fullBarsCheckbox = document.getElementById('pref-full-bars');
  const minBarWidthInput = document.getElementById('pref-min-bar-width');

  // Load and set minBarWidth input
  minBarWidthInput.value = minBarWidth;

  // Save minBarWidth on change
  minBarWidthInput.addEventListener('change', () => {
    const newValue = Math.max(2, Math.min(50, parseInt(minBarWidthInput.value) || 10));
    minBarWidthInput.value = newValue;
    minBarWidth = newValue;
    saveMinBarWidth();
    // Re-trim history arrays with new minBarWidth
    trimHistoryArrays();
    // Re-render graphs
    renderCpuGraph();
    renderRamGraph();
    renderDiskGraph();
  });
  fullBarsCheckbox.checked = showFullBars;
  fullBarsCheckbox.addEventListener('change', () => {
    showFullBars = fullBarsCheckbox.checked;
    saveFullBarsPreference();
    applyFullBarsClass();
    // Re-render all graphs with new styling
    renderCpuGraph();
    renderRamGraph();
    renderDiskGraph();
  });

  // Weather location
  const locationInput = document.getElementById('pref-weather-location');
  const searchLocationBtn = document.getElementById('searchLocationBtn');
  const locationResultsRow = document.getElementById('locationResultsRow');
  const locationResultsSelect = document.getElementById('pref-location-results');
  const currentLocationDisplay = document.getElementById('currentLocationDisplay');

  // Load saved location
  function loadWeatherLocation() {
    try {
      const saved = localStorage.getItem('weatherLocation');
      if (saved) {
        const loc = JSON.parse(saved);
        currentLocationDisplay.textContent = loc.name + ', ' + loc.country + ' (' + loc.latitude.toFixed(2) + ', ' + loc.longitude.toFixed(2) + ')';
        locationInput.value = loc.name + ', ' + loc.country;
      } else {
        currentLocationDisplay.textContent = 'Not set';
      }
    } catch (e) {
      currentLocationDisplay.textContent = 'Not set';
    }
  }
  loadWeatherLocation();

  // Search location
  searchLocationBtn.addEventListener('click', async () => {
    const query = locationInput.value.trim();
    if (!query) return;

    searchLocationBtn.disabled = true;
    searchLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
      const res = await fetch('/api/geocode?q=' + encodeURIComponent(query));
      const data = await res.json();

      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }

      if (data.length === 0) {
        alert('No locations found for "' + query + '"');
        return;
      }

      // Populate results dropdown
      locationResultsSelect.innerHTML = '';
      data.forEach((loc, index) => {
        const option = document.createElement('option');
        option.value = index;
        let label = loc.name;
        if (loc.admin1) label += ', ' + loc.admin1;
        label += ', ' + loc.country;
        option.textContent = label;
        option.dataset.location = JSON.stringify(loc);
        locationResultsSelect.appendChild(option);
      });

      locationResultsRow.style.display = 'flex';
    } catch (e) {
      alert('Error searching location: ' + e.message);
    } finally {
      searchLocationBtn.disabled = false;
      searchLocationBtn.innerHTML = '<i class="fas fa-search"></i>';
    }
  });

  // Enter key to search
  locationInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchLocationBtn.click();
    }
  });

  // Set location button
  const setLocationBtn = document.getElementById('setLocationBtn');
  setLocationBtn.addEventListener('click', () => {
    const selected = locationResultsSelect.options[locationResultsSelect.selectedIndex];
    if (selected && selected.dataset.location) {
      const loc = JSON.parse(selected.dataset.location);
      localStorage.setItem('weatherLocation', JSON.stringify(loc));
      currentLocationDisplay.textContent = loc.name + ', ' + loc.country + ' (' + loc.latitude.toFixed(2) + ', ' + loc.longitude.toFixed(2) + ')';
      locationResultsRow.style.display = 'none';
      // Refresh weather with new location
      refreshWeather();
    }
  });

  // Render module list
  function renderModuleList() {
    const list = document.getElementById('moduleList');
    list.innerHTML = '';

    Object.keys(moduleConfig).forEach(key => {
      const config = moduleConfig[key];
      const timerKey = config.timerKey;
      const currentInterval = timerKey && timers[timerKey] ? timers[timerKey].interval / 1000 : 0;

      const item = document.createElement('div');
      item.className = 'module-item' + (config.enabled ? '' : ' disabled');
      item.innerHTML = `
        <div class="module-icon"><i class="fas ${config.icon}"></i></div>
        <div class="module-info">
          <div class="module-name">${config.name}</div>
          <div class="module-desc">${config.desc}</div>
        </div>
        <div class="module-controls">
          ${config.hasTimer ? `
            <div class="refresh-control">
              <input type="number" min="1" value="${currentInterval}" data-module="${key}" data-timer="${timerKey}" data-default="${config.defaultInterval}">
              <span>sec</span>
              <button class="reset-btn" title="Reset to default (${config.defaultInterval}s)" data-module="${key}" data-timer="${timerKey}" data-default="${config.defaultInterval}"><i class="fas fa-undo"></i></button>
            </div>
          ` : ''}
          <input type="checkbox" ${config.enabled ? 'checked' : ''} data-module="${key}" title="Enable/disable module">
        </div>
      `;
      list.appendChild(item);

      // Enable/disable handler
      const checkbox = item.querySelector('input[type="checkbox"]');
      checkbox.addEventListener('change', () => {
        moduleConfig[key].enabled = checkbox.checked;
        item.classList.toggle('disabled', !checkbox.checked);
        saveModulePrefs();
        applyModuleVisibility();
      });

      // Interval change handler
      const intervalInput = item.querySelector('input[type="number"]');
      if (intervalInput) {
        intervalInput.addEventListener('change', () => {
          const newInterval = Math.max(1, parseInt(intervalInput.value) || config.defaultInterval);
          intervalInput.value = newInterval;
          if (timers[timerKey]) {
            timers[timerKey].interval = newInterval * 1000;
          }
          saveModulePrefs();
        });
      }

      // Reset button handler
      const resetBtn = item.querySelector('.reset-btn');
      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          const defaultVal = parseInt(resetBtn.dataset.default);
          if (intervalInput) {
            intervalInput.value = defaultVal;
            if (timers[timerKey]) {
              timers[timerKey].interval = defaultVal * 1000;
            }
            saveModulePrefs();
          }
        });
      }
    });
  }

  // Render GitHub module list
  function renderGitHubModuleList() {
    const list = document.getElementById('githubModuleList');
    if (!list) return;
    list.innerHTML = '';

    githubModules.forEach((mod, index) => {
      const accountType = mod.accountType || mod.type || 'user';
      const displayType = mod.displayType || 'repos';
      const displayInfo = githubDisplayTypes[displayType] || githubDisplayTypes.repos;
      const accountLabel = accountType === 'org' ? 'Organization' : (accountType === 'repo' ? 'Repository' : 'User');

      const item = document.createElement('div');
      item.className = 'module-item' + (mod.enabled ? '' : ' disabled');
      item.innerHTML = `
        <div class="module-icon"><i class="fab fa-github"></i></div>
        <div class="module-info">
          <div class="module-name">${mod.name}</div>
          <div class="module-desc">${accountLabel} • ${displayInfo.name}</div>
        </div>
        <div class="module-controls">
          <button class="btn-small edit-github-btn" data-index="${index}"><i class="fas fa-edit"></i></button>
          <button class="btn-small delete-github-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
          <input type="checkbox" ${mod.enabled ? 'checked' : ''} data-index="${index}" title="Enable/disable">
        </div>
      `;
      list.appendChild(item);

      // Enable/disable handler
      const checkbox = item.querySelector('input[type="checkbox"]');
      checkbox.addEventListener('change', () => {
        githubModules[index].enabled = checkbox.checked;
        item.classList.toggle('disabled', !checkbox.checked);
        saveGitHubModules();
        renderGitHubModules();
      });

      // Edit button
      const editBtn = item.querySelector('.edit-github-btn');
      editBtn.addEventListener('click', () => {
        showGitHubEditDialog(index);
      });

      // Delete button
      const deleteBtn = item.querySelector('.delete-github-btn');
      deleteBtn.addEventListener('click', () => {
        if (confirm('Delete GitHub module "' + mod.name + '"?')) {
          githubModules.splice(index, 1);
          saveGitHubModules();
          renderGitHubModuleList();
          renderGitHubModules();
        }
      });
    });
  }

  // GitHub edit dialog
  function showGitHubEditDialog(index) {
    const mod = index >= 0 ? githubModules[index] : { id: 'github-' + Date.now(), type: 'user', name: '', url: '', enabled: true };
    const isNew = index < 0;

    const dialog = document.createElement('div');
    dialog.className = 'modal-overlay active';
    dialog.innerHTML = `
      <div class="modal" style="max-width:400px;">
        <div class="modal-header">
          <h2><i class="fab fa-github"></i> ${isNew ? 'Add' : 'Edit'} GitHub Module</h2>
          <button class="modal-close github-dialog-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-content">
          <div class="pref-section">
            <div class="pref-row">
              <label>GitHub URL</label>
              <input type="text" id="github-edit-url" placeholder="https://github.com/username or https://github.com/user/repo" value="${mod.url}">
            </div>
            <div class="pref-row">
              <label>Account Type</label>
              <select id="github-edit-account-type">
                <option value="user" ${(mod.accountType || mod.type) === 'user' ? 'selected' : ''}>User</option>
                <option value="org" ${(mod.accountType || mod.type) === 'org' ? 'selected' : ''}>Organization</option>
                <option value="repo" ${(mod.accountType || mod.type) === 'repo' ? 'selected' : ''}>Repository</option>
              </select>
            </div>
            <div class="pref-row">
              <label>Display</label>
              <select id="github-edit-display-type">
                <option value="repos" ${(mod.displayType || 'repos') === 'repos' ? 'selected' : ''}>Repositories</option>
                <option value="prs" ${mod.displayType === 'prs' ? 'selected' : ''}>Pull Requests</option>
                <option value="commits" ${mod.displayType === 'commits' ? 'selected' : ''}>Commits</option>
                <option value="issues" ${mod.displayType === 'issues' ? 'selected' : ''}>Issues</option>
                <option value="stats" ${mod.displayType === 'stats' ? 'selected' : ''}>Stats</option>
              </select>
            </div>
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
            <button class="btn-small github-dialog-cancel">Cancel</button>
            <button class="btn-small github-dialog-save" style="background:var(--accent); color:var(--bg);"><i class="fas fa-check"></i> Save</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(dialog);

    const urlInput = dialog.querySelector('#github-edit-url');
    const accountTypeSelect = dialog.querySelector('#github-edit-account-type');
    const displayTypeSelect = dialog.querySelector('#github-edit-display-type');
    const closeBtn = dialog.querySelector('.github-dialog-close');
    const cancelBtn = dialog.querySelector('.github-dialog-cancel');
    const saveBtn = dialog.querySelector('.github-dialog-save');

    const closeDialog = () => dialog.remove();

    closeBtn.addEventListener('click', closeDialog);
    cancelBtn.addEventListener('click', closeDialog);
    dialog.addEventListener('click', (e) => { if (e.target === dialog) closeDialog(); });

    saveBtn.addEventListener('click', () => {
      const url = urlInput.value.trim();
      const accountType = accountTypeSelect.value;
      const displayType = displayTypeSelect.value;

      if (!url) {
        alert('Please enter a GitHub URL');
        return;
      }

      // Extract name from URL based on account type
      let name;
      if (accountType === 'repo') {
        // For repos: https://github.com/user/repo
        const match = url.match(/github\.com\/([^\/]+\/[^\/]+)/);
        if (!match) {
          alert('Invalid GitHub repository URL. Please use format: https://github.com/user/repo');
          return;
        }
        name = match[1];
      } else {
        // For users/orgs: https://github.com/username
        const match = url.match(/github\.com\/([^\/]+)/);
        if (!match) {
          alert('Invalid GitHub URL. Please use format: https://github.com/username');
          return;
        }
        name = match[1];
      }

      if (isNew) {
        githubModules.push({
          id: 'github-' + Date.now(),
          accountType: accountType,
          displayType: displayType,
          name: name,
          url: url,
          enabled: true
        });
      } else {
        githubModules[index].name = name;
        githubModules[index].accountType = accountType;
        githubModules[index].displayType = displayType;
        githubModules[index].url = url;
        delete githubModules[index].type; // Remove legacy field
      }

      saveGitHubModules();
      renderGitHubModuleList();
      renderGitHubModules();
      refreshGitHub();
      closeDialog();
    });
  }

  // Add GitHub button
  document.getElementById('addGitHubBtn').addEventListener('click', () => {
    showGitHubEditDialog(-1);
  });

  // Render GitHub module list when modal opens
  const prefsBtn = document.getElementById('prefsBtn');
  if (prefsBtn) {
    prefsBtn.addEventListener('click', () => {
      renderGitHubModuleList();
      renderQuicklinksList();
    });
  }
})();

// RSS modules management
(function() {
  // Default RSS modules
  const defaultRssModules = [];

  // Load RSS modules from localStorage
  let rssModules = [];
  try {
    const saved = localStorage.getItem('rssModules');
    if (saved) {
      rssModules = JSON.parse(saved);
    } else {
      rssModules = defaultRssModules;
    }
  } catch (e) {
    rssModules = defaultRssModules;
  }

  function saveRssModules() {
    localStorage.setItem('rssModules', JSON.stringify(rssModules));
  }

  // RSS feed cache functions
  function getRssCache() {
    try {
      const cache = localStorage.getItem('rssFeedCache');
      return cache ? JSON.parse(cache) : {};
    } catch (e) {
      return {};
    }
  }

  function saveRssCache(cache) {
    try {
      localStorage.setItem('rssFeedCache', JSON.stringify(cache));
    } catch (e) {
      console.error('Error saving RSS cache:', e);
    }
  }

  function getCachedFeed(moduleId) {
    const cache = getRssCache();
    const cached = cache[moduleId];
    if (cached) {
      // Cache expires after 10 minutes
      const cacheAge = Date.now() - cached.timestamp;
      const maxAge = 10 * 60 * 1000; // 10 minutes
      if (cacheAge < maxAge) {
        return cached.data;
      }
      // Cache expired, remove it
      delete cache[moduleId];
      saveRssCache(cache);
    }
    return null;
  }

  function setCachedFeed(moduleId, data) {
    const cache = getRssCache();
    cache[moduleId] = {
      data: data,
      timestamp: Date.now()
    };
    saveRssCache(cache);
  }

  function renderRssContent(moduleId, items) {
    const contentEl = document.getElementById(`rss-content-${moduleId}`);
    if (!contentEl) return;

    if (!items || items.length === 0) {
      contentEl.innerHTML = '<div class="muted">No items found</div>';
      return;
    }

    let html = '';
    items.forEach(item => {
      const dateHtml = item.pubDate ? `<div class="muted" style="font-size:0.85em; margin-top:4px;">${item.pubDate}</div>` : '';
      html += `
        <div style="margin-bottom:16px; padding-bottom:16px; border-bottom:1px solid var(--border);">
          <div style="font-weight:600; margin-bottom:8px;"><a href="${item.link}" target="_blank" rel="noreferrer" style="color:var(--txt); text-decoration:none;">${item.title || 'Untitled'}</a></div>
          <div style="color:var(--muted); font-size:0.9em; line-height:1.5; white-space:pre-wrap;">${item.description || ''}</div>
          ${dateHtml}
        </div>
      `;
    });
    contentEl.innerHTML = html;
  }

  function renderRssModules() {
    const container = document.getElementById('rssModulesContainer');
    if (!container) return;
    container.innerHTML = '';

    // Get layout config to check which modules are already in the layout
    const layoutConfig = window.layoutSystem ? window.layoutSystem.getLayoutConfig() : null;
    const modulesInLayout = new Set();
    if (layoutConfig) {
      layoutConfig.rows.forEach(row => {
        row.modules.forEach(moduleId => {
          if (moduleId && moduleId.startsWith('rss-')) {
            modulesInLayout.add(moduleId);
          }
        });
      });
    }

    rssModules.forEach((mod, index) => {
      if (!mod.enabled) return;
      // Skip modules that are already in the layout grid
      if (modulesInLayout.has(mod.id)) return;

      const card = document.createElement('div');
      card.className = 'card span-6';
      card.setAttribute('data-module', mod.id);
      card.setAttribute('draggable', 'true');

      const hasTimer = index === 0; // Only first RSS module has the timer
      const timerHtml = hasTimer ? '<div class="timer-circle" id="rssTimer" title="Double-click to refresh"></div>' : '';

      card.innerHTML = `
        <h3><i class="fas fa-rss"></i> ${mod.name || 'RSS Feed'}<div class="header-icons"><a href="${mod.url}" target="_blank" rel="noreferrer"><i class="fas fa-external-link-alt"></i></a>${timerHtml}<i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div id="rss-content-${mod.id}">Loading...</div>
      `;
      container.appendChild(card);

      // Load cached data immediately if available
      const cachedData = getCachedFeed(mod.id);
      if (cachedData) {
        renderRssContent(mod.id, cachedData);
      }
    });

    // Initialize drag and drop for RSS modules
    if (window.initDragAndDrop) {
      setTimeout(() => window.initDragAndDrop(), 50);
    }

    // Refresh all RSS modules (will update cache)
    refreshRss();
  }

  async function refreshRssModule(mod) {
    try {
      const res = await fetch(`/api/rss?url=${encodeURIComponent(mod.url)}`, {cache: "no-store"});
      const j = await res.json();

      const contentEl = document.getElementById(`rss-content-${mod.id}`);
      if (!contentEl) return;

      if (j.error) {
        contentEl.innerHTML = `<div class="error">Error: ${j.error}</div>`;
        return;
      }

      if (!j.items || j.items.length === 0) {
        contentEl.innerHTML = '<div class="muted">No items found</div>';
        return;
      }

      // Cache the feed data
      setCachedFeed(mod.id, j.items);

      // Render the content
      renderRssContent(mod.id, j.items);
    } catch(err) {
      const contentEl = document.getElementById(`rss-content-${mod.id}`);
      if (contentEl) {
        // Try to show cached data if available, otherwise show error
        const cachedData = getCachedFeed(mod.id);
        if (cachedData) {
          renderRssContent(mod.id, cachedData);
        } else {
          contentEl.innerHTML = `<div class="error">Error loading feed</div>`;
        }
      }
      console.error("Error refreshing RSS module:", err);
    }
  }

  async function refreshRss() {
    try {
      const promises = rssModules.filter(m => m.enabled).map(mod => refreshRssModule(mod));
      await Promise.all(promises);
      startTimer("rss");
    } catch(err) {
      console.error("Error refreshing RSS:", err);
    }
  }

  window.refreshRss = refreshRss;
  window.renderRssModules = renderRssModules;
  window.rssModules = rssModules;

  // Render RSS module list
  function renderRssModuleList() {
    const list = document.getElementById('rssModuleList');
    if (!list) return;
    list.innerHTML = '';

    rssModules.forEach((mod, index) => {
      const item = document.createElement('div');
      item.className = 'module-item' + (mod.enabled ? '' : ' disabled');
      item.innerHTML = `
        <div class="module-icon"><i class="fas fa-rss"></i></div>
        <div class="module-info">
          <div class="module-name">${mod.name || 'RSS Feed'}</div>
          <div class="module-desc">${mod.url || 'No URL'}</div>
        </div>
        <div class="module-controls">
          <button class="btn-small edit-rss-btn" data-index="${index}"><i class="fas fa-edit"></i></button>
          <button class="btn-small delete-rss-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
          <input type="checkbox" ${mod.enabled ? 'checked' : ''} data-index="${index}" title="Enable/disable">
        </div>
      `;
      list.appendChild(item);

      // Enable/disable handler
      const checkbox = item.querySelector('input[type="checkbox"]');
      checkbox.addEventListener('change', () => {
        rssModules[index].enabled = checkbox.checked;
        item.classList.toggle('disabled', !checkbox.checked);
        saveRssModules();
        renderRssModules();
      });

      // Edit button
      const editBtn = item.querySelector('.edit-rss-btn');
      editBtn.addEventListener('click', () => {
        showRssEditDialog(index);
      });

      // Delete button
      const deleteBtn = item.querySelector('.delete-rss-btn');
      deleteBtn.addEventListener('click', () => {
        if (confirm(`Delete RSS module "${mod.name || 'RSS Feed'}"?`)) {
          rssModules.splice(index, 1);
          saveRssModules();
          renderRssModuleList();
          renderRssModules();
        }
      });
    });
  }

  function showRssEditDialog(index) {
    const mod = index >= 0 ? rssModules[index] : { id: 'rss-' + Date.now(), name: '', url: '', enabled: true };
    const isNew = index < 0;

    const dialog = document.createElement('div');
    dialog.className = 'modal-overlay active';
    dialog.innerHTML = `
      <div class="modal" style="max-width:500px;">
        <div class="modal-header">
          <h2><i class="fas fa-rss"></i> ${isNew ? 'Add' : 'Edit'} RSS Module</h2>
          <button class="modal-close rss-dialog-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-content">
          <div class="pref-section">
            <div class="pref-row">
              <label>Name</label>
              <input type="text" id="rss-edit-name" placeholder="RSS Feed Name" value="${mod.name || ''}">
            </div>
            <div class="pref-row">
              <label>RSS Feed URL</label>
              <input type="text" id="rss-edit-url" placeholder="https://example.com/feed.xml" value="${mod.url || ''}">
            </div>
          </div>
          <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn-small rss-dialog-close">Cancel</button>
            <button class="btn-small" id="rss-save">Save</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(dialog);

    function closeDialog() {
      dialog.remove();
    }

    dialog.querySelectorAll('.rss-dialog-close').forEach(btn => {
      btn.addEventListener('click', closeDialog);
    });

    document.getElementById('rss-save').addEventListener('click', () => {
      const name = document.getElementById('rss-edit-name').value.trim();
      const url = document.getElementById('rss-edit-url').value.trim();

      if (!url) {
        alert('RSS Feed URL is required');
        return;
      }

      if (isNew) {
        rssModules.push({
          id: 'rss-' + Date.now(),
          name: name || 'RSS Feed',
          url: url,
          enabled: true
        });
      } else {
        rssModules[index].name = name || 'RSS Feed';
        rssModules[index].url = url;
      }

      saveRssModules();
      window.rssModules = rssModules; // Update global reference
      renderRssModuleList();
      renderRssModules();
      refreshRss();
      closeDialog();
    });
  }

  // Add RSS button
  document.getElementById('addRssBtn').addEventListener('click', () => {
    showRssEditDialog(-1);
  });

  // Render RSS module list when modal opens
  const prefsBtn = document.getElementById('prefsBtn');
  if (prefsBtn) {
    prefsBtn.addEventListener('click', () => {
      renderRssModuleList();
    });
  }

  // Initial render
  renderRssModules();
})();

// Quicklinks management
(function() {
  // Default quicklinks
  const defaultQuicklinks = [
    { id: 'ql-1', title: 'Router', url: 'http://192.168.1.1', icon: 'fa-network-wired' }
  ];

  // Load quicklinks from localStorage
  let quicklinks = [];
  try {
    const saved = localStorage.getItem('quicklinks');
    if (saved) {
      quicklinks = JSON.parse(saved);
    } else {
      quicklinks = defaultQuicklinks;
    }
  } catch (e) {
    quicklinks = defaultQuicklinks;
  }

  // Load layout preference
  let quicklinksLayout = 1;
  try {
    const savedLayout = localStorage.getItem('quicklinksLayout');
    if (savedLayout) {
      quicklinksLayout = parseInt(savedLayout) || 1;
    }
  } catch (e) {}

  function saveQuicklinks() {
    try {
      localStorage.setItem('quicklinks', JSON.stringify(quicklinks));
    } catch (e) {}
  }

  function saveLayout(cols) {
    quicklinksLayout = cols;
    try {
      localStorage.setItem('quicklinksLayout', cols.toString());
    } catch (e) {}
  }

  // Update layout button states
  function updateLayoutButtons() {
    const buttons = document.querySelectorAll('.layout-btn');
    buttons.forEach(btn => {
      const cols = parseInt(btn.dataset.cols);
      btn.classList.toggle('active', cols === quicklinksLayout);
    });
  }

// Favicon cache in localStorage
  function getFaviconCache() {
    try {
      const cache = localStorage.getItem('faviconCache');
      return cache ? JSON.parse(cache) : {};
    } catch (e) {
      return {};
    }
  }

  function saveFaviconCache(cache) {
    try {
      localStorage.setItem('faviconCache', JSON.stringify(cache));
    } catch (e) {}
  }

  async function fetchAndCacheFavicon(url) {
    const cache = getFaviconCache();

    // Check if already cached (cache for 7 days)
    const cacheKey = new URL(url).origin;
    if (cache[cacheKey] && cache[cacheKey].expires > Date.now()) {
      return cache[cacheKey].data;
    }

    try {
      const res = await fetch('/api/favicon?url=' + encodeURIComponent(url));
      const data = await res.json();

      if (data.favicon) {
        // Cache for 7 days
        cache[cacheKey] = {
          data: data.favicon,
          expires: Date.now() + (7 * 24 * 60 * 60 * 1000)
        };
        saveFaviconCache(cache);
        return data.favicon;
      }
    } catch (e) {
      console.error('Error fetching favicon:', e);
    }

    return null;
  }

  // Render quicklinks in the card
  window.renderQuicklinks = function() {
    const container = document.getElementById('quicklinksContainer');
    if (!container) return;

    if (quicklinks.length === 0) {
      container.innerHTML = '<div class="small" style="color:var(--muted);">Add links in Preferences → Quicklinks</div>';
      return;
    }

    container.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'quicklinks-grid cols-' + quicklinksLayout;

    quicklinks.forEach(link => {
      const item = document.createElement('div');
      item.className = 'ql-item';

      const a = document.createElement('a');
      a.href = link.url;
      a.target = '_blank';
      a.rel = 'noreferrer';

      if (link.icon) {
        a.innerHTML = '<span class="ql-icon"><i class="fas ' + link.icon + '"></i></span><span class="ql-title">' + link.title + '</span>';
      } else {
        // Check favicon cache first
        const cache = getFaviconCache();
        try {
          const cacheKey = new URL(link.url).origin;
          if (cache[cacheKey] && cache[cacheKey].expires > Date.now()) {
            a.innerHTML = '<span class="ql-icon"><img src="' + cache[cacheKey].data + '" width="14" height="14"></span><span class="ql-title">' + link.title + '</span>';
          } else {
            // Show loading placeholder, then fetch
            const iconSpan = document.createElement('span');
            iconSpan.className = 'ql-icon';
            iconSpan.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const titleSpan = document.createElement('span');
            titleSpan.className = 'ql-title';
            titleSpan.textContent = link.title;
            a.appendChild(iconSpan);
            a.appendChild(titleSpan);

            // Fetch favicon in background
            fetchAndCacheFavicon(link.url).then(favicon => {
              if (favicon) {
                iconSpan.innerHTML = '<img src="' + favicon + '" width="14" height="14">';
              } else {
                iconSpan.innerHTML = '<i class="fas fa-link"></i>';
              }
            });
          }
        } catch (e) {
          a.innerHTML = '<span class="ql-icon"><i class="fas fa-link"></i></span><span class="ql-title">' + link.title + '</span>';
        }
      }

      item.appendChild(a);
      grid.appendChild(item);
    });

    container.appendChild(grid);
  };

  // Layout button handlers
  document.querySelectorAll('.layout-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const cols = parseInt(btn.dataset.cols);
      saveLayout(cols);
      updateLayoutButtons();
      renderQuicklinks();
    });
  });

  // Initialize layout buttons on modal open
  const prefsModal = document.getElementById('prefsModal');
  const observer = new MutationObserver(() => {
    if (prefsModal.classList.contains('active')) {
      updateLayoutButtons();
    }
  });
  observer.observe(prefsModal, { attributes: true, attributeFilter: ['class'] });

  // Render quicklinks list in preferences
  window.renderQuicklinksList = function() {
    const list = document.getElementById('quicklinksList');
    if (!list) return;
    list.innerHTML = '';

    if (quicklinks.length === 0) {
      list.innerHTML = '<div class="small" style="color:var(--muted);padding:10px;">No quicklinks yet. Click "Add" to create one.</div>';
      return;
    }

    quicklinks.forEach((link, index) => {
      const item = document.createElement('div');
      item.className = 'module-item';
      item.innerHTML = `
        <div class="module-icon"><i class="fas ${link.icon || 'fa-link'}"></i></div>
        <div class="module-info">
          <div class="module-name">${link.title}</div>
          <div class="module-desc">${link.url}</div>
        </div>
        <div class="module-controls">
          <button class="btn-small edit-ql-btn" data-index="${index}"><i class="fas fa-edit"></i></button>
          <button class="btn-small delete-ql-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
        </div>
      `;
      list.appendChild(item);

      // Edit button
      item.querySelector('.edit-ql-btn').addEventListener('click', () => {
        editQuicklink(index);
      });

      // Delete button
      item.querySelector('.delete-ql-btn').addEventListener('click', () => {
        if (confirm('Delete quicklink "' + link.title + '"?')) {
          quicklinks.splice(index, 1);
          saveQuicklinks();
          renderQuicklinksList();
          renderQuicklinks();
        }
      });
    });
  };

  // Form elements
  const form = document.getElementById('quicklinkForm');
  const titleInput = document.getElementById('ql-title');
  const urlInput = document.getElementById('ql-url');
  const iconSelect = document.getElementById('ql-icon');
  const clearIconBtn = document.getElementById('ql-clear-icon');
  const cancelBtn = document.getElementById('ql-cancel');
  const saveBtn = document.getElementById('ql-save');
  const addBtn = document.getElementById('addQuicklinkBtn');

  let editingIndex = -1;

  function showForm() {
    form.style.display = 'block';
  }

  function hideForm() {
    form.style.display = 'none';
    titleInput.value = '';
    urlInput.value = '';
    iconSelect.value = '';
    editingIndex = -1;
  }

  function editQuicklink(index) {
    editingIndex = index;
    const link = quicklinks[index];
    titleInput.value = link.title;
    urlInput.value = link.url;
    iconSelect.value = link.icon || '';
    showForm();
  }

  addBtn.addEventListener('click', () => {
    editingIndex = -1;
    titleInput.value = '';
    urlInput.value = '';
    iconSelect.value = '';
    showForm();
  });

  clearIconBtn.addEventListener('click', () => {
    iconSelect.value = '';
  });

  cancelBtn.addEventListener('click', hideForm);

  saveBtn.addEventListener('click', () => {
    const title = titleInput.value.trim();
    const url = urlInput.value.trim();
    const icon = iconSelect.value;

    if (!title) {
      alert('Please enter a title');
      return;
    }
    if (!url) {
      alert('Please enter a URL');
      return;
    }

    // Validate URL
    try {
      new URL(url);
    } catch (e) {
      alert('Please enter a valid URL (include http:// or https://)');
      return;
    }

    if (editingIndex >= 0) {
      quicklinks[editingIndex] = {
        id: quicklinks[editingIndex].id,
        title: title,
        url: url,
        icon: icon || ''
      };
    } else {
      quicklinks.push({
        id: 'ql-' + Date.now(),
        title: title,
        url: url,
        icon: icon || ''
      });
    }

    saveQuicklinks();
    renderQuicklinksList();
    renderQuicklinks();
    hideForm();
  });

  // Initial render
  renderQuicklinks();
})();

// Monitoring management
(function() {
  // Default monitors
  const defaultMonitors = [];

  // Load monitors from localStorage
  let monitors = [];
  try {
    const saved = localStorage.getItem('monitors');
    if (saved) {
      monitors = JSON.parse(saved);
    } else {
      monitors = defaultMonitors;
    }
  } catch (e) {
    monitors = defaultMonitors;
  }

  // Load interval preference
  try {
    const savedInterval = localStorage.getItem('monitorInterval');
    if (savedInterval) {
      timers.monitoring.interval = parseInt(savedInterval) * 1000;
    }
  } catch (e) {}

  function saveMonitors() {
    try {
      localStorage.setItem('monitors', JSON.stringify(monitors));
    } catch (e) {}
  }

  function saveMonitorInterval(seconds) {
    try {
      localStorage.setItem('monitorInterval', seconds.toString());
      timers.monitoring.interval = seconds * 1000;
    } catch (e) {}
  }

  // Track when monitors went down
  const monitorDownSince = {};

  // Format time since (e.g., "2m 30s", "1h 15m", "3d 2h")
  function formatTimeSince(ms) {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (days > 0) {
      const remainingHours = hours % 24;
      return days + 'd' + (remainingHours > 0 ? ' ' + remainingHours + 'h' : '');
    } else if (hours > 0) {
      const remainingMinutes = minutes % 60;
      return hours + 'h' + (remainingMinutes > 0 ? ' ' + remainingMinutes + 'm' : '');
    } else if (minutes > 0) {
      const remainingSeconds = seconds % 60;
      return minutes + 'm' + (remainingSeconds > 0 ? ' ' + remainingSeconds + 's' : '');
    } else {
      return seconds + 's';
    }
  }

// Render monitors in the card
  window.renderMonitors = function() {
    const container = document.getElementById('monitoringContainer');
    if (!container) return;

    if (monitors.length === 0) {
      container.innerHTML = '<div class="small" style="color:var(--muted);">Add services in Preferences → Monitoring</div>';
      return;
    }

    container.innerHTML = '';
    monitors.forEach((mon, index) => {
      const row = document.createElement('div');
      row.className = 'kv monitor-row';
      row.dataset.index = index;

      const k = document.createElement('div');
      k.className = 'k';
      // Status icon, SSL icon (for HTTPS), then name
      const isHttps = mon.type === 'http' && mon.url && mon.url.startsWith('https://');
      const sslIconHtml = isHttps ? '<span class="ssl-status" id="mon-ssl-' + index + '" style="margin-left:4px;"></span>' : '';
      k.innerHTML = '<span class="monitor-status" id="mon-status-' + index + '"><i class="fas fa-circle" style="color:var(--muted);"></i></span>' + sslIconHtml + ' ' + mon.name;

      const v = document.createElement('div');
      v.className = 'v mono';
      v.id = 'mon-result-' + index;
      v.textContent = '—';

      row.appendChild(k);
      row.appendChild(v);
      container.appendChild(row);
    });
  };

// Check a single monitor
  async function checkMonitor(mon, index) {
    const statusEl = document.getElementById('mon-status-' + index);
    const resultEl = document.getElementById('mon-result-' + index);
    const sslEl = document.getElementById('mon-ssl-' + index);

    if (!statusEl || !resultEl) return;

    statusEl.innerHTML = '<i class="fas fa-spinner fa-spin" style="color:var(--accent);"></i>';

    try {
      let url = '/api/monitor?type=' + mon.type;
      if (mon.type === 'http') {
        url += '&url=' + encodeURIComponent(mon.url);
      } else if (mon.type === 'port') {
        url += '&host=' + encodeURIComponent(mon.host) + '&port=' + mon.port;
      } else if (mon.type === 'ping') {
        url += '&host=' + encodeURIComponent(mon.host);
      }

      const res = await fetch(url, {cache: 'no-store'});
      const data = await res.json();

      if (data.success) {
        // Monitor is up - clear down timestamp and show latency
        delete monitorDownSince[index];
        statusEl.innerHTML = '<i class="fas fa-check-circle" style="color:#a3be8c;"></i>';
        resultEl.textContent = data.latency ? data.latency + 'ms' : 'OK';
        resultEl.style.color = '';
      } else {
        // Monitor is down - track when it went down
        if (!monitorDownSince[index]) {
          monitorDownSince[index] = Date.now();
        }
        const timeSince = formatTimeSince(Date.now() - monitorDownSince[index]);
        statusEl.innerHTML = '<i class="fas fa-times-circle" style="color:#bf616a;"></i>';
        resultEl.textContent = timeSince;
        resultEl.style.color = '#bf616a';
      }

      // Update SSL icon for HTTPS
      if (sslEl) {
        if (data.sslExpiry) {
          const expiry = new Date(data.sslExpiry);
          const now = new Date();
          const daysUntilExpiry = Math.floor((expiry - now) / (1000 * 60 * 60 * 24));
          const expiryStr = expiry.toLocaleDateString() + ' (' + (daysUntilExpiry >= 0 ? daysUntilExpiry + ' days' : 'expired') + ')';

          let sslColor, sslIcon;
          if (daysUntilExpiry < 0) {
            sslColor = '#bf616a'; // Red - expired
            sslIcon = 'fa-lock-open';
          } else if (daysUntilExpiry < 15) {
            sslColor = '#ebcb8b'; // Yellow - expiring soon
            sslIcon = 'fa-lock';
          } else {
            sslColor = '#a3be8c'; // Green - valid
            sslIcon = 'fa-lock';
          }
          sslEl.innerHTML = '<i class="fas ' + sslIcon + '" style="color:' + sslColor + ';" title="SSL expires: ' + expiryStr + '"></i>';
        } else if (data.sslError) {
          sslEl.innerHTML = '<i class="fas fa-lock-open" style="color:#bf616a;" title="SSL error: ' + data.sslError + '"></i>';
        } else {
          sslEl.innerHTML = '';
        }
      }
    } catch (e) {
      // Network error - treat as down
      if (!monitorDownSince[index]) {
        monitorDownSince[index] = Date.now();
      }
      const timeSince = formatTimeSince(Date.now() - monitorDownSince[index]);
      statusEl.innerHTML = '<i class="fas fa-times-circle" style="color:#bf616a;"></i>';
      resultEl.textContent = timeSince;
      resultEl.style.color = '#bf616a';
      if (sslEl) sslEl.innerHTML = '';
    }
  }

  // Update display for down monitors (refresh the "since when" timer)
  function updateDownMonitorsDisplay() {
    Object.keys(monitorDownSince).forEach(index => {
      const resultEl = document.getElementById('mon-result-' + index);
      if (resultEl && monitorDownSince[index]) {
        const timeSince = formatTimeSince(Date.now() - monitorDownSince[index]);
        resultEl.textContent = timeSince;
      }
    });
  }

  // Refresh all monitors
  window.refreshMonitoring = async function() {
    for (let i = 0; i < monitors.length; i++) {
      await checkMonitor(monitors[i], i);
    }
    startTimer('monitoring');
  };

  // Render monitor list in preferences
  window.renderMonitorsList = function() {
    const list = document.getElementById('monitorsList');
    if (!list) return;
    list.innerHTML = '';

    if (monitors.length === 0) {
      list.innerHTML = '<div class="small" style="color:var(--muted);padding:10px;">No services yet. Click "Add" to create one.</div>';
      return;
    }

    monitors.forEach((mon, index) => {
      const typeLabels = { http: 'HTTP', port: 'Port', ping: 'Ping' };
      const typeIcons = { http: 'fa-globe', port: 'fa-plug', ping: 'fa-satellite-dish' };

      let desc = '';
      if (mon.type === 'http') desc = mon.url;
      else if (mon.type === 'port') desc = mon.host + ':' + mon.port;
      else if (mon.type === 'ping') desc = mon.host;

      const item = document.createElement('div');
      item.className = 'module-item';
      item.innerHTML = `
        <div class="module-icon"><i class="fas ${typeIcons[mon.type] || 'fa-heartbeat'}"></i></div>
        <div class="module-info">
          <div class="module-name">${mon.name}</div>
          <div class="module-desc">${typeLabels[mon.type] || mon.type} • ${desc}</div>
        </div>
        <div class="module-controls">
          <button class="btn-small edit-mon-btn" data-index="${index}"><i class="fas fa-edit"></i></button>
          <button class="btn-small delete-mon-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
        </div>
      `;
      list.appendChild(item);

      // Edit button
      item.querySelector('.edit-mon-btn').addEventListener('click', () => {
        editMonitor(index);
      });

      // Delete button
      item.querySelector('.delete-mon-btn').addEventListener('click', () => {
        if (confirm('Delete monitor "' + mon.name + '"?')) {
          delete monitorDownSince[index];
          monitors.splice(index, 1);
          saveMonitors();
          renderMonitorsList();
          renderMonitors();
        }
      });
    });
  };

  // Form elements
  const form = document.getElementById('monitorForm');
  const nameInput = document.getElementById('mon-name');
  const typeSelect = document.getElementById('mon-type');
  const urlInput = document.getElementById('mon-url');
  const hostInput = document.getElementById('mon-host');
  const portInput = document.getElementById('mon-port');
  const urlRow = document.getElementById('mon-url-row');
  const hostRow = document.getElementById('mon-host-row');
  const portRow = document.getElementById('mon-port-row');
  const cancelBtn = document.getElementById('mon-cancel');
  const saveBtn = document.getElementById('mon-save');
  const addBtn = document.getElementById('addMonitorBtn');
  const intervalInput = document.getElementById('monitor-interval');

  let editingIndex = -1;

  // Update form fields based on type
  function updateFormFields() {
    const type = typeSelect.value;
    if (type === 'http') {
      urlRow.style.display = 'flex';
      hostRow.style.display = 'none';
      portRow.style.display = 'none';
    } else if (type === 'port') {
      urlRow.style.display = 'none';
      hostRow.style.display = 'flex';
      portRow.style.display = 'flex';
    } else if (type === 'ping') {
      urlRow.style.display = 'none';
      hostRow.style.display = 'flex';
      portRow.style.display = 'none';
    }
  }

  typeSelect.addEventListener('change', updateFormFields);

  function showForm() {
    form.style.display = 'block';
    updateFormFields();
  }

  function hideForm() {
    form.style.display = 'none';
    nameInput.value = '';
    typeSelect.value = 'http';
    urlInput.value = '';
    hostInput.value = '';
    portInput.value = '';
    editingIndex = -1;
    updateFormFields();
  }

  function editMonitor(index) {
    editingIndex = index;
    const mon = monitors[index];
    nameInput.value = mon.name;
    typeSelect.value = mon.type;
    urlInput.value = mon.url || '';
    hostInput.value = mon.host || '';
    portInput.value = mon.port || '';
    showForm();
  }

  addBtn.addEventListener('click', () => {
    editingIndex = -1;
    nameInput.value = '';
    typeSelect.value = 'http';
    urlInput.value = '';
    hostInput.value = '';
    portInput.value = '';
    showForm();
  });

  cancelBtn.addEventListener('click', hideForm);

  saveBtn.addEventListener('click', () => {
    const name = nameInput.value.trim();
    const type = typeSelect.value;

    if (!name) {
      alert('Please enter a name');
      return;
    }

    let mon = { id: 'mon-' + Date.now(), name: name, type: type };

    if (type === 'http') {
      const url = urlInput.value.trim();
      if (!url) {
        alert('Please enter a URL');
        return;
      }
      mon.url = url;
    } else if (type === 'port') {
      const host = hostInput.value.trim();
      const port = parseInt(portInput.value);
      if (!host) {
        alert('Please enter a host');
        return;
      }
      if (!port || port < 1 || port > 65535) {
        alert('Please enter a valid port (1-65535)');
        return;
      }
      mon.host = host;
      mon.port = port;
    } else if (type === 'ping') {
      const host = hostInput.value.trim();
      if (!host) {
        alert('Please enter a host');
        return;
      }
      mon.host = host;
    }

    if (editingIndex >= 0) {
      mon.id = monitors[editingIndex].id;
      monitors[editingIndex] = mon;
    } else {
      monitors.push(mon);
    }

    saveMonitors();
    renderMonitorsList();
    renderMonitors();
    refreshMonitoring();
    hideForm();
  });

  // Interval input
  intervalInput.value = timers.monitoring.interval / 1000;
  intervalInput.addEventListener('change', () => {
    const val = Math.max(5, Math.min(3600, parseInt(intervalInput.value) || 60));
    intervalInput.value = val;
    saveMonitorInterval(val);
  });

  // Initialize on modal open
  const prefsModal = document.getElementById('prefsModal');
  const observer = new MutationObserver(() => {
    if (prefsModal.classList.contains('active')) {
      renderMonitorsList();
      intervalInput.value = timers.monitoring.interval / 1000;
    }
  });
  observer.observe(prefsModal, { attributes: true, attributeFilter: ['class'] });

// Initial render
  renderMonitors();

  // Initial check after a short delay
  setTimeout(function() {
    refreshMonitoring();
  }, 2000);

  // Set up monitoring interval
  setInterval(function() {
    refreshMonitoring();
  }, timers.monitoring.interval);

  // Update "since when" display every second for down monitors
  setInterval(function() {
    updateDownMonitorsDisplay();
  }, 1000);
})();

// SNMP Module
(function() {
  let snmpQueries = [];
  // Store last values and timestamps for diff calculations
  let snmpLastValues = {};

  function loadSnmpQueries() {
    try {
      const saved = localStorage.getItem('snmpQueries');
      if (saved) {
        snmpQueries = JSON.parse(saved);
      }
      // Load last values if available
      const savedLastValues = localStorage.getItem('snmpLastValues');
      if (savedLastValues) {
        snmpLastValues = JSON.parse(savedLastValues);
      }
    } catch (e) {}
  }

  function saveSnmpLastValues() {
    try {
      localStorage.setItem('snmpLastValues', JSON.stringify(snmpLastValues));
    } catch (e) {}
  }

  function saveSnmpQueries() {
    try {
      localStorage.setItem('snmpQueries', JSON.stringify(snmpQueries));
    } catch (e) {}
  }


  // Render SNMP queries in the card
  window.renderSnmpQueries = function() {
    const container = document.getElementById('snmpContainer');
    if (!container) return;

    if (snmpQueries.length === 0) {
      container.innerHTML = '<div class="small" style="color:var(--muted);">Add queries in Preferences → SNMP</div>';
      return;
    }

    container.innerHTML = '';
    snmpQueries.forEach((query, index) => {
      const row = document.createElement('div');
      row.className = 'kv';
      row.dataset.index = index;

      const k = document.createElement('div');
      k.className = 'k';
      k.innerHTML = '<span class="monitor-status" id="snmp-status-' + index + '"><i class="fas fa-circle" style="color:var(--muted);"></i></span> ' + escapeHtml(query.title);

      const v = document.createElement('div');
      v.className = 'v mono';
      v.id = 'snmp-value-' + index;
      v.textContent = '—';

      row.appendChild(k);
      row.appendChild(v);
      container.appendChild(row);
    });
  };

  // Render SNMP list in preferences
  function renderSnmpList() {
    const list = document.getElementById('snmpList');
    if (!list) return;

    list.innerHTML = '';
    snmpQueries.forEach((query, index) => {
      const item = document.createElement('div');
      item.className = 'module-item';
      item.innerHTML = `
        <div class="module-info">
          <div class="module-name">${escapeHtml(query.title)}</div>
          <div class="module-desc">${escapeHtml(query.host)}:${query.port} - ${escapeHtml(query.oid)}</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn-small" onclick="editSnmpQuery(${index})"><i class="fas fa-edit"></i> Edit</button>
          <button class="btn-small" onclick="deleteSnmpQuery(${index})" style="color:var(--error);"><i class="fas fa-trash"></i> Delete</button>
        </div>
      `;
      list.appendChild(item);
    });
  }

  window.editSnmpQuery = function(index) {
    const query = snmpQueries[index];
    document.getElementById('snmp-title').value = query.title || '';
    document.getElementById('snmp-host').value = query.host || '';
    document.getElementById('snmp-port').value = query.port || 161;
    document.getElementById('snmp-community').value = query.community || '';
    document.getElementById('snmp-oid').value = query.oid || '';
    document.getElementById('snmp-display-type').value = query.displayType || 'show';
    document.getElementById('snmp-prefix').value = query.prefix || '';
    document.getElementById('snmp-suffix').value = query.suffix || '';
    document.getElementById('snmp-si-units').checked = query.siUnits || false;
    updateDivisorOptions();
    document.getElementById('snmp-divisor').value = query.divisor || '1';
    document.getElementById('snmpForm').style.display = 'block';
    document.getElementById('snmpForm').dataset.editIndex = index;
  };

  window.deleteSnmpQuery = function(index) {
    if (confirm('Delete this SNMP query?')) {
      const query = snmpQueries[index];
      // Clean up last value for this query
      const queryKey = `${query.host}:${query.port}:${query.oid}`;
      delete snmpLastValues[queryKey];
      saveSnmpLastValues();

      snmpQueries.splice(index, 1);
      saveSnmpQueries();
      renderSnmpList();
      renderSnmpQueries();
    }
  };

  // Check a single SNMP query
  window.checkSnmpQuery = async function(query, index) {
    const statusEl = document.getElementById(`snmp-status-${index}`);
    const valueEl = document.getElementById(`snmp-value-${index}`);

    if (!statusEl || !valueEl) return;

    statusEl.innerHTML = '<i class="fas fa-spinner fa-spin" style="color:var(--accent);"></i>';

    try {
      const url = `/api/snmp?host=${encodeURIComponent(query.host)}&port=${encodeURIComponent(query.port)}&community=${encodeURIComponent(query.community)}&oid=${encodeURIComponent(query.oid)}`;
      const res = await fetch(url, {cache: "no-store"});
      const data = await res.json();

      if (data.success && data.value !== undefined) {
        statusEl.innerHTML = '<i class="fas fa-check-circle" style="color:#a3be8c;"></i>';

        const divisor = parseInt(query.divisor) || 1;
        const rawValue = parseFloat(data.value) || 0;
        const currentValue = rawValue / divisor; // Apply divisor to the value
        const displayType = query.displayType || 'show';
        const prefix = query.prefix || '';
        const suffix = query.suffix || '';

        let displayValue = '';

        if (displayType === 'show') {
          // Just show the value (already divided)
          displayValue = String(currentValue);
        } else if (displayType === 'diff' || displayType === 'period-diff') {
          // Calculate diff
          const queryKey = `${query.host}:${query.port}:${query.oid}`;
          const lastData = snmpLastValues[queryKey];

          if (lastData && lastData.value !== undefined) {
            const lastValue = parseFloat(lastData.value) || 0;
            const diff = currentValue - lastValue;

            if (displayType === 'diff') {
              // Show the difference
              displayValue = diff >= 0 ? '+' + diff : String(diff);
            } else {
              // Show period diff (diff per second) - use configured refresh interval
              const refreshIntervalSeconds = timers.snmp.interval / 1000;

              if (refreshIntervalSeconds > 0) {
                const periodDiff = diff / refreshIntervalSeconds;
                displayValue = periodDiff >= 0 ? '+' + periodDiff.toFixed(2) : periodDiff.toFixed(2);
              } else {
                displayValue = '0';
              }
            }
          } else {
            // No previous value, show 0 for diff/period-diff
            displayValue = '0';
          }

          // Always store current value and timestamp for next calculation
          snmpLastValues[queryKey] = {
            value: currentValue,
            timestamp: Date.now()
          };
          saveSnmpLastValues();
        } else {
          displayValue = String(data.value);
        }

        // Apply prefix and suffix
        const finalValue = prefix + displayValue + suffix;
        valueEl.textContent = finalValue;
        valueEl.style.color = '';
      } else {
        statusEl.innerHTML = '<i class="fas fa-times-circle" style="color:#bf616a;"></i>';
        valueEl.textContent = data.error || 'Error';
        valueEl.style.color = '#bf616a';
      }
    } catch (err) {
      statusEl.innerHTML = '<i class="fas fa-times-circle" style="color:#bf616a;"></i>';
      valueEl.textContent = 'Error: ' + err.message;
      valueEl.style.color = '#bf616a';
    }
  };

  // Refresh all SNMP queries
  window.refreshSnmp = function() {
    snmpQueries.forEach((query, index) => {
      checkSnmpQuery(query, index);
    });
    startTimer('snmp');
  };

  // Function to update divisor options based on SI units checkbox
  function updateDivisorOptions() {
    const siUnits = document.getElementById('snmp-si-units').checked;
    const divisorSelect = document.getElementById('snmp-divisor');
    const currentValue = divisorSelect.value;

    // Clear and rebuild options based on SI/binary mode
    divisorSelect.innerHTML = '';

    if (siUnits) {
      // SI units (base 1000): All original values with SI labels
      divisorSelect.innerHTML = `
        <option value="1">1</option>
        <option value="10">10</option>
        <option value="100">100</option>
        <option value="1000">1,000 (KB)</option>
        <option value="10000">10,000</option>
        <option value="100000">100,000</option>
        <option value="1000000">1,000,000 (MB)</option>
        <option value="1000000000">1,000,000,000 (GB)</option>
      `;
    } else {
      // Binary units (base 1024): Convert SI values to binary equivalents
      // 1000 -> 1024, 10000 -> 12500, 100000 -> 125000, 1000000 -> 1048576, 1000000000 -> 1073741824
      divisorSelect.innerHTML = `
        <option value="1">1</option>
        <option value="10">10</option>
        <option value="100">100</option>
        <option value="1024">1,024 (KiB)</option>
        <option value="12500">12,500</option>
        <option value="125000">125,000</option>
        <option value="1048576">1,048,576 (MiB)</option>
        <option value="1073741824">1,073,741,824 (GiB)</option>
      `;
    }

    // Try to restore the previous value if it exists in the new options
    const optionExists = Array.from(divisorSelect.options).some(opt => opt.value === currentValue);
    if (optionExists) {
      divisorSelect.value = currentValue;
    } else {
      divisorSelect.value = '1';
    }
  }

  // Add button
  document.getElementById('addSnmpBtn').addEventListener('click', () => {
    document.getElementById('snmp-title').value = '';
    document.getElementById('snmp-host').value = '';
    document.getElementById('snmp-port').value = '161';
    document.getElementById('snmp-community').value = 'public';
    document.getElementById('snmp-oid').value = '';
    document.getElementById('snmp-display-type').value = 'show';
    document.getElementById('snmp-prefix').value = '';
    document.getElementById('snmp-suffix').value = '';
    document.getElementById('snmp-divisor').value = '1';
    document.getElementById('snmp-si-units').checked = false;
    updateDivisorOptions();
    document.getElementById('snmpForm').style.display = 'block';
    delete document.getElementById('snmpForm').dataset.editIndex;
  });

  // SI units checkbox change handler
  document.getElementById('snmp-si-units').addEventListener('change', updateDivisorOptions);

  // Cancel button
  document.getElementById('snmp-cancel').addEventListener('click', () => {
    document.getElementById('snmpForm').style.display = 'none';
  });

  // Save button
  document.getElementById('snmp-save').addEventListener('click', () => {
    const title = document.getElementById('snmp-title').value.trim();
    const host = document.getElementById('snmp-host').value.trim();
    const port = parseInt(document.getElementById('snmp-port').value) || 161;
    const community = document.getElementById('snmp-community').value.trim();
    const oid = document.getElementById('snmp-oid').value.trim();
    const displayType = document.getElementById('snmp-display-type').value;
    const prefix = document.getElementById('snmp-prefix').value.trim();
    const suffix = document.getElementById('snmp-suffix').value.trim();
    const divisor = parseInt(document.getElementById('snmp-divisor').value) || 1;
    const siUnits = document.getElementById('snmp-si-units').checked;

    if (!title || !host || !community || !oid) {
      alert('Please fill in all required fields');
      return;
    }

    const editIndex = document.getElementById('snmpForm').dataset.editIndex;
    const query = { title, host, port, community, oid, displayType, prefix, suffix, divisor, siUnits };

    if (editIndex !== undefined) {
      // If editing, clear last value for this query to reset diff calculations
      const oldQuery = snmpQueries[parseInt(editIndex)];
      const oldKey = `${oldQuery.host}:${oldQuery.port}:${oldQuery.oid}`;
      delete snmpLastValues[oldKey];
      saveSnmpLastValues();

      snmpQueries[parseInt(editIndex)] = query;
    } else {
      snmpQueries.push(query);
    }

    saveSnmpQueries();
    renderSnmpList();
    renderSnmpQueries();
    document.getElementById('snmpForm').style.display = 'none';
  });

  // Initialize on modal open
  const prefsModal = document.getElementById('prefsModal');
  const observer = new MutationObserver(() => {
    if (prefsModal.classList.contains('active')) {
      renderSnmpList();
    }
  });
  observer.observe(prefsModal, { attributes: true, attributeFilter: ['class'] });

  // Initial render
  loadSnmpQueries();
  renderSnmpQueries();

  // Initial check after a short delay
  setTimeout(function() {
    refreshSnmp();
  }, 3000);

  // Set up SNMP interval
  setInterval(function() {
    refreshSnmp();
  }, timers.snmp.interval);
})();

// Set up intervals - each module refreshes independently
setInterval(refresh, 30000); // General refresh every 30s (server info only)
setInterval(refreshCPU, timers.cpu.interval);
setInterval(refreshRAM, timers.ram.interval);
setInterval(refreshDisk, timers.disk.interval);
setInterval(refreshGitHub, timers.github.interval);
setInterval(refreshWeather, timers.weather.interval);
setInterval(refreshIP, timers.ip.interval);
setInterval(() => { if (window.refreshRss) window.refreshRss(); }, timers.rss.interval);
// Note: monitoring interval is set up inside its own module

// Row-based Layout System
(function() {
  let layoutConfig = {
    maxWidth: 80,
    rows: []
  };

  // Load layout configuration
  function loadLayoutConfig() {
    try {
      const saved = localStorage.getItem('layoutConfig');
      if (saved) {
        layoutConfig = JSON.parse(saved);
      } else {
        // Default: create rows from existing modules
        initializeDefaultLayout();
      }
    } catch (e) {
      console.error('Failed to load layout config:', e);
      initializeDefaultLayout();
    }
  }

  // Initialize default layout from existing modules
  function initializeDefaultLayout() {
    const grid = document.getElementById('moduleGrid');
    if (!grid) return;

    const cards = Array.from(grid.querySelectorAll('.card[data-module]'));
    layoutConfig.rows = [];
    let currentRow = { cols: 3, modules: [] };

    cards.forEach((card, index) => {
      const moduleId = card.getAttribute('data-module');
      if (moduleId) {
        currentRow.modules.push(moduleId);
        // Create new row every 3 modules or if it's a span-6 module
        if (card.classList.contains('span-6') || currentRow.modules.length >= 3) {
          if (card.classList.contains('span-6')) {
            currentRow.cols = 2;
          }
          layoutConfig.rows.push(currentRow);
          currentRow = { cols: 3, modules: [] };
        }
      }
    });

    if (currentRow.modules.length > 0) {
      layoutConfig.rows.push(currentRow);
    }

    if (layoutConfig.rows.length === 0) {
      layoutConfig.rows = [{ cols: 3, modules: [] }];
    }
  }

  // Save layout configuration
  function saveLayoutConfig() {
    try {
      localStorage.setItem('layoutConfig', JSON.stringify(layoutConfig));
    } catch (e) {
      console.error('Failed to save layout config:', e);
    }
  }

  // Render the grid based on layout config
  function renderLayout() {
    const grid = document.getElementById('moduleGrid');
    if (!grid) return;

    // Collect all existing cards first (preserve them) from both moduleGrid, githubModulesContainer, and rssModulesContainer
    const gridCards = Array.from(grid.querySelectorAll('.card[data-module]'));
    const githubContainer = document.getElementById('githubModulesContainer');
    const githubCards = githubContainer ? Array.from(githubContainer.querySelectorAll('.card[data-module]')) : [];
    const rssContainer = document.getElementById('rssModulesContainer');
    const rssCards = rssContainer ? Array.from(rssContainer.querySelectorAll('.card[data-module]')) : [];
    const allCards = [...gridCards, ...githubCards, ...rssCards];
    const cardsMap = new Map();
    allCards.forEach(card => {
      const moduleId = card.getAttribute('data-module');
      if (moduleId) {
        cardsMap.set(moduleId, card);
      }
    });

    // Clear existing structure
    grid.innerHTML = '';
    grid.className = 'layout-grid';

    // Create rows
    layoutConfig.rows.forEach((row, rowIndex) => {
      const rowEl = document.createElement('div');
      rowEl.className = 'layout-row';
      rowEl.dataset.rowIndex = rowIndex;
      rowEl.style.gridTemplateColumns = `repeat(${row.cols}, 1fr)`;

      // Create columns
      for (let col = 0; col < row.cols; col++) {
        const colEl = document.createElement('div');
        colEl.className = 'layout-column';
        colEl.dataset.rowIndex = rowIndex;
        colEl.dataset.colIndex = col;

        // Add empty column indicator or module
        const moduleId = row.modules[col];
        if (!moduleId) {
          colEl.classList.add('empty-column');
          colEl.innerHTML = '<div class="empty-column-hint" style="display: none;">Drop module here</div>';
        } else {
          // Find and move module card
          const card = cardsMap.get(moduleId);
          if (card) {
            colEl.appendChild(card);
            cardsMap.delete(moduleId); // Remove from map so it's not added again
          } else {
            // Card not found, mark as empty
            colEl.classList.add('empty-column');
            colEl.innerHTML = '<div class="empty-column-hint" style="display: none;">Drop module here</div>';
          }
        }

        rowEl.appendChild(colEl);
      }

      grid.appendChild(rowEl);
    });

    // Add any remaining cards (not in layout config) to a new row
    if (cardsMap.size > 0) {
      const remainingModules = Array.from(cardsMap.keys());
      const newRow = { cols: 3, modules: [] };
      remainingModules.forEach((moduleId, idx) => {
        if (idx < 3) {
          newRow.modules.push(moduleId);
        }
      });
      while (newRow.modules.length < 3) {
        newRow.modules.push(null);
      }
      layoutConfig.rows.push(newRow);
      saveLayoutConfig();
      // Re-render with the new row
      setTimeout(() => renderLayout(), 0);
      return;
    }

    // Apply max width
    const mainContainer = document.getElementById('mainContainer');
    if (mainContainer) {
      mainContainer.style.maxWidth = layoutConfig.maxWidth + '%';
    }
  }

  // Get module name by ID
  function getModuleName(moduleId) {
    // Check regular modules
    if (moduleConfig[moduleId]) {
      return moduleConfig[moduleId].name;
    }
    // Check GitHub modules
    if (moduleId && moduleId.startsWith('github-')) {
      const githubModule = githubModules.find(m => m.id === moduleId);
      if (githubModule) {
        return githubModule.name;
      }
    }
    if (moduleId && moduleId.startsWith('rss-')) {
      if (window.rssModules) {
        const rssModule = window.rssModules.find(m => m.id === moduleId);
        if (rssModule) {
          return rssModule.name || 'RSS Feed';
        }
      }
    }
    return moduleId || 'Empty';
  }

  // Render layout editor
  function renderLayoutEditor() {
    const editor = document.getElementById('layoutEditor');
    if (!editor) return;

    editor.innerHTML = '';

    layoutConfig.rows.forEach((row, rowIndex) => {
      // Get module names for this row
      const moduleNames = row.modules
        .filter(m => m !== null)
        .map(m => getModuleName(m));
      const modulesText = moduleNames.length > 0
        ? moduleNames.join(', ')
        : '(empty)';

      const rowEditor = document.createElement('div');
      rowEditor.className = 'layout-row-editor';
      rowEditor.innerHTML = `
        <div class="layout-row-controls">
          <span>Row ${rowIndex + 1}</span>
          <select class="row-cols-select" data-row="${rowIndex}">
            <option value="1" ${row.cols === 1 ? 'selected' : ''}>1 Column</option>
            <option value="2" ${row.cols === 2 ? 'selected' : ''}>2 Columns</option>
            <option value="3" ${row.cols === 3 ? 'selected' : ''}>3 Columns</option>
          </select>
          <button class="btn-small remove-row-btn" data-row="${rowIndex}"><i class="fas fa-trash"></i></button>
          <span style="margin-left: auto; color: var(--muted); font-size: 13px;">${modulesText}</span>
        </div>
      `;

      // Column count change
      const colsSelect = rowEditor.querySelector('.row-cols-select');
      colsSelect.addEventListener('change', (e) => {
        const newCols = parseInt(e.target.value);
        layoutConfig.rows[rowIndex].cols = newCols;
        // Adjust modules array if needed
        if (layoutConfig.rows[rowIndex].modules.length > newCols) {
          layoutConfig.rows[rowIndex].modules = layoutConfig.rows[rowIndex].modules.slice(0, newCols);
        } else {
          while (layoutConfig.rows[rowIndex].modules.length < newCols) {
            layoutConfig.rows[rowIndex].modules.push(null);
          }
        }
        saveLayoutConfig();
        renderLayout();
        initDragAndDrop();
      });

      // Remove row
      const removeBtn = rowEditor.querySelector('.remove-row-btn');
      removeBtn.addEventListener('click', () => {
        // Move modules to previous row or remove
        const modules = layoutConfig.rows[rowIndex].modules.filter(m => m);
        if (modules.length > 0 && rowIndex > 0) {
          // Try to add to previous row
          const prevRow = layoutConfig.rows[rowIndex - 1];
          modules.forEach(m => {
            if (prevRow.modules.length < prevRow.cols) {
              prevRow.modules.push(m);
            }
          });
        }
        layoutConfig.rows.splice(rowIndex, 1);
        if (layoutConfig.rows.length === 0) {
          layoutConfig.rows = [{ cols: 3, modules: [] }];
        }
        saveLayoutConfig();
        renderLayout();
        renderLayoutEditor();
        initDragAndDrop();
      });

      editor.appendChild(rowEditor);
    });
  }

  // Add row button
  const addRowBtn = document.getElementById('addRowBtn');
  if (addRowBtn) {
    addRowBtn.addEventListener('click', () => {
      layoutConfig.rows.push({ cols: 3, modules: [] });
      saveLayoutConfig();
      renderLayout();
      renderLayoutEditor();
      initDragAndDrop();
    });
  }

  // Max width setting
  const maxWidthSelect = document.getElementById('layoutMaxWidth');
  if (maxWidthSelect) {
    maxWidthSelect.value = layoutConfig.maxWidth;
    maxWidthSelect.addEventListener('change', (e) => {
      layoutConfig.maxWidth = parseInt(e.target.value);
      saveLayoutConfig();
      renderLayout();
    });
  }

  // Initialize on page load
  window.addEventListener('DOMContentLoaded', function() {
    loadLayoutConfig();
    // Delay to ensure all modules are loaded
    setTimeout(() => {
      renderLayout();
      renderLayoutEditor();
    }, 100);
  });


  // Expose functions for drag and drop
  window.layoutSystem = {
    renderLayout,
    renderLayoutEditor,
    saveLayoutConfig,
    getLayoutConfig: () => layoutConfig
  };
})();

// Drag and drop module ordering
(function() {
  let draggedElement = null;
  let grid = null;

  // Load saved order from localStorage
  function loadModuleOrder() {
    if (!grid) return;
    const savedOrder = localStorage.getItem('moduleOrder');
    if (!savedOrder) return;

    try {
      const order = JSON.parse(savedOrder);
      const cards = Array.from(grid.querySelectorAll('.card[data-module]'));

      // Create a map of modules by their data-module attribute
      const moduleMap = new Map();
      cards.forEach(card => {
        const moduleId = card.getAttribute('data-module');
        if (moduleId) {
          moduleMap.set(moduleId, card);
        }
      });

      // Reorder based on saved order
      order.forEach(moduleId => {
        const card = moduleMap.get(moduleId);
        if (card) {
          grid.appendChild(card);
        }
      });
    } catch (e) {
      console.error('Failed to load module order:', e);
    }
  }

  // Save current order to localStorage
  function saveModuleOrder() {
    if (!grid) return;
    const cards = Array.from(grid.querySelectorAll('.card[data-module]'));
    const order = cards.map(card => card.getAttribute('data-module')).filter(Boolean);
    localStorage.setItem('moduleOrder', JSON.stringify(order));
  }

  // Helper function to find which column a card is in
  function findCardColumn(card) {
    let current = card.parentElement;
    while (current) {
      if (current.classList.contains('layout-column')) {
        return {
          rowIndex: parseInt(current.dataset.rowIndex),
          colIndex: parseInt(current.dataset.colIndex),
          column: current
        };
      }
      current = current.parentElement;
    }
    return null;
  }

  // Initialize drag and drop
  function initDragAndDrop() {
    if (!grid) {
      grid = document.getElementById('moduleGrid');
      if (!grid) return;
    }

    // Get cards from both moduleGrid, githubModulesContainer, and rssModulesContainer
    const gridCards = Array.from(grid.querySelectorAll('.card[data-module]'));
    const githubContainer = document.getElementById('githubModulesContainer');
    const githubCards = githubContainer ? Array.from(githubContainer.querySelectorAll('.card[data-module]')) : [];
    const rssContainer = document.getElementById('rssModulesContainer');
    const rssCards = rssContainer ? Array.from(rssContainer.querySelectorAll('.card[data-module]')) : [];
    const cards = [...gridCards, ...githubCards, ...rssCards];
    const columns = Array.from(grid.querySelectorAll('.layout-column'));

    // Setup card drag
    cards.forEach(card => {
      // Skip if already has drag listeners
      if (card.dataset.dragInitialized === 'true') return;
      card.dataset.dragInitialized = 'true';

      card.addEventListener('dragstart', function(e) {
        const target = e.target;
        if (target.classList.contains('drag-handle') || target.closest('.drag-handle')) {
          // Allow dragging when clicking on drag-handle
        } else if (target.classList.contains('timer-circle') ||
            target.closest('.timer-circle') ||
            target.tagName === 'A' ||
            target.closest('a') ||
            target.tagName === 'BUTTON' ||
            target.closest('button')) {
          e.preventDefault();
          return false;
        }

        draggedElement = this;
        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);

        // Show empty column hints when dragging starts
        const emptyColumns = grid.querySelectorAll('.layout-column.empty-column');
        emptyColumns.forEach(col => col.classList.add('dragging-active'));
      });

      card.addEventListener('dragend', function(e) {
        this.style.opacity = '1';
        // Remove drag-over styling from all cards and columns
        const allCards = Array.from(document.querySelectorAll('.card[data-module]'));
        const allColumns = Array.from(grid.querySelectorAll('.layout-column'));
        allCards.forEach(c => c.classList.remove('drag-over'));
        allColumns.forEach(c => {
          c.classList.remove('drag-over');
          c.classList.remove('dragging-active');
        });
        draggedElement = null;
      });

      card.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';

        if (draggedElement && this !== draggedElement) {
          this.classList.add('drag-over');
        }
        return false;
      });

      card.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
      });

      card.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('drag-over');

        if (draggedElement && this !== draggedElement) {
          const draggedModuleId = draggedElement.getAttribute('data-module');
          const targetModuleId = this.getAttribute('data-module');

          const draggedPos = findCardColumn(draggedElement);
          const targetPos = findCardColumn(this);

          const layoutConfig = window.layoutSystem.getLayoutConfig();

          if (draggedPos && targetPos) {
            // Both cards are in layout columns - swap them
            if (layoutConfig.rows[draggedPos.rowIndex] && layoutConfig.rows[targetPos.rowIndex]) {
              layoutConfig.rows[draggedPos.rowIndex].modules[draggedPos.colIndex] = targetModuleId;
              layoutConfig.rows[targetPos.rowIndex].modules[targetPos.colIndex] = draggedModuleId;

              window.layoutSystem.saveLayoutConfig();
              window.layoutSystem.renderLayout();
              setTimeout(() => window.initDragAndDrop(), 50);
            }
          } else if (!draggedPos && targetPos) {
            // Dragged card is not in layout (e.g., GitHub/RSS module in their containers), target is in layout
            // Swap: move dragged module to target's position, move target module to dragged position (or remove if GitHub/RSS)
            if (layoutConfig.rows[targetPos.rowIndex]) {
              const oldModuleId = layoutConfig.rows[targetPos.rowIndex].modules[targetPos.colIndex];
              layoutConfig.rows[targetPos.rowIndex].modules[targetPos.colIndex] = draggedModuleId;

              // If target was a GitHub/RSS module, it goes back to its container (handled by renderGitHubModules/renderRssModules)
              // If target was a regular module, we need to find it a new spot or leave it null
              // For now, just swap - the target module will be handled by renderLayout finding remaining cards

              window.layoutSystem.saveLayoutConfig();
              window.layoutSystem.renderLayout();
              setTimeout(() => window.initDragAndDrop(), 50);
            }
          } else if (draggedPos && !targetPos) {
            // Dragged card is in layout, target is not (e.g., GitHub/RSS module in their containers)
            // Swap: move dragged module out of layout, move target module to dragged position
            if (layoutConfig.rows[draggedPos.rowIndex]) {
              layoutConfig.rows[draggedPos.rowIndex].modules[draggedPos.colIndex] = targetModuleId;

              // Remove dragged module from any other positions in layout
              layoutConfig.rows.forEach((row, rowIdx) => {
                if (rowIdx !== draggedPos.rowIndex) {
                  const idx = row.modules.indexOf(draggedModuleId);
                  if (idx !== -1) {
                    row.modules[idx] = null;
                  }
                }
              });

              window.layoutSystem.saveLayoutConfig();
              window.layoutSystem.renderLayout();
              setTimeout(() => window.initDragAndDrop(), 50);
            }
          } else if (!draggedPos && !targetPos) {
            // Both cards are not in layout (both GitHub/RSS modules in their containers)
            // For now, just re-render modules to maintain order
            // In the future, we could implement reordering within the container
            if (window.renderGitHubModules) window.renderGitHubModules();
            if (window.renderRssModules) window.renderRssModules();
          }
        }

        return false;
      });
    });

    // Setup column drop zones
    columns.forEach(column => {
      column.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        if (draggedElement) {
          this.classList.add('drag-over');
        }
      });

      column.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
      });

      column.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (draggedElement) {
          const rowIndex = parseInt(this.dataset.rowIndex);
          const colIndex = parseInt(this.dataset.colIndex);
          const moduleId = draggedElement.getAttribute('data-module');

          // Check if this is a GitHub or RSS module that needs to be moved from their containers
          const githubContainer = document.getElementById('githubModulesContainer');
          const rssContainer = document.getElementById('rssModulesContainer');
          const isGitHubModule = moduleId && moduleId.startsWith('github-');
          const isRssModule = moduleId && moduleId.startsWith('rss-');
          const isInGitHubContainer = githubContainer && githubContainer.contains(draggedElement);
          const isInRssContainer = rssContainer && rssContainer.contains(draggedElement);

          // Remove from old position in layout config
          const layoutConfig = window.layoutSystem.getLayoutConfig();
          layoutConfig.rows.forEach(row => {
            const idx = row.modules.indexOf(moduleId);
            if (idx !== -1) {
              row.modules[idx] = null;
            }
          });

          // If there's a module in the target position, swap it
          if (layoutConfig.rows[rowIndex]) {
            const existingModuleId = layoutConfig.rows[rowIndex].modules[colIndex];
            layoutConfig.rows[rowIndex].modules[colIndex] = moduleId;

            // If there was an existing module and the dragged module was in layout, move existing to dragged position
            if (existingModuleId && !isInGitHubContainer && !isInRssContainer) {
              const draggedPos = findCardColumn(draggedElement);
              if (draggedPos && layoutConfig.rows[draggedPos.rowIndex]) {
                layoutConfig.rows[draggedPos.rowIndex].modules[draggedPos.colIndex] = existingModuleId;
              }
            }
          }

          window.layoutSystem.saveLayoutConfig();
          window.layoutSystem.renderLayout();
          setTimeout(() => window.initDragAndDrop(), 50);
        }

        this.classList.remove('drag-over');
        return false;
      });
    });

    // Prevent drag when clicking on timer circles
    const timerCircles = grid.querySelectorAll('.timer-circle');
    timerCircles.forEach(timer => {
      timer.addEventListener('mousedown', function(e) {
        e.stopPropagation();
      });
      timer.addEventListener('dragstart', function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      });
    });
  }

  // Load saved order on page load
  window.addEventListener('DOMContentLoaded', function() {
    grid = document.getElementById('moduleGrid');
    if (!grid) {
      console.error('moduleGrid not found');
      return;
    }
    loadModuleOrder();
    // Delay init to ensure all other handlers are set up first and cards are in final order
    setTimeout(initDragAndDrop, 200);
  });

  // Expose initDragAndDrop so it can be called after GitHub modules are rendered
  window.initDragAndDrop = initDragAndDrop;
})();
</script>
<style>
.card[data-module] {
  user-select: none;
}
.card h3 .header-icons {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 8px;
}
.card[data-module] .drag-handle {
  opacity: 0.3;
  cursor: grab;
  font-size: 12px;
  transition: opacity 0.2s ease;
  pointer-events: auto;
}
.card[data-module]:hover .drag-handle {
  opacity: 0.6;
}
.card[data-module] .drag-handle:active {
  cursor: grabbing;
  opacity: 0.8;
}
.card.drag-over {
  border-color: var(--accent) !important;
  box-shadow: 0 0 0 2px var(--accent) !important;
  transform: scale(1.02);
}
.card[data-module] .timer-circle {
  pointer-events: auto;
  flex-shrink: 0;
}
.card h3 .header-icons a {
  opacity: 0.7;
  transition: opacity 0.2s;
  display: flex;
  align-items: center;
}
.card h3 .header-icons a:hover {
  opacity: 1;
}
.ptr {
  color: var(--muted);
  font-size: 11px;
  margin-top: 2px;
  font-family: inherit;
}
.card[data-module="cpu"],
.card[data-module="ram"],
.card[data-module="disk"] {
  display: flex;
  flex-direction: column;
}
.cpu-graph,
.usage-graph {
  display: flex;
  align-items: flex-end;
  gap: 2px;
  height: 32px;
  width: 100%;
  margin-top: auto;
  background: rgba(0,0,0,0.1);
  border-radius: 4px;
  overflow: hidden;
  padding: 3px;
}
.cpu-graph .bar,
.usage-graph .bar {
  flex: 1;
  min-width: 0;
  background: var(--accent);
  border-radius: 2px;
  transition: height 0.3s ease;
  opacity: 0.8;
}
.cpu-graph .bar:last-child,
.usage-graph .bar:last-child {
  opacity: 1;
}
/* Full bars mode - show unused portion in dim color */
.full-bars .bar {
  --fill-pct: 0%;
  background: linear-gradient(
    to top,
    var(--accent) 0%,
    var(--accent) var(--fill-pct),
    rgba(255,255,255,0.08) var(--fill-pct),
    rgba(255,255,255,0.08) 100%
  );
}
.full-bars .bar:last-child {
  background: linear-gradient(
    to top,
    var(--accent) 0%,
    var(--accent) var(--fill-pct),
    rgba(255,255,255,0.12) var(--fill-pct),
    rgba(255,255,255,0.12) 100%
  );
}

/* Preferences Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  padding: 20px;
}
.modal-overlay.active {
  display: flex;
}
.modal {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  width: 80%;
  max-width: 80%;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}
.modal-header h2 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: var(--txt);
  display: flex;
  align-items: center;
  gap: 10px;
}
.modal-close {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 16px;
  padding: 5px;
  transition: color 0.2s;
}
.modal-close:hover {
  color: var(--txt);
}
.modal-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
}
.modal-tab {
  background: none;
  border: none;
  color: var(--muted);
  padding: 12px 16px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  border-bottom: 2px solid transparent;
  margin-bottom: -1px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}
.modal-tab:hover {
  color: var(--txt);
}
.modal-tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}
.modal-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
.pref-section {
  margin-bottom: 24px;
}
.pref-section:last-child {
  margin-bottom: 0;
}
.pref-section h3 {
  margin: 0 0 12px 0;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.pref-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}
.pref-row:last-child {
  border-bottom: none;
}
.pref-row label {
  color: var(--txt);
  font-size: 13px;
  font-weight: 500;
}
.pref-row select,
.pref-row input[type="number"] {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--txt);
  padding: 6px 10px;
  font-size: 13px;
  min-width: 140px;
}
.pref-row select:focus,
.pref-row input[type="number"]:focus {
  outline: none;
  border-color: var(--accent);
}
.btn-small {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--txt);
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}
.btn-small:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.location-input {
  display: flex;
  gap: 6px;
  align-items: center;
}
.location-input input[type="text"],
.location-input select {
  flex: 1;
  min-width: 150px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--txt);
  padding: 6px 10px;
  font-size: 13px;
}
.location-input input[type="text"]:focus,
.location-input select:focus {
  outline: none;
  border-color: var(--accent);
}
.location-display {
  color: var(--muted);
  font-size: 13px;
}
.icon-selector {
  display: flex;
  gap: 6px;
  align-items: center;
}
.icon-selector select {
  flex: 1;
  min-width: 150px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--txt);
  padding: 6px 10px;
  font-size: 13px;
}
.icon-selector select:focus {
  outline: none;
  border-color: var(--accent);
}

/* Row-based Layout System */
.layout-grid {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.layout-row {
  display: grid;
  gap: 16px;
  min-height: 100px;
}
.layout-column {
  min-height: 100px;
  position: relative;
}
.layout-column.empty-column {
  border: 1px solid transparent;
  border-radius: 8px;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  min-height: 100px;
}
.layout-column.empty-column.dragging-active {
  border: 2px dashed var(--border);
  background: var(--panel2);
}
.layout-column.empty-column.dragging-active:hover,
.layout-column.empty-column.drag-over {
  border-color: var(--accent);
  background: var(--panel);
}
.layout-column.drag-over {
  border-color: var(--accent) !important;
  background: var(--panel) !important;
}
.empty-column-hint {
  color: var(--muted);
  font-size: 13px;
  pointer-events: none;
}
.layout-column.empty-column.dragging-active .empty-column-hint {
  display: block !important;
}
.layout-column:not(.empty-column) .card {
  width: 100%;
  height: 100%;
}

/* Layout Editor */
.layout-row-editor {
  padding: 12px;
  background: var(--panel2);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 8px;
}
.layout-row-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}
.layout-row-controls span {
  min-width: 60px;
  font-weight: 500;
}
.layout-row-controls select {
  flex: 1;
  max-width: 150px;
}

/* Layout buttons */
.layout-buttons {
  display: flex;
  gap: 8px;
}
.layout-btn {
  width: 36px;
  height: 36px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--muted);
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.2s;
}
.layout-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.layout-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: var(--bg);
}

/* Quicklinks grid layouts */
.quicklinks-grid {
  display: grid;
  gap: 8px;
}
.quicklinks-grid.cols-1 {
  grid-template-columns: 1fr;
}
.quicklinks-grid.cols-2 {
  grid-template-columns: repeat(2, 1fr);
}
.quicklinks-grid.cols-3 {
  grid-template-columns: repeat(3, 1fr);
}
.quicklinks-grid .ql-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  background: var(--panel2);
  border-radius: 6px;
  border: 1px solid var(--border);
  transition: border-color 0.2s;
}
.quicklinks-grid .ql-item:hover {
  border-color: var(--accent);
}
.quicklinks-grid .ql-item a {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--txt);
  text-decoration: none;
  font-size: 13px;
  flex: 1;
  min-width: 0;
}
.quicklinks-grid .ql-item a:hover {
  color: var(--accent);
}
.quicklinks-grid .ql-item .ql-icon {
  color: var(--accent);
  font-size: 14px;
  flex-shrink: 0;
}
.quicklinks-grid .ql-item .ql-title {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Module List */
.module-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.module-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  transition: border-color 0.2s;
}
.module-item:hover {
  border-color: var(--accent);
}
.module-item .module-icon {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(var(--accent-rgb, 136,192,208), 0.1);
  border-radius: 6px;
  color: var(--accent);
  font-size: 14px;
}
.module-item .module-info {
  flex: 1;
  min-width: 0;
}
.module-item .module-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--txt);
}
.module-item .module-desc {
  font-size: 11px;
  color: var(--muted);
  margin-top: 2px;
}
.module-item .module-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}
.module-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--accent);
  cursor: pointer;
}
.module-item .refresh-control {
  display: flex;
  align-items: center;
  gap: 4px;
}
.module-item .refresh-control input[type="number"] {
  width: 60px;
  padding: 4px 6px;
  font-size: 12px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--txt);
  text-align: center;
}
.module-item .refresh-control input[type="number"]:focus {
  outline: none;
  border-color: var(--accent);
}
.module-item .refresh-control span {
  font-size: 11px;
  color: var(--muted);
}
.module-item .reset-btn {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 4px;
  font-size: 12px;
  transition: color 0.2s;
}
.module-item .reset-btn:hover {
  color: var(--accent);
}
.module-item.disabled {
  opacity: 0.5;
}
.module-item.disabled .module-controls .refresh-control {
  pointer-events: none;
}

/* About Tab */
.about-section {
  text-align: center;
  padding: 20px;
}
.about-logo {
  color: var(--accent);
  margin-bottom: 16px;
}
.about-section h3 {
  font-size: 18px;
  color: var(--txt);
  margin-bottom: 4px;
  text-transform: none;
  letter-spacing: 0;
}
.about-version {
  color: var(--muted);
  font-size: 12px;
  margin-bottom: 16px;
}
.about-desc {
  color: var(--txt);
  font-size: 13px;
  line-height: 1.6;
  margin-bottom: 20px;
}
.about-links {
  margin-bottom: 20px;
}
.about-links a {
  color: var(--accent);
  text-decoration: none;
  font-size: 13px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.about-links a:hover {
  text-decoration: underline;
}
.about-copyright {
  color: var(--muted);
  font-size: 11px;
}
</style>
</body>
</html>
