<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>{{.Title}}</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style id="theme-css">
{{.ThemeCSS}}
</style>
</head>
<body>
<script>
// Theme management
(function() {
  const savedTemplate = localStorage.getItem('template') || '{{.CurrentTemplate}}' || 'nordic';
  const savedScheme = localStorage.getItem('scheme') || '{{.CurrentScheme}}' || 'default';

  document.documentElement.setAttribute('data-template', savedTemplate);
  document.documentElement.setAttribute('data-scheme', savedScheme);

  // Hidden scheme menu for preferences modal to read from
  window.addEventListener('DOMContentLoaded', function() {
    const hiddenMenus = document.createElement('div');
    hiddenMenus.style.display = 'none';
    hiddenMenus.innerHTML = '<div id="schemeMenu">{{.SchemeMenuHTML}}</div>';
    document.body.appendChild(hiddenMenus);
  });
})();
</script>
  <div class="header">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="h-title">{{.Title}}</div>
        <div class="h-sub" id="subtitle">Loading…</div>
      </div>
    </div>

    <div class="search">
      <div class="searchbox">
        <input id="q" placeholder="Search…" autocomplete="off" />
        <div class="drop">
          <div class="pill" id="engineBtn">Google ▾</div>
          <div class="menu" id="engineMenu"></div>
        </div>
      </div>
      <div class="pill" id="goBtn">Go</div>
    </div>
  </div>

  <div class="main">
    <div class="grid" id="moduleGrid">
      <div class="card span-4" data-module="status" draggable="true">
        <h3><i class="fas fa-server"></i> Status<div class="header-icons"><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="badge"><span class="pulse"></span><span id="statusText">Online</span></div>
        <div class="kv"><div class="k">Host</div><div class="v mono" id="host">—</div></div>
        <div class="kv"><div class="k">Uptime</div><div class="v mono" id="uptime">—</div></div>
        <div class="kv"><div class="k">Server time</div><div class="v mono" id="time">—</div></div>
      </div>

      <div class="card span-4" data-module="network" draggable="true">
        <h3><i class="fas fa-network-wired"></i> Network<div class="header-icons"><div class="timer-circle" id="ipTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="kv"><div class="k">LAN IPs</div><div class="v mono"><span id="lanIps">—</span><div class="small ptr" id="lanPtr"></div></div></div>
        <div class="kv"><div class="k">Public IP</div><div class="v mono"><span id="pubIp">—</span><div class="small ptr" id="pubPtr"></div></div></div>
        <div class="small" id="pubIpErr"></div>
      </div>

      <div class="card span-4" data-module="weather" draggable="true">
        <h3><i class="fas fa-cloud-sun"></i> Weather <span class="dim" id="weatherLocation"></span><div class="header-icons"><div class="timer-circle" id="weatherTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="weather-row" id="weatherNow">
          <span class="weather-label">Now</span>
          <span class="weather-icon" id="weatherNowIcon">—</span>
          <span class="weather-data" id="weatherNowData">—</span>
        </div>
        <div class="weather-row" id="weatherToday">
          <span class="weather-label">Today</span>
          <span class="weather-icon" id="weatherTodayIcon">—</span>
          <span class="weather-data" id="weatherTodayData">—</span>
        </div>
        <div class="weather-row" id="weatherTomorrow">
          <span class="weather-label">Tomorrow</span>
          <span class="weather-icon" id="weatherTomorrowIcon">—</span>
          <span class="weather-data" id="weatherTomorrowData">—</span>
        </div>
        <div class="small" id="weatherErr"></div>
      </div>

      <div class="card span-4" data-module="cpu" draggable="true">
        <h3><i class="fas fa-microchip"></i> CPU<div class="header-icons"><div class="timer-circle" id="cpuTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="kv"><div class="k">Usage</div><div class="v" id="cpuUsage">—</div></div>
        <div class="small" id="cpuErr"></div>
        <div class="cpu-graph" id="cpuGraph"></div>
      </div>

      <div class="card span-4" data-module="ram" draggable="true">
        <h3><i class="fas fa-memory"></i> RAM<div class="header-icons"><div class="timer-circle" id="ramTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="kv"><div class="k">Total / Used / Free (GB)</div><div class="v mono" id="ramSummary">—</div></div>
        <div class="kv"><div class="k">Usage</div><div class="v" id="ramPercent">—</div></div>
        <div class="small" id="ramErr"></div>
        <div class="usage-graph" id="ramGraph"></div>
      </div>

      <div class="card span-4" data-module="disk" draggable="true">
        <h3><i class="fas fa-hdd"></i> Disk<div class="header-icons"><div class="timer-circle" id="diskTimer" title="Double-click to refresh"></div><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="kv"><div class="k">Total / Used / Free (GB)</div><div class="v mono" id="diskSummary">—</div></div>
        <div class="kv"><div class="k">Usage</div><div class="v" id="diskPercent">—</div></div>
        <div class="small" id="diskErr"></div>
        <div class="usage-graph" id="diskGraph"></div>
      </div>

      <div class="card span-6" data-module="links" draggable="true">
        <h3><i class="fas fa-link"></i> Quick Links<div class="header-icons"><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div id="quicklinksContainer">
          <div class="small" style="color:var(--muted);">Add links in Preferences → Quicklinks</div>
        </div>
      </div>

      <div class="card span-6" data-module="utilities" draggable="true">
        <h3><i class="fas fa-tools"></i> Utilities<div class="header-icons"><i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
        <div class="kv"><div class="k">Ping</div><div class="v"><span class="small">Add /api/ping later</span></div></div>
        <div class="kv"><div class="k">Wake-on-LAN</div><div class="v"><span class="small">Add /api/wol later</span></div></div>
        <div class="kv"><div class="k">Service checks</div><div class="v"><span class="small">Add /api/checks later</span></div></div>
      </div>

    </div>
    <!-- GitHub modules are dynamically rendered as siblings of grid cards -->
    <div id="githubModulesContainer" class="grid" style="margin-top: 12px;"></div>
  </div>

  <div class="footer">
    <div class="left">
      <div class="small">Shortcuts:</div>
      <div class="badge"><span class="mono">/</span><span class="small">focus search</span></div>
      <div class="badge"><span class="mono">Enter</span><span class="small">search</span></div>
      <div class="badge"><span class="mono">E</span><span class="small">engine</span></div>
    </div>
    <div class="right">
      <a class="btn" href="/api/summary" target="_blank" rel="noreferrer"><i class="fas fa-code"></i> API</a>
      <a class="btn" href="/healthz" target="_blank" rel="noreferrer"><i class="fas fa-heartbeat"></i> Health</a>
      <div class="btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</div>
      <div class="btn" id="prefsBtn"><i class="fas fa-cog"></i> Preferences</div>
    </div>
  </div>

  <!-- Preferences Modal -->
  <div class="modal-overlay" id="prefsModal">
    <div class="modal">
      <div class="modal-header">
        <h2><i class="fas fa-cog"></i> Preferences</h2>
        <button class="modal-close" id="prefsClose"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="general"><i class="fas fa-sliders-h"></i> General</button>
        <button class="modal-tab" data-tab="modules"><i class="fas fa-th-large"></i> Modules</button>
        <button class="modal-tab" data-tab="quicklinks"><i class="fas fa-link"></i> Quicklinks</button>
        <button class="modal-tab" data-tab="about"><i class="fas fa-info-circle"></i> About</button>
      </div>
      <div class="modal-content">
        <div class="tab-content active" id="tab-general">
          <div class="pref-section">
            <h3>Appearance</h3>
            <div class="pref-row">
              <label>Theme</label>
              <select id="pref-template">
                {{range .TemplatesList}}<option value="{{.}}">{{.}}</option>{{end}}
              </select>
            </div>
            <div class="pref-row">
              <label>Color Scheme</label>
              <select id="pref-scheme"></select>
            </div>
          </div>
          <div class="pref-section">
            <h3>Weather</h3>
            <div class="pref-row">
              <label>Location</label>
              <div class="location-input">
                <input type="text" id="pref-weather-location" placeholder="e.g., Athens, Greece">
                <button class="btn-small" id="searchLocationBtn"><i class="fas fa-search"></i></button>
              </div>
            </div>
            <div class="pref-row" id="locationResultsRow" style="display:none;">
              <label>Select</label>
              <div class="location-input">
                <select id="pref-location-results"></select>
                <button class="btn-small" id="setLocationBtn"><i class="fas fa-check"></i> Set</button>
              </div>
            </div>
            <div class="pref-row" id="currentLocationRow">
              <label>Current</label>
              <span class="location-display" id="currentLocationDisplay">Not set</span>
            </div>
          </div>
          <div class="pref-section">
            <h3>Graphs</h3>
            <div class="pref-row">
              <label>Show full bar height</label>
              <input type="checkbox" id="pref-full-bars" title="Show the unused portion of bars in a dimmed color">
            </div>
          </div>
          <div class="pref-section">
            <h3>Data</h3>
            <div class="pref-row">
              <label>Clear cached data</label>
              <button class="btn-small" id="clearCacheBtn"><i class="fas fa-trash"></i> Clear Cache</button>
            </div>
            <div class="pref-row">
              <label>Reset module order</label>
              <button class="btn-small" id="resetOrderBtn"><i class="fas fa-undo"></i> Reset Order</button>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-modules">
          <div class="pref-section">
            <h3>Module Settings</h3>
            <div class="module-list" id="moduleList"></div>
          </div>
          <div class="pref-section">
            <h3>GitHub Modules <button class="btn-small" id="addGitHubBtn"><i class="fas fa-plus"></i> Add</button></h3>
            <div class="module-list" id="githubModuleList"></div>
          </div>
        </div>
        <div class="tab-content" id="tab-quicklinks">
          <div class="pref-section">
            <h3>Layout</h3>
            <div class="layout-buttons">
              <button class="layout-btn" data-cols="1" title="1 link per row"><i class="fas fa-bars"></i></button>
              <button class="layout-btn" data-cols="2" title="2 links per row"><i class="fas fa-th-large"></i></button>
              <button class="layout-btn" data-cols="3" title="3 links per row"><i class="fas fa-th"></i></button>
            </div>
          </div>
          <div class="pref-section">
            <h3>Quick Links <button class="btn-small" id="addQuicklinkBtn"><i class="fas fa-plus"></i> Add</button></h3>
            <div class="module-list" id="quicklinksList"></div>
          </div>
          <div class="pref-section">
            <h3>Add / Edit Link</h3>
            <div id="quicklinkForm" style="display:none;">
              <div class="pref-row">
                <label>Title</label>
                <input type="text" id="ql-title" placeholder="e.g., Router">
              </div>
              <div class="pref-row">
                <label>URL</label>
                <input type="text" id="ql-url" placeholder="e.g., http://192.168.1.1">
              </div>
              <div class="pref-row">
                <label>Icon</label>
                <div class="icon-selector">
                  <select id="ql-icon">
                    <option value="">Use favicon</option>
                    <option value="fa-network-wired">Network</option>
                    <option value="fa-server">Server</option>
                    <option value="fa-hdd">Storage</option>
                    <option value="fa-database">Database</option>
                    <option value="fa-cloud">Cloud</option>
                    <option value="fa-home">Home</option>
                    <option value="fa-cog">Settings</option>
                    <option value="fa-chart-line">Charts</option>
                    <option value="fa-shield-alt">Security</option>
                    <option value="fa-video">Video</option>
                    <option value="fa-music">Music</option>
                    <option value="fa-book">Docs</option>
                    <option value="fa-code">Code</option>
                    <option value="fa-terminal">Terminal</option>
                    <option value="fa-download">Downloads</option>
                    <option value="fa-envelope">Mail</option>
                    <option value="fa-calendar">Calendar</option>
                    <option value="fa-globe">Web</option>
                    <option value="fa-wifi">WiFi</option>
                    <option value="fa-lock">Lock</option>
                  </select>
                  <button class="btn-small" id="ql-clear-icon" title="Clear icon selection"><i class="fas fa-times"></i></button>
                </div>
              </div>
              <div class="pref-row" style="justify-content:flex-end; gap:10px;">
                <button class="btn-small" id="ql-cancel">Cancel</button>
                <button class="btn-small" id="ql-save" style="background:var(--accent); color:var(--bg);"><i class="fas fa-check"></i> Save</button>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-about">
          <div class="pref-section about-section">
            <div class="about-logo"><i class="fas fa-home fa-3x"></i></div>
            <h3>Homepage Dashboard</h3>
            <p class="about-version">Version 1.0.0</p>
            <p class="about-desc">A personal dashboard for monitoring your system, weather, GitHub activity, and more.</p>
            <div class="about-links">
              <a href="https://github.com/Earentir/homepage" target="_blank" rel="noreferrer"><i class="fab fa-github"></i> Source Code</a>
            </div>
            <p class="about-copyright">© {{.Year}} Earentir</p>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const engines = [
  {name:"Google", url:"https://www.google.com/search?q=%s"},
  {name:"Perplexity", url:"https://www.perplexity.ai/search?q=%s"},
  {name:"DuckDuckGo", url:"https://duckduckgo.com/?q=%s"},
  {name:"Brave", url:"https://search.brave.com/search?q=%s"},
  {name:"Bing", url:"https://www.bing.com/search?q=%s"},
  {name:"Wikipedia", url:"https://en.wikipedia.org/wiki/Special:Search?search=%s"},
  {name:"GitHub", url:"https://github.com/search?q=%s"},
  {name:"Stack Overflow", url:"https://stackoverflow.com/search?q=%s"},
  {name:"YouTube", url:"https://www.youtube.com/results?search_query=%s"},
  {name:"Reddit", url:"https://www.reddit.com/search/?q=%s"},
];

let engine = engines[0];

const q = document.getElementById('q');
const engineBtn = document.getElementById('engineBtn');
const engineMenu = document.getElementById('engineMenu');

function renderEngines(){
  engineMenu.innerHTML = "";
  engines.forEach((e) => {
    const b = document.createElement('button');
    b.textContent = e.name;
    b.onclick = () => {
      engine = e;
      engineBtn.textContent = e.name + " ▾";
      engineMenu.style.display = "none";
      q.focus();
    };
    engineMenu.appendChild(b);
  });
}
renderEngines();

engineBtn.onclick = () => {
  engineMenu.style.display = (engineMenu.style.display === "block") ? "none" : "block";
};

document.addEventListener('click', (ev) => {
  if (!engineBtn.contains(ev.target) && !engineMenu.contains(ev.target)) {
    engineMenu.style.display = "none";
  }
});

function goSearch(){
  const term = (q.value || "").trim();
  if(!term) return;
  const u = engine.url.replace("%s", encodeURIComponent(term));
  window.open(u, "_blank", "noreferrer");
}

document.getElementById('goBtn').onclick = goSearch;
q.addEventListener('keydown', (e) => { if(e.key === "Enter") goSearch(); });

// Check if any modal is open
function isModalOpen() {
  const modals = document.querySelectorAll('.modal-overlay');
  for (const modal of modals) {
    if (modal.classList.contains('active') ||
        (modal.style.display && modal.style.display !== 'none')) {
      return true;
    }
  }
  return false;
}

document.addEventListener('keydown', (e) => {
  // Don't capture keys when modal is open
  if (isModalOpen()) return;

  // Don't capture when typing in an input/textarea
  const tag = document.activeElement.tagName.toLowerCase();
  if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

  if (e.key === "/") { e.preventDefault(); q.focus(); }
  if (e.key.toLowerCase() === "e") {
    engineMenu.style.display = "block";
  }
});

function fmtUptime(sec){
  sec = Math.max(0, sec|0);
  const d = Math.floor(sec/86400); sec%=86400;
  const h = Math.floor(sec/3600); sec%=3600;
  const m = Math.floor(sec/60); sec%=60;
  const parts = [];
  if(d) parts.push(d+"d");
  if(h) parts.push(h+"h");
  if(m) parts.push(m+"m");
  parts.push(sec+"s");
  return parts.join(" ");
}

// Timer management
const timers = {
  cpu: {interval: 5000, lastUpdate: 0, timer: null}, // 5 seconds
  ram: {interval: 5000, lastUpdate: 0, timer: null}, // 5 seconds
  disk: {interval: 15000, lastUpdate: 0, timer: null}, // 15 seconds
  github: {interval: 900000, lastUpdate: 0, timer: null}, // 15 minutes
  weather: {interval: 1800000, lastUpdate: 0, timer: null}, // 30 minutes
  ip: {interval: 7200000, lastUpdate: 0, timer: null}, // 2 hours
  general: {interval: 30000, lastUpdate: 0, timer: null} // 30 seconds for other data
};

function updateTimer(moduleName) {
  const timer = timers[moduleName];
  if (!timer) return;
  const elapsed = Date.now() - timer.lastUpdate;
  const remaining = Math.max(0, timer.interval - elapsed);
  const timerEl = document.getElementById(moduleName + "Timer");
  if (timerEl) {
    const seconds = Math.ceil(remaining / 1000);
    const percent = (elapsed / timer.interval) * 100;
    const percentClamped = Math.min(100, Math.max(0, percent));

    if (remaining > 0) {
      timerEl.title = "Next refresh in " + seconds + "s (double-click to refresh now)";
      timerEl.classList.remove("paused");
      // Update CSS variable for progress percentage
      timerEl.style.setProperty("--progress-percent", percentClamped + "%");
    } else {
      timerEl.title = "Ready to refresh (double-click to refresh now)";
      timerEl.classList.add("paused");
      timerEl.style.setProperty("--progress-percent", "100%");
    }
  }
}

function startTimer(moduleName) {
  const timer = timers[moduleName];
  if (!timer) return;
  timer.lastUpdate = Date.now();
  updateTimer(moduleName);
  if (timer.timer) clearInterval(timer.timer);
  timer.timer = setInterval(() => updateTimer(moduleName), 1000);
}

function formatBytes(bytes) {
  if (bytes === 0) return "0 B";
  const k = 1024;
  const sizes = ["B", "KB", "MB", "GB", "TB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return (bytes / Math.pow(k, i)).toFixed(2) + " " + sizes[i];
}

// History for bar graphs
const minBarWidth = 4; // Minimum width of each bar in pixels
const barGap = 2; // Gap between bars in pixels
const graphMaxHeight = 26; // Max height of bars in pixels

// Full bars preference (show unused portion in dim color)
let showFullBars = false;
try {
  showFullBars = localStorage.getItem('showFullBars') === 'true';
} catch (e) {}

function saveFullBarsPreference() {
  try {
    localStorage.setItem('showFullBars', showFullBars.toString());
  } catch (e) {}
}

function applyFullBarsClass() {
  const graphs = document.querySelectorAll('.cpu-graph, .usage-graph');
  graphs.forEach(g => {
    if (showFullBars) {
      g.classList.add('full-bars');
    } else {
      g.classList.remove('full-bars');
    }
  });
}

// Load CPU history from localStorage
let cpuHistory = [];
try {
  const saved = localStorage.getItem('cpuHistory');
  if (saved) {
    cpuHistory = JSON.parse(saved);
  }
} catch (e) {
  cpuHistory = [];
}

// Load RAM history from localStorage
let ramHistory = [];
try {
  const saved = localStorage.getItem('ramHistory');
  if (saved) {
    ramHistory = JSON.parse(saved);
  }
} catch (e) {
  ramHistory = [];
}

// Load Disk history from localStorage
let diskHistory = [];
try {
  const saved = localStorage.getItem('diskHistory');
  if (saved) {
    diskHistory = JSON.parse(saved);
  }
} catch (e) {
  diskHistory = [];
}

function saveCpuHistory() {
  try {
    localStorage.setItem('cpuHistory', JSON.stringify(cpuHistory));
  } catch (e) {
    // Ignore storage errors
  }
}

function saveRamHistory() {
  try {
    localStorage.setItem('ramHistory', JSON.stringify(ramHistory));
  } catch (e) {
    // Ignore storage errors
  }
}

function saveDiskHistory() {
  try {
    localStorage.setItem('diskHistory', JSON.stringify(diskHistory));
  } catch (e) {
    // Ignore storage errors
  }
}

function renderCpuGraph() {
  const graph = document.getElementById("cpuGraph");
  if (!graph || cpuHistory.length === 0) return;

  // Create bars for existing history
  while (graph.children.length < cpuHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Update bar heights and styling
  for (let i = 0; i < cpuHistory.length; i++) {
    const pct = cpuHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

function updateCpuGraph(usage) {
  const graph = document.getElementById("cpuGraph");
  if (!graph) return;

  // Calculate how wide each bar would be if we add one more
  const containerWidth = graph.clientWidth - 6; // Subtract padding
  const newBarCount = cpuHistory.length + 1;
  const barWidthIfAdded = (containerWidth - (barGap * (newBarCount - 1))) / newBarCount;

  // If adding a new bar would make bars less than 4px, remove oldest first
  if (barWidthIfAdded < minBarWidth && cpuHistory.length > 0) {
    cpuHistory.shift();
  }

  // Add new value
  cpuHistory.push(usage);
  saveCpuHistory();

  // Create bars if needed
  while (graph.children.length < cpuHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Remove extra bars if needed (from the front - oldest)
  while (graph.children.length > cpuHistory.length) {
    graph.removeChild(graph.firstChild);
  }

  // Update bar heights and styling
  for (let i = 0; i < cpuHistory.length; i++) {
    const pct = cpuHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

function renderRamGraph() {
  const graph = document.getElementById("ramGraph");
  if (!graph || ramHistory.length === 0) return;

  // Create bars for existing history
  while (graph.children.length < ramHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Update bar heights and styling
  for (let i = 0; i < ramHistory.length; i++) {
    const pct = ramHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

function updateRamGraph(usage) {
  const graph = document.getElementById("ramGraph");
  if (!graph) return;

  // Calculate how wide each bar would be if we add one more
  const containerWidth = graph.clientWidth - 6; // Subtract padding
  const newBarCount = ramHistory.length + 1;
  const barWidthIfAdded = (containerWidth - (barGap * (newBarCount - 1))) / newBarCount;

  // If adding a new bar would make bars less than 4px, remove oldest first
  if (barWidthIfAdded < minBarWidth && ramHistory.length > 0) {
    ramHistory.shift();
  }

  // Add new value
  ramHistory.push(usage);
  saveRamHistory();

  // Create bars if needed
  while (graph.children.length < ramHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Remove extra bars if needed (from the front - oldest)
  while (graph.children.length > ramHistory.length) {
    graph.removeChild(graph.firstChild);
  }

  // Update bar heights and styling
  for (let i = 0; i < ramHistory.length; i++) {
    const pct = ramHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

function renderDiskGraph() {
  const graph = document.getElementById("diskGraph");
  if (!graph || diskHistory.length === 0) return;

  // Create bars for existing history
  while (graph.children.length < diskHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Update bar heights and styling
  for (let i = 0; i < diskHistory.length; i++) {
    const pct = diskHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

function updateDiskGraph(usage) {
  const graph = document.getElementById("diskGraph");
  if (!graph) return;

  // Calculate how wide each bar would be if we add one more
  const containerWidth = graph.clientWidth - 6; // Subtract padding
  const newBarCount = diskHistory.length + 1;
  const barWidthIfAdded = (containerWidth - (barGap * (newBarCount - 1))) / newBarCount;

  // If adding a new bar would make bars less than 4px, remove oldest first
  if (barWidthIfAdded < minBarWidth && diskHistory.length > 0) {
    diskHistory.shift();
  }

  // Add new value
  diskHistory.push(usage);
  saveDiskHistory();

  // Create bars if needed
  while (graph.children.length < diskHistory.length) {
    const bar = document.createElement("div");
    bar.className = "bar";
    graph.appendChild(bar);
  }

  // Remove extra bars if needed (from the front - oldest)
  while (graph.children.length > diskHistory.length) {
    graph.removeChild(graph.firstChild);
  }

  // Update bar heights and styling
  for (let i = 0; i < diskHistory.length; i++) {
    const pct = diskHistory[i] / 100;
    const bar = graph.children[i];
    if (showFullBars) {
      bar.style.height = graphMaxHeight + "px";
      bar.style.setProperty('--fill-pct', (pct * 100) + '%');
    } else {
      const height = Math.max(2, pct * graphMaxHeight);
      bar.style.height = height + "px";
      bar.style.removeProperty('--fill-pct');
    }
  }
}

async function refreshCPU(){
  try{
    const res = await fetch("/api/system", {cache:"no-store"});
    const j = await res.json();
    if (j.cpu) {
      if (j.cpu.error) {
        document.getElementById("cpuUsage").textContent = "—";
        document.getElementById("cpuErr").textContent = j.cpu.error;
      } else {
        const usage = j.cpu.usage || 0;
        document.getElementById("cpuUsage").textContent = usage.toFixed(1) + "%";
        document.getElementById("cpuErr").textContent = "";
        updateCpuGraph(usage);
      }
    }
    startTimer("cpu");
  } catch(err){
    console.error("Error refreshing CPU:", err);
  }
}

async function refreshRAM(){
  try{
    const res = await fetch("/api/system", {cache:"no-store"});
    const j = await res.json();
    if (j.ram) {
      if (j.ram.error) {
        document.getElementById("ramSummary").textContent = "—";
        document.getElementById("ramPercent").textContent = "—";
        document.getElementById("ramErr").textContent = j.ram.error;
      } else {
        const toGB = (bytes) => (bytes / (1024 * 1024 * 1024)).toFixed(1);
        const total = toGB(j.ram.total || 0);
        const used = toGB(j.ram.used || 0);
        const available = toGB(j.ram.available || 0);
        document.getElementById("ramSummary").textContent = total + " / " + used + " / " + available;
        const percent = j.ram.percent || 0;
        document.getElementById("ramPercent").textContent = percent.toFixed(1) + "%";
        document.getElementById("ramErr").textContent = "";
        updateRamGraph(percent);
      }
    }
    startTimer("ram");
  } catch(err){
    console.error("Error refreshing RAM:", err);
  }
}

async function refreshDisk(){
  try{
    const res = await fetch("/api/system", {cache:"no-store"});
    const j = await res.json();
    if (j.disk) {
      if (j.disk.error) {
        document.getElementById("diskSummary").textContent = "—";
        document.getElementById("diskPercent").textContent = "—";
        document.getElementById("diskErr").textContent = j.disk.error;
      } else {
        const toGB = (bytes) => (bytes / (1024 * 1024 * 1024)).toFixed(1);
        const total = toGB(j.disk.total || 0);
        const used = toGB(j.disk.used || 0);
        const free = toGB(j.disk.free || 0);
        document.getElementById("diskSummary").textContent = total + " / " + used + " / " + free;
        const percent = j.disk.percent || 0;
        document.getElementById("diskPercent").textContent = percent.toFixed(1) + "%";
        document.getElementById("diskErr").textContent = "";
        updateDiskGraph(percent);
      }
    }
    startTimer("disk");
  } catch(err){
    console.error("Error refreshing Disk:", err);
  }
}

// Weather code to icon and description mapping (Open-Meteo WMO codes)
function getWeatherIcon(code) {
  let icon, desc;
  // WMO Weather interpretation codes
  if (code === 0) { icon = 'fa-sun'; desc = 'Clear sky'; }
  else if (code === 1) { icon = 'fa-sun'; desc = 'Mainly clear'; }
  else if (code === 2) { icon = 'fa-cloud-sun'; desc = 'Partly cloudy'; }
  else if (code === 3) { icon = 'fa-cloud'; desc = 'Overcast'; }
  else if (code === 45 || code === 48) { icon = 'fa-smog'; desc = 'Fog'; }
  else if (code >= 51 && code <= 55) { icon = 'fa-cloud-rain'; desc = 'Drizzle'; }
  else if (code >= 56 && code <= 57) { icon = 'fa-icicles'; desc = 'Freezing drizzle'; }
  else if (code >= 61 && code <= 65) { icon = 'fa-cloud-showers-heavy'; desc = 'Rain'; }
  else if (code >= 66 && code <= 67) { icon = 'fa-icicles'; desc = 'Freezing rain'; }
  else if (code >= 71 && code <= 77) { icon = 'fa-snowflake'; desc = 'Snow'; }
  else if (code >= 80 && code <= 82) { icon = 'fa-cloud-showers-heavy'; desc = 'Rain showers'; }
  else if (code >= 85 && code <= 86) { icon = 'fa-snowflake'; desc = 'Snow showers'; }
  else if (code === 95) { icon = 'fa-bolt'; desc = 'Thunderstorm'; }
  else if (code >= 96 && code <= 99) { icon = 'fa-cloud-bolt'; desc = 'Thunderstorm with hail'; }
  else { icon = 'fa-cloud'; desc = 'Unknown'; }
  return { icon: icon, desc: desc };
}

async function refreshWeather(){
  try{
    // Get saved location from localStorage
    let weatherUrl = "/api/weather";
    let locationName = "";
    try {
      const savedLoc = localStorage.getItem('weatherLocation');
      if (savedLoc) {
        const loc = JSON.parse(savedLoc);
        weatherUrl += "?lat=" + loc.latitude + "&lon=" + loc.longitude;
        locationName = loc.name || "";
      }
    } catch (e) {}

    // Update location display
    document.getElementById("weatherLocation").textContent = locationName ? "• " + locationName : "";

    const res = await fetch(weatherUrl, {cache:"no-store"});
    const j = await res.json();

    // Now - current weather
    if (j.current) {
      const nowWeather = getWeatherIcon(j.current.weatherCode);
      const nowIconEl = document.getElementById("weatherNowIcon");
      nowIconEl.innerHTML = '<i class="fas ' + nowWeather.icon + '" title="' + nowWeather.desc + '"></i>';
      nowIconEl.setAttribute('title', nowWeather.desc);
      document.getElementById("weatherNowData").innerHTML =
        '<i class="fas fa-thermometer-half" title="Temperature"></i> ' + j.current.temperature.toFixed(0) + j.current.tempUnit +
        ' <i class="fas fa-tint" title="Humidity"></i> ' + j.current.humidity.toFixed(0) + '%' +
        ' <i class="fas fa-wind" title="Wind"></i> ' + j.current.windSpeed.toFixed(0) + j.current.windUnit;
    } else {
      document.getElementById("weatherNowIcon").innerHTML = "—";
      document.getElementById("weatherNowIcon").removeAttribute('title');
      document.getElementById("weatherNowData").textContent = j.summary || "—";
    }

    // Today
    if (j.today) {
      const todayWeather = getWeatherIcon(j.today.weatherCode);
      const todayIconEl = document.getElementById("weatherTodayIcon");
      todayIconEl.innerHTML = '<i class="fas ' + todayWeather.icon + '" title="' + todayWeather.desc + '"></i>';
      todayIconEl.setAttribute('title', todayWeather.desc);
      document.getElementById("weatherTodayData").innerHTML =
        '<i class="fas fa-temperature-high" title="High"></i> ' + j.today.tempMax.toFixed(0) + '°' +
        ' <i class="fas fa-temperature-low" title="Low"></i> ' + j.today.tempMin.toFixed(0) + '°';
    } else {
      document.getElementById("weatherTodayIcon").innerHTML = "—";
      document.getElementById("weatherTodayIcon").removeAttribute('title');
      document.getElementById("weatherTodayData").textContent = "—";
    }

    // Tomorrow
    if (j.tomorrow) {
      const tomorrowWeather = getWeatherIcon(j.tomorrow.weatherCode);
      const tomorrowIconEl = document.getElementById("weatherTomorrowIcon");
      tomorrowIconEl.innerHTML = '<i class="fas ' + tomorrowWeather.icon + '" title="' + tomorrowWeather.desc + '"></i>';
      tomorrowIconEl.setAttribute('title', tomorrowWeather.desc);
      document.getElementById("weatherTomorrowData").innerHTML =
        '<i class="fas fa-temperature-high" title="High"></i> ' + j.tomorrow.tempMax.toFixed(0) + '°' +
        ' <i class="fas fa-temperature-low" title="Low"></i> ' + j.tomorrow.tempMin.toFixed(0) + '°';
    } else {
      document.getElementById("weatherTomorrowIcon").innerHTML = "—";
      document.getElementById("weatherTomorrowIcon").removeAttribute('title');
      document.getElementById("weatherTomorrowData").textContent = "—";
    }

    document.getElementById("weatherErr").textContent = j.error || "";

    startTimer("weather");
  } catch(err){
    console.error("Error refreshing weather:", err);
  }
}


function renderGitHubContent(moduleId, displayType, data) {
    const container = document.getElementById("content-" + moduleId);
    const countEl = document.getElementById("count-" + moduleId);
    const errEl = document.getElementById("err-" + moduleId);

    if (!container) return;

    if (data.error) {
      container.innerHTML = "";
      if (errEl) errEl.textContent = data.error;
      if (countEl) countEl.textContent = "Error";
      return;
    }

    container.innerHTML = "";
    if (errEl) errEl.textContent = "";

    // Handle different display types
    if (displayType === 'repos') {
      renderReposList(container, countEl, data);
    } else if (displayType === 'prs') {
      renderPRsList(container, countEl, data);
    } else if (displayType === 'commits') {
      renderCommitsList(container, countEl, data);
    } else if (displayType === 'issues') {
      renderIssuesList(container, countEl, data);
    } else if (displayType === 'stats') {
      renderStats(container, countEl, data);
    } else {
      renderReposList(container, countEl, data);
    }
}

function renderReposList(container, countEl, data) {
    if (data.repos && data.repos.length > 0) {
      if (countEl) countEl.textContent = (data.total || data.repos.length) + " repositories";
      data.repos.forEach((repo) => {
        const item = document.createElement("div");
        item.className = "repo-item";
        const name = document.createElement("div");
        name.className = "repo-name";
        const link = document.createElement("a");
        link.href = repo.url;
        link.target = "_blank";
        link.rel = "noreferrer";
        link.innerHTML = '<i class="fab fa-github"></i> ' + repo.fullName;
        name.appendChild(link);
        item.appendChild(name);
        if (repo.description) {
          const desc = document.createElement("div");
          desc.className = "repo-desc";
          desc.textContent = repo.description;
          item.appendChild(desc);
        }
        const meta = document.createElement("div");
        meta.className = "repo-meta";
        if (repo.stars > 0) {
          const stars = document.createElement("span");
          stars.innerHTML = '<i class="fas fa-star"></i> ' + repo.stars;
          meta.appendChild(stars);
        }
        if (repo.language) {
          const lang = document.createElement("span");
          lang.innerHTML = '<i class="fas fa-code"></i> ' + repo.language;
          meta.appendChild(lang);
        }
        if (repo.updated) {
          const updated = document.createElement("span");
          updated.innerHTML = '<i class="fas fa-clock"></i> ' + repo.updated;
          meta.appendChild(updated);
        }
        item.appendChild(meta);
        container.appendChild(item);
      });
    } else {
      container.innerHTML = '<div class="small">No repositories found.</div>';
      if (countEl) countEl.textContent = "0 repositories";
    }
}

function renderPRsList(container, countEl, data) {
    if (data.items && data.items.length > 0) {
      if (countEl) countEl.textContent = (data.total || data.items.length) + " pull requests";
      data.items.forEach((pr) => {
        const item = document.createElement("div");
        item.className = "repo-item";
        item.innerHTML = `
          <div class="repo-name"><a href="${pr.url}" target="_blank" rel="noreferrer"><i class="fas fa-code-branch"></i> ${pr.title}</a></div>
          <div class="repo-meta">
            <span><i class="fas fa-user"></i> ${pr.user || 'Unknown'}</span>
            <span><i class="fas fa-clock"></i> ${pr.created || ''}</span>
            <span class="badge-${pr.state || 'open'}">${pr.state || 'open'}</span>
          </div>
        `;
        container.appendChild(item);
      });
    } else {
      container.innerHTML = '<div class="small">No pull requests found.</div>';
      if (countEl) countEl.textContent = "0 pull requests";
    }
}

function renderCommitsList(container, countEl, data) {
    if (data.items && data.items.length > 0) {
      if (countEl) countEl.textContent = (data.items.length) + " recent commits";
      data.items.forEach((commit) => {
        const item = document.createElement("div");
        item.className = "repo-item";
        item.innerHTML = `
          <div class="repo-name"><a href="${commit.url}" target="_blank" rel="noreferrer"><i class="fas fa-code-commit"></i> ${commit.message}</a></div>
          <div class="repo-meta">
            <span><i class="fas fa-user"></i> ${commit.author || 'Unknown'}</span>
            <span><i class="fas fa-clock"></i> ${commit.date || ''}</span>
          </div>
        `;
        container.appendChild(item);
      });
    } else {
      container.innerHTML = '<div class="small">No commits found.</div>';
      if (countEl) countEl.textContent = "0 commits";
    }
}

function renderIssuesList(container, countEl, data) {
    if (data.items && data.items.length > 0) {
      if (countEl) countEl.textContent = (data.total || data.items.length) + " issues";
      data.items.forEach((issue) => {
        const item = document.createElement("div");
        item.className = "repo-item";
        item.innerHTML = `
          <div class="repo-name"><a href="${issue.url}" target="_blank" rel="noreferrer"><i class="fas fa-exclamation-circle"></i> ${issue.title}</a></div>
          <div class="repo-meta">
            <span><i class="fas fa-user"></i> ${issue.user || 'Unknown'}</span>
            <span><i class="fas fa-clock"></i> ${issue.created || ''}</span>
            <span class="badge-${issue.state || 'open'}">${issue.state || 'open'}</span>
          </div>
        `;
        container.appendChild(item);
      });
    } else {
      container.innerHTML = '<div class="small">No issues found.</div>';
      if (countEl) countEl.textContent = "0 issues";
    }
}

function renderStats(container, countEl, data) {
    if (data.stats) {
      if (countEl) countEl.textContent = "Repository stats";
      container.innerHTML = `
        <div class="kv"><div class="k">Stars</div><div class="v">${data.stats.stars || 0}</div></div>
        <div class="kv"><div class="k">Forks</div><div class="v">${data.stats.forks || 0}</div></div>
        <div class="kv"><div class="k">Watchers</div><div class="v">${data.stats.watchers || 0}</div></div>
        <div class="kv"><div class="k">Open Issues</div><div class="v">${data.stats.openIssues || 0}</div></div>
        <div class="kv"><div class="k">Language</div><div class="v">${data.stats.language || 'N/A'}</div></div>
      `;
    } else {
      container.innerHTML = '<div class="small">No stats available.</div>';
      if (countEl) countEl.textContent = "No stats";
    }
}

async function refreshGitHubModule(mod) {
  try {
    const displayType = mod.displayType || 'repos';
    const accountType = mod.accountType || mod.type || 'user';
    const res = await fetch("/api/github/" + displayType + "?name=" + encodeURIComponent(mod.name) + "&type=" + accountType, {cache:"no-store"});
    const data = await res.json();
    renderGitHubContent(mod.id, displayType, data);
  } catch(err) {
    console.error("Error refreshing GitHub module " + mod.id + ":", err);
    const errEl = document.getElementById("err-" + mod.id);
    if (errEl) errEl.textContent = "Error loading data";
  }
}

async function refreshGitHub(){
  try{
    // Refresh all enabled GitHub modules
    const promises = githubModules.filter(m => m.enabled).map(mod => refreshGitHubModule(mod));
    await Promise.all(promises);
    startTimer("github");
  } catch(err){
    console.error("Error refreshing GitHub:", err);
  }
}

async function refreshIP(){
  try{
    const res = await fetch("/api/ip", {cache:"no-store"});
    const j = await res.json();

    // Display LAN IPs with PTR records on second line
    const lanIpsEl = document.getElementById("lanIps");
    const lanPtrEl = document.getElementById("lanPtr");
    if (j.network && j.network.hostIps && j.network.hostIps.length > 0) {
      const ips = j.network.hostIps.map(ipInfo => ipInfo.ip);
      const ptrs = j.network.hostIps.map(ipInfo => ipInfo.ptr).filter(p => p);
      lanIpsEl.textContent = ips.join(", ");
      lanPtrEl.textContent = ptrs.length > 0 ? ptrs.join(", ") : "";
    } else {
      lanIpsEl.textContent = "—";
      lanPtrEl.textContent = "";
    }

    // Display Public IP with PTR on second line
    if (j.public && j.public.ip) {
      document.getElementById("pubIp").textContent = j.public.ip;
      document.getElementById("pubPtr").textContent = j.public.ptr || "";
      document.getElementById("pubIpErr").textContent = "";
    } else {
      document.getElementById("pubIp").textContent = "—";
      document.getElementById("pubPtr").textContent = "";
      document.getElementById("pubIpErr").textContent = (j.public && j.public.error) || "";
    }

    startTimer("ip");
  } catch(err){
    console.error("Error refreshing IP:", err);
  }
}

async function refresh(){
  try{
    const res = await fetch("/api/summary", {cache:"no-store"});
    const j = await res.json();

    document.getElementById("subtitle").textContent =
      j.server.os + "/" + j.server.arch + " • " + j.server.goVersion;

    document.getElementById("host").textContent = j.server.hostname;
    document.getElementById("uptime").textContent = fmtUptime(j.server.uptimeSec);
    document.getElementById("time").textContent = j.server.time;

  } catch(err){
    document.getElementById("statusText").textContent = "Degraded";
  }
}

document.getElementById("refreshBtn").onclick = refresh;

// Setup double-click handlers for timers
const refreshHandlers = {
  cpu: refreshCPU,
  ram: refreshRAM,
  disk: refreshDisk,
  github: refreshGitHub,
  weather: refreshWeather,
  ip: refreshIP
};

["cpu", "ram", "disk", "github", "weather", "ip"].forEach(module => {
  const timerEl = document.getElementById(module + "Timer");
  if (timerEl) {
    let lastClick = 0;
    timerEl.addEventListener("dblclick", (e) => {
      e.preventDefault();
      e.stopPropagation();
      const handler = refreshHandlers[module];
      if (handler) handler();
    });
    // Also handle click for better compatibility
    timerEl.addEventListener("click", (e) => {
      const now = Date.now();
      if (now - lastClick < 300) {
        e.preventDefault();
        e.stopPropagation();
        const handler = refreshHandlers[module];
        if (handler) handler();
      }
      lastClick = now;
    });
  }
});

// Module configuration with defaults
const moduleConfig = {
  status: { name: 'Status', icon: 'fa-server', desc: 'Server status and uptime', hasTimer: false, enabled: true },
  network: { name: 'Network', icon: 'fa-network-wired', desc: 'LAN and public IP addresses', hasTimer: true, timerKey: 'ip', defaultInterval: 7200, enabled: true },
  weather: { name: 'Weather', icon: 'fa-cloud-sun', desc: 'Current weather and forecast', hasTimer: true, timerKey: 'weather', defaultInterval: 1800, enabled: true },
  cpu: { name: 'CPU', icon: 'fa-microchip', desc: 'CPU usage monitoring', hasTimer: true, timerKey: 'cpu', defaultInterval: 5, enabled: true },
  ram: { name: 'RAM', icon: 'fa-memory', desc: 'Memory usage monitoring', hasTimer: true, timerKey: 'ram', defaultInterval: 5, enabled: true },
  disk: { name: 'Disk', icon: 'fa-hdd', desc: 'Disk space monitoring', hasTimer: true, timerKey: 'disk', defaultInterval: 15, enabled: true },
  links: { name: 'Quick Links', icon: 'fa-link', desc: 'Custom shortcut links', hasTimer: false, enabled: true },
  utilities: { name: 'Utilities', icon: 'fa-tools', desc: 'System utilities', hasTimer: false, enabled: true }
};

// GitHub modules configuration (stored separately, can have multiple)
// displayType: repos, prs, commits, stats, issues
// accountType: user, org, repo (for repo-specific views)
const defaultGitHubModules = [
  { id: 'github-1', accountType: 'user', displayType: 'repos', name: 'Earentir', url: 'https://github.com/Earentir', enabled: true },
  { id: 'github-2', accountType: 'org', displayType: 'repos', name: 'network-plane', url: 'https://github.com/network-plane', enabled: true }
];

const githubDisplayTypes = {
  repos: { name: 'Repositories', icon: 'fa-folder', desc: 'Show recent repositories' },
  prs: { name: 'Pull Requests', icon: 'fa-code-branch', desc: 'Show open pull requests' },
  commits: { name: 'Commits', icon: 'fa-code-commit', desc: 'Show recent commits' },
  stats: { name: 'Stats', icon: 'fa-chart-bar', desc: 'Show repository statistics' },
  issues: { name: 'Issues', icon: 'fa-exclamation-circle', desc: 'Show open issues' }
};

let githubModules = [];
try {
  const saved = localStorage.getItem('githubModules');
  if (saved) {
    githubModules = JSON.parse(saved);
  } else {
    githubModules = defaultGitHubModules;
  }
} catch (e) {
  githubModules = defaultGitHubModules;
}

function saveGitHubModules() {
  localStorage.setItem('githubModules', JSON.stringify(githubModules));
}

function renderGitHubModules() {
  const container = document.getElementById('githubModulesContainer');
  if (!container) return;
  container.innerHTML = '';

  githubModules.forEach((mod, index) => {
    if (!mod.enabled) return;

    // Handle legacy modules without displayType
    const displayType = mod.displayType || 'repos';
    const accountType = mod.accountType || mod.type || 'user';
    const typeInfo = githubDisplayTypes[displayType] || githubDisplayTypes.repos;

    const card = document.createElement('div');
    card.className = 'card span-6';
    card.setAttribute('data-module', mod.id);
    card.setAttribute('draggable', 'true');

    const hasTimer = index === 0; // Only first GitHub module has the timer
    const timerHtml = hasTimer ? '<div class="timer-circle" id="githubTimer" title="Double-click to refresh"></div>' : '';

    const titleSuffix = displayType !== 'repos' ? ' - ' + typeInfo.name : '';

    card.innerHTML = `
      <h3><i class="fab fa-github"></i> ${mod.name}${titleSuffix}<div class="header-icons"><a href="${mod.url}" target="_blank" rel="noreferrer"><i class="fas fa-external-link-alt"></i></a>${timerHtml}<i class="fas fa-grip-vertical drag-handle" title="Drag to reorder"></i></div></h3>
      <div class="small" style="margin-bottom:8px; color:var(--muted);"><i class="fas ${typeInfo.icon}"></i> <span id="count-${mod.id}">—</span></div>
      <div id="content-${mod.id}">
        <div class="small">Loading...</div>
      </div>
      <div class="small" id="err-${mod.id}"></div>
    `;

    container.appendChild(card);
  });
}

// Render GitHub modules on page load
renderGitHubModules();

// Initial refresh
refresh();
applyFullBarsClass(); // Apply full bars styling before rendering
renderCpuGraph(); // Render saved CPU history
renderRamGraph(); // Render saved RAM history
renderDiskGraph(); // Render saved Disk history
refreshCPU();
refreshRAM();
refreshDisk();
refreshGitHub();
refreshWeather();
refreshIP();

// Load saved module preferences
function loadModulePrefs() {
  try {
    const saved = localStorage.getItem('modulePrefs');
    if (saved) {
      const prefs = JSON.parse(saved);
      Object.keys(prefs).forEach(key => {
        if (moduleConfig[key]) {
          if (typeof prefs[key].enabled !== 'undefined') {
            moduleConfig[key].enabled = prefs[key].enabled;
          }
          if (typeof prefs[key].interval !== 'undefined' && moduleConfig[key].hasTimer) {
            const timerKey = moduleConfig[key].timerKey;
            if (timers[timerKey]) {
              timers[timerKey].interval = prefs[key].interval * 1000;
            }
          }
        }
      });
    }
  } catch (e) {
    console.error('Error loading module prefs:', e);
  }
}

function saveModulePrefs() {
  try {
    const prefs = {};
    Object.keys(moduleConfig).forEach(key => {
      prefs[key] = { enabled: moduleConfig[key].enabled };
      if (moduleConfig[key].hasTimer) {
        const timerKey = moduleConfig[key].timerKey;
        if (timers[timerKey]) {
          prefs[key].interval = timers[timerKey].interval / 1000;
        }
      }
    });
    localStorage.setItem('modulePrefs', JSON.stringify(prefs));
  } catch (e) {
    console.error('Error saving module prefs:', e);
  }
}

function applyModuleVisibility() {
  Object.keys(moduleConfig).forEach(key => {
    const card = document.querySelector(`.card[data-module="${key}"]`);
    if (card) {
      card.style.display = moduleConfig[key].enabled ? '' : 'none';
    }
  });
}

// Load prefs on startup
loadModulePrefs();
applyModuleVisibility();

// Preferences Modal
(function() {
  const modal = document.getElementById('prefsModal');
  const openBtn = document.getElementById('prefsBtn');
  const closeBtn = document.getElementById('prefsClose');
  const tabs = document.querySelectorAll('.modal-tab');
  const tabContents = document.querySelectorAll('.tab-content');

  // Open modal
  openBtn.addEventListener('click', () => {
    modal.classList.add('active');
    renderModuleList();
    updateSchemeSelect();
  });

  // Close modal
  closeBtn.addEventListener('click', () => {
    modal.classList.remove('active');
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('active');
    }
  });

  // Tab switching
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
  });

  // Template/scheme selects
  const templateSelect = document.getElementById('pref-template');
  const schemeSelect = document.getElementById('pref-scheme');

  // Set current template value
  const currentTemplate = localStorage.getItem('template') || '{{.CurrentTemplate}}' || 'nordic';
  templateSelect.value = currentTemplate;

  templateSelect.addEventListener('change', () => {
    const newTemplate = templateSelect.value;
    localStorage.setItem('template', newTemplate);
    localStorage.setItem('scheme', 'default'); // Reset scheme when changing template
    document.cookie = 'template=' + newTemplate + '; path=/; max-age=31536000';
    document.cookie = 'scheme=default; path=/; max-age=31536000';
    location.reload();
  });

  function updateSchemeSelect() {
    const currentScheme = localStorage.getItem('scheme') || '{{.CurrentScheme}}' || 'default';
    // Get schemes from the existing scheme menu (uses buttons with data-scheme)
    const schemeMenu = document.getElementById('schemeMenu');
    schemeSelect.innerHTML = '';
    if (schemeMenu) {
      const schemeButtons = schemeMenu.querySelectorAll('button[data-scheme]');
      schemeButtons.forEach(btn => {
        const scheme = btn.getAttribute('data-scheme');
        const name = btn.textContent.trim();
        const option = document.createElement('option');
        option.value = scheme;
        option.textContent = name;
        if (scheme === currentScheme) option.selected = true;
        schemeSelect.appendChild(option);
      });
    }
  }

  schemeSelect.addEventListener('change', () => {
    const template = localStorage.getItem('template') || '{{.CurrentTemplate}}' || 'nordic';
    const newScheme = schemeSelect.value;
    localStorage.setItem('scheme', newScheme);
    document.cookie = 'scheme=' + newScheme + '; path=/; max-age=31536000';
    location.reload();
  });

  // Initialize scheme select on modal open
  updateSchemeSelect();

  // Clear cache button
  document.getElementById('clearCacheBtn').addEventListener('click', () => {
    localStorage.removeItem('cpuHistory');
    localStorage.removeItem('ramHistory');
    localStorage.removeItem('diskHistory');
    localStorage.removeItem('githubData');
    alert('Cache cleared!');
  });

  // Reset order button
  document.getElementById('resetOrderBtn').addEventListener('click', () => {
    localStorage.removeItem('moduleOrder');
    location.reload();
  });

  // Full bars preference
  const fullBarsCheckbox = document.getElementById('pref-full-bars');
  fullBarsCheckbox.checked = showFullBars;
  fullBarsCheckbox.addEventListener('change', () => {
    showFullBars = fullBarsCheckbox.checked;
    saveFullBarsPreference();
    applyFullBarsClass();
    // Re-render all graphs with new styling
    renderCpuGraph();
    renderRamGraph();
    renderDiskGraph();
  });

  // Weather location
  const locationInput = document.getElementById('pref-weather-location');
  const searchLocationBtn = document.getElementById('searchLocationBtn');
  const locationResultsRow = document.getElementById('locationResultsRow');
  const locationResultsSelect = document.getElementById('pref-location-results');
  const currentLocationDisplay = document.getElementById('currentLocationDisplay');

  // Load saved location
  function loadWeatherLocation() {
    try {
      const saved = localStorage.getItem('weatherLocation');
      if (saved) {
        const loc = JSON.parse(saved);
        currentLocationDisplay.textContent = loc.name + ', ' + loc.country + ' (' + loc.latitude.toFixed(2) + ', ' + loc.longitude.toFixed(2) + ')';
        locationInput.value = loc.name + ', ' + loc.country;
      } else {
        currentLocationDisplay.textContent = 'Not set';
      }
    } catch (e) {
      currentLocationDisplay.textContent = 'Not set';
    }
  }
  loadWeatherLocation();

  // Search location
  searchLocationBtn.addEventListener('click', async () => {
    const query = locationInput.value.trim();
    if (!query) return;

    searchLocationBtn.disabled = true;
    searchLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
      const res = await fetch('/api/geocode?q=' + encodeURIComponent(query));
      const data = await res.json();

      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }

      if (data.length === 0) {
        alert('No locations found for "' + query + '"');
        return;
      }

      // Populate results dropdown
      locationResultsSelect.innerHTML = '';
      data.forEach((loc, index) => {
        const option = document.createElement('option');
        option.value = index;
        let label = loc.name;
        if (loc.admin1) label += ', ' + loc.admin1;
        label += ', ' + loc.country;
        option.textContent = label;
        option.dataset.location = JSON.stringify(loc);
        locationResultsSelect.appendChild(option);
      });

      locationResultsRow.style.display = 'flex';
    } catch (e) {
      alert('Error searching location: ' + e.message);
    } finally {
      searchLocationBtn.disabled = false;
      searchLocationBtn.innerHTML = '<i class="fas fa-search"></i>';
    }
  });

  // Enter key to search
  locationInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchLocationBtn.click();
    }
  });

  // Set location button
  const setLocationBtn = document.getElementById('setLocationBtn');
  setLocationBtn.addEventListener('click', () => {
    const selected = locationResultsSelect.options[locationResultsSelect.selectedIndex];
    if (selected && selected.dataset.location) {
      const loc = JSON.parse(selected.dataset.location);
      localStorage.setItem('weatherLocation', JSON.stringify(loc));
      currentLocationDisplay.textContent = loc.name + ', ' + loc.country + ' (' + loc.latitude.toFixed(2) + ', ' + loc.longitude.toFixed(2) + ')';
      locationResultsRow.style.display = 'none';
      // Refresh weather with new location
      refreshWeather();
    }
  });

  // Render module list
  function renderModuleList() {
    const list = document.getElementById('moduleList');
    list.innerHTML = '';

    Object.keys(moduleConfig).forEach(key => {
      const config = moduleConfig[key];
      const timerKey = config.timerKey;
      const currentInterval = timerKey && timers[timerKey] ? timers[timerKey].interval / 1000 : 0;

      const item = document.createElement('div');
      item.className = 'module-item' + (config.enabled ? '' : ' disabled');
      item.innerHTML = `
        <div class="module-icon"><i class="fas ${config.icon}"></i></div>
        <div class="module-info">
          <div class="module-name">${config.name}</div>
          <div class="module-desc">${config.desc}</div>
        </div>
        <div class="module-controls">
          ${config.hasTimer ? `
            <div class="refresh-control">
              <input type="number" min="1" value="${currentInterval}" data-module="${key}" data-timer="${timerKey}" data-default="${config.defaultInterval}">
              <span>sec</span>
              <button class="reset-btn" title="Reset to default (${config.defaultInterval}s)" data-module="${key}" data-timer="${timerKey}" data-default="${config.defaultInterval}"><i class="fas fa-undo"></i></button>
            </div>
          ` : ''}
          <input type="checkbox" ${config.enabled ? 'checked' : ''} data-module="${key}" title="Enable/disable module">
        </div>
      `;
      list.appendChild(item);

      // Enable/disable handler
      const checkbox = item.querySelector('input[type="checkbox"]');
      checkbox.addEventListener('change', () => {
        moduleConfig[key].enabled = checkbox.checked;
        item.classList.toggle('disabled', !checkbox.checked);
        saveModulePrefs();
        applyModuleVisibility();
      });

      // Interval change handler
      const intervalInput = item.querySelector('input[type="number"]');
      if (intervalInput) {
        intervalInput.addEventListener('change', () => {
          const newInterval = Math.max(1, parseInt(intervalInput.value) || config.defaultInterval);
          intervalInput.value = newInterval;
          if (timers[timerKey]) {
            timers[timerKey].interval = newInterval * 1000;
          }
          saveModulePrefs();
        });
      }

      // Reset button handler
      const resetBtn = item.querySelector('.reset-btn');
      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          const defaultVal = parseInt(resetBtn.dataset.default);
          if (intervalInput) {
            intervalInput.value = defaultVal;
            if (timers[timerKey]) {
              timers[timerKey].interval = defaultVal * 1000;
            }
            saveModulePrefs();
          }
        });
      }
    });
  }

  // Render GitHub module list
  function renderGitHubModuleList() {
    const list = document.getElementById('githubModuleList');
    if (!list) return;
    list.innerHTML = '';

    githubModules.forEach((mod, index) => {
      const accountType = mod.accountType || mod.type || 'user';
      const displayType = mod.displayType || 'repos';
      const displayInfo = githubDisplayTypes[displayType] || githubDisplayTypes.repos;
      const accountLabel = accountType === 'org' ? 'Organization' : (accountType === 'repo' ? 'Repository' : 'User');

      const item = document.createElement('div');
      item.className = 'module-item' + (mod.enabled ? '' : ' disabled');
      item.innerHTML = `
        <div class="module-icon"><i class="fab fa-github"></i></div>
        <div class="module-info">
          <div class="module-name">${mod.name}</div>
          <div class="module-desc">${accountLabel} • ${displayInfo.name}</div>
        </div>
        <div class="module-controls">
          <button class="btn-small edit-github-btn" data-index="${index}"><i class="fas fa-edit"></i></button>
          <button class="btn-small delete-github-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
          <input type="checkbox" ${mod.enabled ? 'checked' : ''} data-index="${index}" title="Enable/disable">
        </div>
      `;
      list.appendChild(item);

      // Enable/disable handler
      const checkbox = item.querySelector('input[type="checkbox"]');
      checkbox.addEventListener('change', () => {
        githubModules[index].enabled = checkbox.checked;
        item.classList.toggle('disabled', !checkbox.checked);
        saveGitHubModules();
        renderGitHubModules();
      });

      // Edit button
      const editBtn = item.querySelector('.edit-github-btn');
      editBtn.addEventListener('click', () => {
        showGitHubEditDialog(index);
      });

      // Delete button
      const deleteBtn = item.querySelector('.delete-github-btn');
      deleteBtn.addEventListener('click', () => {
        if (confirm('Delete GitHub module "' + mod.name + '"?')) {
          githubModules.splice(index, 1);
          saveGitHubModules();
          renderGitHubModuleList();
          renderGitHubModules();
        }
      });
    });
  }

  // GitHub edit dialog
  function showGitHubEditDialog(index) {
    const mod = index >= 0 ? githubModules[index] : { id: 'github-' + Date.now(), type: 'user', name: '', url: '', enabled: true };
    const isNew = index < 0;

    const dialog = document.createElement('div');
    dialog.className = 'modal-overlay active';
    dialog.innerHTML = `
      <div class="modal" style="max-width:400px;">
        <div class="modal-header">
          <h2><i class="fab fa-github"></i> ${isNew ? 'Add' : 'Edit'} GitHub Module</h2>
          <button class="modal-close github-dialog-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-content">
          <div class="pref-section">
            <div class="pref-row">
              <label>GitHub URL</label>
              <input type="text" id="github-edit-url" placeholder="https://github.com/username or https://github.com/user/repo" value="${mod.url}">
            </div>
            <div class="pref-row">
              <label>Account Type</label>
              <select id="github-edit-account-type">
                <option value="user" ${(mod.accountType || mod.type) === 'user' ? 'selected' : ''}>User</option>
                <option value="org" ${(mod.accountType || mod.type) === 'org' ? 'selected' : ''}>Organization</option>
                <option value="repo" ${(mod.accountType || mod.type) === 'repo' ? 'selected' : ''}>Repository</option>
              </select>
            </div>
            <div class="pref-row">
              <label>Display</label>
              <select id="github-edit-display-type">
                <option value="repos" ${(mod.displayType || 'repos') === 'repos' ? 'selected' : ''}>Repositories</option>
                <option value="prs" ${mod.displayType === 'prs' ? 'selected' : ''}>Pull Requests</option>
                <option value="commits" ${mod.displayType === 'commits' ? 'selected' : ''}>Commits</option>
                <option value="issues" ${mod.displayType === 'issues' ? 'selected' : ''}>Issues</option>
                <option value="stats" ${mod.displayType === 'stats' ? 'selected' : ''}>Stats</option>
              </select>
            </div>
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
            <button class="btn-small github-dialog-cancel">Cancel</button>
            <button class="btn-small github-dialog-save" style="background:var(--accent); color:var(--bg);"><i class="fas fa-check"></i> Save</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(dialog);

    const urlInput = dialog.querySelector('#github-edit-url');
    const accountTypeSelect = dialog.querySelector('#github-edit-account-type');
    const displayTypeSelect = dialog.querySelector('#github-edit-display-type');
    const closeBtn = dialog.querySelector('.github-dialog-close');
    const cancelBtn = dialog.querySelector('.github-dialog-cancel');
    const saveBtn = dialog.querySelector('.github-dialog-save');

    const closeDialog = () => dialog.remove();

    closeBtn.addEventListener('click', closeDialog);
    cancelBtn.addEventListener('click', closeDialog);
    dialog.addEventListener('click', (e) => { if (e.target === dialog) closeDialog(); });

    saveBtn.addEventListener('click', () => {
      const url = urlInput.value.trim();
      const accountType = accountTypeSelect.value;
      const displayType = displayTypeSelect.value;

      if (!url) {
        alert('Please enter a GitHub URL');
        return;
      }

      // Extract name from URL based on account type
      let name;
      if (accountType === 'repo') {
        // For repos: https://github.com/user/repo
        const match = url.match(/github\.com\/([^\/]+\/[^\/]+)/);
        if (!match) {
          alert('Invalid GitHub repository URL. Please use format: https://github.com/user/repo');
          return;
        }
        name = match[1];
      } else {
        // For users/orgs: https://github.com/username
        const match = url.match(/github\.com\/([^\/]+)/);
        if (!match) {
          alert('Invalid GitHub URL. Please use format: https://github.com/username');
          return;
        }
        name = match[1];
      }

      if (isNew) {
        githubModules.push({
          id: 'github-' + Date.now(),
          accountType: accountType,
          displayType: displayType,
          name: name,
          url: url,
          enabled: true
        });
      } else {
        githubModules[index].name = name;
        githubModules[index].accountType = accountType;
        githubModules[index].displayType = displayType;
        githubModules[index].url = url;
        delete githubModules[index].type; // Remove legacy field
      }

      saveGitHubModules();
      renderGitHubModuleList();
      renderGitHubModules();
      refreshGitHub();
      closeDialog();
    });
  }

  // Add GitHub button
  document.getElementById('addGitHubBtn').addEventListener('click', () => {
    showGitHubEditDialog(-1);
  });

  // Render GitHub module list when modal opens
  const origOpenHandler = openBtn.onclick;
  openBtn.addEventListener('click', () => {
    renderGitHubModuleList();
    renderQuicklinksList();
  });
})();

// Quicklinks management
(function() {
  // Default quicklinks
  const defaultQuicklinks = [
    { id: 'ql-1', title: 'Router', url: 'http://192.168.1.1', icon: 'fa-network-wired' }
  ];

  // Load quicklinks from localStorage
  let quicklinks = [];
  try {
    const saved = localStorage.getItem('quicklinks');
    if (saved) {
      quicklinks = JSON.parse(saved);
    } else {
      quicklinks = defaultQuicklinks;
    }
  } catch (e) {
    quicklinks = defaultQuicklinks;
  }

  // Load layout preference
  let quicklinksLayout = 1;
  try {
    const savedLayout = localStorage.getItem('quicklinksLayout');
    if (savedLayout) {
      quicklinksLayout = parseInt(savedLayout) || 1;
    }
  } catch (e) {}

  function saveQuicklinks() {
    try {
      localStorage.setItem('quicklinks', JSON.stringify(quicklinks));
    } catch (e) {}
  }

  function saveLayout(cols) {
    quicklinksLayout = cols;
    try {
      localStorage.setItem('quicklinksLayout', cols.toString());
    } catch (e) {}
  }

  // Update layout button states
  function updateLayoutButtons() {
    const buttons = document.querySelectorAll('.layout-btn');
    buttons.forEach(btn => {
      const cols = parseInt(btn.dataset.cols);
      btn.classList.toggle('active', cols === quicklinksLayout);
    });
  }

// Favicon cache in localStorage
  function getFaviconCache() {
    try {
      const cache = localStorage.getItem('faviconCache');
      return cache ? JSON.parse(cache) : {};
    } catch (e) {
      return {};
    }
  }

  function saveFaviconCache(cache) {
    try {
      localStorage.setItem('faviconCache', JSON.stringify(cache));
    } catch (e) {}
  }

  async function fetchAndCacheFavicon(url) {
    const cache = getFaviconCache();

    // Check if already cached (cache for 7 days)
    const cacheKey = new URL(url).origin;
    if (cache[cacheKey] && cache[cacheKey].expires > Date.now()) {
      return cache[cacheKey].data;
    }

    try {
      const res = await fetch('/api/favicon?url=' + encodeURIComponent(url));
      const data = await res.json();

      if (data.favicon) {
        // Cache for 7 days
        cache[cacheKey] = {
          data: data.favicon,
          expires: Date.now() + (7 * 24 * 60 * 60 * 1000)
        };
        saveFaviconCache(cache);
        return data.favicon;
      }
    } catch (e) {
      console.error('Error fetching favicon:', e);
    }

    return null;
  }

  // Render quicklinks in the card
  window.renderQuicklinks = function() {
    const container = document.getElementById('quicklinksContainer');
    if (!container) return;

    if (quicklinks.length === 0) {
      container.innerHTML = '<div class="small" style="color:var(--muted);">Add links in Preferences → Quicklinks</div>';
      return;
    }

    container.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'quicklinks-grid cols-' + quicklinksLayout;

    quicklinks.forEach(link => {
      const item = document.createElement('div');
      item.className = 'ql-item';

      const a = document.createElement('a');
      a.href = link.url;
      a.target = '_blank';
      a.rel = 'noreferrer';

      if (link.icon) {
        a.innerHTML = '<span class="ql-icon"><i class="fas ' + link.icon + '"></i></span><span class="ql-title">' + link.title + '</span>';
      } else {
        // Check favicon cache first
        const cache = getFaviconCache();
        try {
          const cacheKey = new URL(link.url).origin;
          if (cache[cacheKey] && cache[cacheKey].expires > Date.now()) {
            a.innerHTML = '<span class="ql-icon"><img src="' + cache[cacheKey].data + '" width="14" height="14"></span><span class="ql-title">' + link.title + '</span>';
          } else {
            // Show loading placeholder, then fetch
            const iconSpan = document.createElement('span');
            iconSpan.className = 'ql-icon';
            iconSpan.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const titleSpan = document.createElement('span');
            titleSpan.className = 'ql-title';
            titleSpan.textContent = link.title;
            a.appendChild(iconSpan);
            a.appendChild(titleSpan);

            // Fetch favicon in background
            fetchAndCacheFavicon(link.url).then(favicon => {
              if (favicon) {
                iconSpan.innerHTML = '<img src="' + favicon + '" width="14" height="14">';
              } else {
                iconSpan.innerHTML = '<i class="fas fa-link"></i>';
              }
            });
          }
        } catch (e) {
          a.innerHTML = '<span class="ql-icon"><i class="fas fa-link"></i></span><span class="ql-title">' + link.title + '</span>';
        }
      }

      item.appendChild(a);
      grid.appendChild(item);
    });

    container.appendChild(grid);
  };

  // Layout button handlers
  document.querySelectorAll('.layout-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const cols = parseInt(btn.dataset.cols);
      saveLayout(cols);
      updateLayoutButtons();
      renderQuicklinks();
    });
  });

  // Initialize layout buttons on modal open
  const prefsModal = document.getElementById('prefsModal');
  const observer = new MutationObserver(() => {
    if (prefsModal.classList.contains('active')) {
      updateLayoutButtons();
    }
  });
  observer.observe(prefsModal, { attributes: true, attributeFilter: ['class'] });

  // Render quicklinks list in preferences
  window.renderQuicklinksList = function() {
    const list = document.getElementById('quicklinksList');
    if (!list) return;
    list.innerHTML = '';

    if (quicklinks.length === 0) {
      list.innerHTML = '<div class="small" style="color:var(--muted);padding:10px;">No quicklinks yet. Click "Add" to create one.</div>';
      return;
    }

    quicklinks.forEach((link, index) => {
      const item = document.createElement('div');
      item.className = 'module-item';
      item.innerHTML = `
        <div class="module-icon"><i class="fas ${link.icon || 'fa-link'}"></i></div>
        <div class="module-info">
          <div class="module-name">${link.title}</div>
          <div class="module-desc">${link.url}</div>
        </div>
        <div class="module-controls">
          <button class="btn-small edit-ql-btn" data-index="${index}"><i class="fas fa-edit"></i></button>
          <button class="btn-small delete-ql-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
        </div>
      `;
      list.appendChild(item);

      // Edit button
      item.querySelector('.edit-ql-btn').addEventListener('click', () => {
        editQuicklink(index);
      });

      // Delete button
      item.querySelector('.delete-ql-btn').addEventListener('click', () => {
        if (confirm('Delete quicklink "' + link.title + '"?')) {
          quicklinks.splice(index, 1);
          saveQuicklinks();
          renderQuicklinksList();
          renderQuicklinks();
        }
      });
    });
  };

  // Form elements
  const form = document.getElementById('quicklinkForm');
  const titleInput = document.getElementById('ql-title');
  const urlInput = document.getElementById('ql-url');
  const iconSelect = document.getElementById('ql-icon');
  const clearIconBtn = document.getElementById('ql-clear-icon');
  const cancelBtn = document.getElementById('ql-cancel');
  const saveBtn = document.getElementById('ql-save');
  const addBtn = document.getElementById('addQuicklinkBtn');

  let editingIndex = -1;

  function showForm() {
    form.style.display = 'block';
  }

  function hideForm() {
    form.style.display = 'none';
    titleInput.value = '';
    urlInput.value = '';
    iconSelect.value = '';
    editingIndex = -1;
  }

  function editQuicklink(index) {
    editingIndex = index;
    const link = quicklinks[index];
    titleInput.value = link.title;
    urlInput.value = link.url;
    iconSelect.value = link.icon || '';
    showForm();
  }

  addBtn.addEventListener('click', () => {
    editingIndex = -1;
    titleInput.value = '';
    urlInput.value = '';
    iconSelect.value = '';
    showForm();
  });

  clearIconBtn.addEventListener('click', () => {
    iconSelect.value = '';
  });

  cancelBtn.addEventListener('click', hideForm);

  saveBtn.addEventListener('click', () => {
    const title = titleInput.value.trim();
    const url = urlInput.value.trim();
    const icon = iconSelect.value;

    if (!title) {
      alert('Please enter a title');
      return;
    }
    if (!url) {
      alert('Please enter a URL');
      return;
    }

    // Validate URL
    try {
      new URL(url);
    } catch (e) {
      alert('Please enter a valid URL (include http:// or https://)');
      return;
    }

    if (editingIndex >= 0) {
      quicklinks[editingIndex] = {
        id: quicklinks[editingIndex].id,
        title: title,
        url: url,
        icon: icon || ''
      };
    } else {
      quicklinks.push({
        id: 'ql-' + Date.now(),
        title: title,
        url: url,
        icon: icon || ''
      });
    }

    saveQuicklinks();
    renderQuicklinksList();
    renderQuicklinks();
    hideForm();
  });

  // Initial render
  renderQuicklinks();
})();

// Set up intervals - each module refreshes independently
setInterval(refresh, 30000); // General refresh every 30s (server info only)
setInterval(refreshCPU, timers.cpu.interval);
setInterval(refreshRAM, timers.ram.interval);
setInterval(refreshDisk, timers.disk.interval);
setInterval(refreshGitHub, timers.github.interval);
setInterval(refreshWeather, timers.weather.interval);
setInterval(refreshIP, timers.ip.interval);

// Drag and drop module ordering
(function() {
  const grid = document.getElementById('moduleGrid');
  if (!grid) return;

  let draggedElement = null;

  // Load saved order from localStorage
  function loadModuleOrder() {
    const savedOrder = localStorage.getItem('moduleOrder');
    if (!savedOrder) return;

    try {
      const order = JSON.parse(savedOrder);
      const cards = Array.from(grid.querySelectorAll('.card[data-module]'));

      // Create a map of modules by their data-module attribute
      const moduleMap = new Map();
      cards.forEach(card => {
        const moduleId = card.getAttribute('data-module');
        if (moduleId) {
          moduleMap.set(moduleId, card);
        }
      });

      // Reorder based on saved order
      order.forEach(moduleId => {
        const card = moduleMap.get(moduleId);
        if (card) {
          grid.appendChild(card);
        }
      });
    } catch (e) {
      console.error('Failed to load module order:', e);
    }
  }

  // Save current order to localStorage
  function saveModuleOrder() {
    const cards = Array.from(grid.querySelectorAll('.card[data-module]'));
    const order = cards.map(card => card.getAttribute('data-module')).filter(Boolean);
    localStorage.setItem('moduleOrder', JSON.stringify(order));
  }

  // Initialize drag and drop
  function initDragAndDrop() {
    const cards = grid.querySelectorAll('.card[data-module]');

    cards.forEach(card => {
      card.addEventListener('dragstart', function(e) {
        // Don't start drag if clicking on timer circle, links, or buttons
        const target = e.target;
        if (target.classList.contains('timer-circle') ||
            target.closest('.timer-circle') ||
            target.tagName === 'A' ||
            target.closest('a') ||
            target.tagName === 'BUTTON' ||
            target.closest('button')) {
          e.preventDefault();
          return false;
        }

        draggedElement = this;
        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
      });

      card.addEventListener('dragend', function(e) {
        this.style.opacity = '1';
        // Remove drag-over styling from all cards
        cards.forEach(c => {
          c.classList.remove('drag-over');
        });
        draggedElement = null;
      });

      card.addEventListener('dragover', function(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';

        if (draggedElement && this !== draggedElement) {
          this.classList.add('drag-over');
        }
        return false;
      });

      card.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
      });

      card.addEventListener('drop', function(e) {
        if (e.stopPropagation) {
          e.stopPropagation();
        }

        if (draggedElement && this !== draggedElement) {
          // Get the position of the current element
          const allCards = Array.from(grid.querySelectorAll('.card[data-module]'));
          const currentIndex = allCards.indexOf(this);
          const draggedIndex = allCards.indexOf(draggedElement);

          if (draggedIndex < currentIndex) {
            // Insert after current element
            grid.insertBefore(draggedElement, this.nextSibling);
          } else {
            // Insert before current element
            grid.insertBefore(draggedElement, this);
          }

          saveModuleOrder();
        }

        this.classList.remove('drag-over');
        return false;
      });
    });

    // Prevent drag when clicking on timer circles
    const timerCircles = grid.querySelectorAll('.timer-circle');
    timerCircles.forEach(timer => {
      timer.addEventListener('mousedown', function(e) {
        e.stopPropagation();
      });
      timer.addEventListener('dragstart', function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      });
    });
  }

  // Load saved order on page load
  window.addEventListener('DOMContentLoaded', function() {
    loadModuleOrder();
    // Delay init to ensure all other handlers are set up first
    setTimeout(initDragAndDrop, 100);
  });
})();
</script>
<style>
.card[data-module] {
  user-select: none;
}
.card h3 .header-icons {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 8px;
}
.card[data-module] .drag-handle {
  opacity: 0.3;
  cursor: grab;
  font-size: 12px;
  transition: opacity 0.2s ease;
  pointer-events: auto;
}
.card[data-module]:hover .drag-handle {
  opacity: 0.6;
}
.card[data-module] .drag-handle:active {
  cursor: grabbing;
  opacity: 0.8;
}
.card.drag-over {
  border-color: var(--accent) !important;
  box-shadow: 0 0 0 2px var(--accent) !important;
  transform: scale(1.02);
}
.card[data-module] .timer-circle {
  pointer-events: auto;
  flex-shrink: 0;
}
.card h3 .header-icons a {
  opacity: 0.7;
  transition: opacity 0.2s;
  display: flex;
  align-items: center;
}
.card h3 .header-icons a:hover {
  opacity: 1;
}
.ptr {
  color: var(--muted);
  font-size: 11px;
  margin-top: 2px;
  font-family: inherit;
}
.card[data-module="cpu"],
.card[data-module="ram"],
.card[data-module="disk"] {
  display: flex;
  flex-direction: column;
}
.cpu-graph,
.usage-graph {
  display: flex;
  align-items: flex-end;
  gap: 2px;
  height: 32px;
  width: 100%;
  margin-top: auto;
  background: rgba(0,0,0,0.1);
  border-radius: 4px;
  overflow: hidden;
  padding: 3px;
}
.cpu-graph .bar,
.usage-graph .bar {
  flex: 1;
  min-width: 0;
  background: var(--accent);
  border-radius: 2px;
  transition: height 0.3s ease;
  opacity: 0.8;
}
.cpu-graph .bar:last-child,
.usage-graph .bar:last-child {
  opacity: 1;
}
/* Full bars mode - show unused portion in dim color */
.full-bars .bar {
  --fill-pct: 0%;
  background: linear-gradient(
    to top,
    var(--accent) 0%,
    var(--accent) var(--fill-pct),
    rgba(255,255,255,0.08) var(--fill-pct),
    rgba(255,255,255,0.08) 100%
  );
}
.full-bars .bar:last-child {
  background: linear-gradient(
    to top,
    var(--accent) 0%,
    var(--accent) var(--fill-pct),
    rgba(255,255,255,0.12) var(--fill-pct),
    rgba(255,255,255,0.12) 100%
  );
}

/* Preferences Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  padding: 20px;
}
.modal-overlay.active {
  display: flex;
}
.modal {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  width: 100%;
  max-width: 600px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}
.modal-header h2 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: var(--txt);
  display: flex;
  align-items: center;
  gap: 10px;
}
.modal-close {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 16px;
  padding: 5px;
  transition: color 0.2s;
}
.modal-close:hover {
  color: var(--txt);
}
.modal-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
}
.modal-tab {
  background: none;
  border: none;
  color: var(--muted);
  padding: 12px 16px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  border-bottom: 2px solid transparent;
  margin-bottom: -1px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}
.modal-tab:hover {
  color: var(--txt);
}
.modal-tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}
.modal-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
.pref-section {
  margin-bottom: 24px;
}
.pref-section:last-child {
  margin-bottom: 0;
}
.pref-section h3 {
  margin: 0 0 12px 0;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.pref-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}
.pref-row:last-child {
  border-bottom: none;
}
.pref-row label {
  color: var(--txt);
  font-size: 13px;
  font-weight: 500;
}
.pref-row select,
.pref-row input[type="number"] {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--txt);
  padding: 6px 10px;
  font-size: 13px;
  min-width: 140px;
}
.pref-row select:focus,
.pref-row input[type="number"]:focus {
  outline: none;
  border-color: var(--accent);
}
.btn-small {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--txt);
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}
.btn-small:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.location-input {
  display: flex;
  gap: 6px;
  align-items: center;
}
.location-input input[type="text"],
.location-input select {
  flex: 1;
  min-width: 150px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--txt);
  padding: 6px 10px;
  font-size: 13px;
}
.location-input input[type="text"]:focus,
.location-input select:focus {
  outline: none;
  border-color: var(--accent);
}
.location-display {
  color: var(--muted);
  font-size: 13px;
}
.icon-selector {
  display: flex;
  gap: 6px;
  align-items: center;
}
.icon-selector select {
  flex: 1;
  min-width: 150px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--txt);
  padding: 6px 10px;
  font-size: 13px;
}
.icon-selector select:focus {
  outline: none;
  border-color: var(--accent);
}

/* Layout buttons */
.layout-buttons {
  display: flex;
  gap: 8px;
}
.layout-btn {
  width: 36px;
  height: 36px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--muted);
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.2s;
}
.layout-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.layout-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: var(--bg);
}

/* Quicklinks grid layouts */
.quicklinks-grid {
  display: grid;
  gap: 8px;
}
.quicklinks-grid.cols-1 {
  grid-template-columns: 1fr;
}
.quicklinks-grid.cols-2 {
  grid-template-columns: repeat(2, 1fr);
}
.quicklinks-grid.cols-3 {
  grid-template-columns: repeat(3, 1fr);
}
.quicklinks-grid .ql-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  background: var(--panel2);
  border-radius: 6px;
  border: 1px solid var(--border);
  transition: border-color 0.2s;
}
.quicklinks-grid .ql-item:hover {
  border-color: var(--accent);
}
.quicklinks-grid .ql-item a {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--txt);
  text-decoration: none;
  font-size: 13px;
  flex: 1;
  min-width: 0;
}
.quicklinks-grid .ql-item a:hover {
  color: var(--accent);
}
.quicklinks-grid .ql-item .ql-icon {
  color: var(--accent);
  font-size: 14px;
  flex-shrink: 0;
}
.quicklinks-grid .ql-item .ql-title {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Module List */
.module-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.module-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  transition: border-color 0.2s;
}
.module-item:hover {
  border-color: var(--accent);
}
.module-item .module-icon {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(var(--accent-rgb, 136,192,208), 0.1);
  border-radius: 6px;
  color: var(--accent);
  font-size: 14px;
}
.module-item .module-info {
  flex: 1;
  min-width: 0;
}
.module-item .module-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--txt);
}
.module-item .module-desc {
  font-size: 11px;
  color: var(--muted);
  margin-top: 2px;
}
.module-item .module-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}
.module-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--accent);
  cursor: pointer;
}
.module-item .refresh-control {
  display: flex;
  align-items: center;
  gap: 4px;
}
.module-item .refresh-control input[type="number"] {
  width: 60px;
  padding: 4px 6px;
  font-size: 12px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--txt);
  text-align: center;
}
.module-item .refresh-control input[type="number"]:focus {
  outline: none;
  border-color: var(--accent);
}
.module-item .refresh-control span {
  font-size: 11px;
  color: var(--muted);
}
.module-item .reset-btn {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 4px;
  font-size: 12px;
  transition: color 0.2s;
}
.module-item .reset-btn:hover {
  color: var(--accent);
}
.module-item.disabled {
  opacity: 0.5;
}
.module-item.disabled .module-controls .refresh-control {
  pointer-events: none;
}

/* About Tab */
.about-section {
  text-align: center;
  padding: 20px;
}
.about-logo {
  color: var(--accent);
  margin-bottom: 16px;
}
.about-section h3 {
  font-size: 18px;
  color: var(--txt);
  margin-bottom: 4px;
  text-transform: none;
  letter-spacing: 0;
}
.about-version {
  color: var(--muted);
  font-size: 12px;
  margin-bottom: 16px;
}
.about-desc {
  color: var(--txt);
  font-size: 13px;
  line-height: 1.6;
  margin-bottom: 20px;
}
.about-links {
  margin-bottom: 20px;
}
.about-links a {
  color: var(--accent);
  text-decoration: none;
  font-size: 13px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.about-links a:hover {
  text-decoration: underline;
}
.about-copyright {
  color: var(--muted);
  font-size: 11px;
}
</style>
</body>
</html>
